# WeCom SaaS Core Scaffold

è¿™æ˜¯ä¸€ä¸ªå‰¥ç¦»äº†ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚åç‰‡åŠŸèƒ½ï¼‰çš„ä¼ä¸šå¾®ä¿¡ç¬¬ä¸‰æ–¹åº”ç”¨**æ ¸å¿ƒéª¨æ¶**ã€‚å®ƒåŒ…å«äº†å¼€å‘ä¸€ä¸ª SaaS åº”ç”¨æ‰€éœ€çš„åŸºç¡€è®¾æ–½ã€‚

## ğŸ“‚ ç›®å½•ç»“æ„

```text
wecom-saas-scaffold/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ wecom.py          # [æ ¸å¿ƒ] ä¼å¾®APIäº¤äº’ã€å›è°ƒã€OAuthã€å®‰è£…é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ provider_auth.py  # [ç®¡ç†] æœåŠ¡å•†ç®¡ç†å‘˜ç™»å½•è®¤è¯
â”‚   â”‚   â””â”€â”€ admin.py          # [ç®¡ç†] ç§Ÿæˆ·åˆ—è¡¨ä¸ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ models.py             # [æ•°æ®] ä»…ä¿ç•™Tenant(ç§Ÿæˆ·)å’ŒMember(æˆå‘˜)è¡¨
â”‚   â”œâ”€â”€ main.py               # [å…¥å£] Flaskåº”ç”¨å·¥å‚ï¼Œæ³¨å†Œæ ¸å¿ƒè“å›¾
â”‚   â””â”€â”€ config.py             # [é…ç½®] ç¯å¢ƒå˜é‡è¯»å–
â”œâ”€â”€ wsgi.py                   # Gunicornå¯åŠ¨å…¥å£
â””â”€â”€ requirements.txt          # ä¾èµ–åˆ—è¡¨
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### 1. å¤šç§Ÿæˆ·å®‰è£…æœºåˆ¶ (`app/routes/wecom.py`)
- **åº”ç”¨å®‰è£…**: å¤„ç† `/install` ç”Ÿæˆæˆæƒé“¾æ¥ï¼Œæ¥æ”¶ `create_auth` å›è°ƒã€‚
- **ç§Ÿæˆ·ç®¡ç†**: è‡ªåŠ¨åœ¨ `Tenant` è¡¨ä¸­åˆ›å»ºè®°å½•ï¼Œå­˜å‚¨ `permanent_code`ã€‚
- **æˆæƒç»´æŠ¤**: è‡ªåŠ¨ç¼“å­˜ `suite_ticket`ï¼Œä¿æŒæœåŠ¡å•† Token æœ‰æ•ˆã€‚

### 2. ç»Ÿä¸€èº«ä»½è®¤è¯ (`app/routes/wecom.py`)
- **OAuth ç™»å½•**: `/auth/verify_user` æ¥å£å°è£…äº† `getuserinfo3rd`ã€‚
- **è‡ªåŠ¨è¯†åˆ«**: ç”¨æˆ·æ— éœ€è¾“å…¥è´¦å·å¯†ç ï¼Œç³»ç»Ÿè‡ªåŠ¨æ ¹æ® Code è¯†åˆ«æ‰€å±ç§Ÿæˆ· (CorpID)ã€‚
- **æƒé™åˆ†æµ**: å†…ç½® `check_user_permission`ï¼ŒåŒºåˆ†å®‰è£…è€…(Admin)ä¸æ™®é€šç”¨æˆ·ã€‚

### 3. æœåŠ¡å•†åå° (`app/routes/admin.py` + `provider_auth.py`)
- æä¾›äº†ä¸€å¥—ç‹¬ç«‹äºä¼å¾®çš„ç®¡ç†å‘˜åå° APIã€‚
- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å®‰è£…äº†åº”ç”¨çš„ç§Ÿæˆ·åˆ—è¡¨ã€‚

## ğŸ›  å¦‚ä½•åŸºäºæ­¤éª¨æ¶å¼€å‘

1. **é…ç½®ç¯å¢ƒ**: å¤åˆ¶ `.env` æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„ `WECOM_SUITE_ID`, `WECOM_SUITE_SECRET` ç­‰ä¿¡æ¯ã€‚
2. **æ·»åŠ ä¸šåŠ¡æ¨¡å‹**: åœ¨ `app/models.py` ä¸­æ·»åŠ ä½ æ–°åº”ç”¨çš„ä¸šåŠ¡è¡¨ï¼ˆå¦‚ `Project`, `Task` ç­‰ï¼‰ï¼Œå¹¶å…³è” `tenant_id`ã€‚
3. **å¼€å‘ä¸šåŠ¡æ¥å£**: 
   - åˆ›å»ºæ–°çš„ Blueprint (e.g., `app/routes/projects.py`)ã€‚
   - åœ¨æ¥å£ä¸­ä½¿ç”¨ `verify_jwt_token` è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å’Œç§Ÿæˆ·IDã€‚
   ```python
   # ç¤ºä¾‹
   @bp.route('/projects')
   def list_projects():
       token = request.headers.get('Authorization').split()[1]
       payload = verify_jwt_token(token)
       tenant_id = payload['tenant_id']
       # æŸ¥è¯¢è¯¥ç§Ÿæˆ·çš„æ•°æ®...
   ```
4. **å‰ç«¯å¯¹æ¥**:
   - ç™»å½•é¡µè°ƒç”¨ `/api/v1/wecom/auth/verify_user?code=...`ã€‚
   - è·å–åˆ°çš„ JWT Token æ”¾å…¥ Header ç”¨äºåç»­è¯·æ±‚ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

- **æ•°æ®è¿ç§»**: è¿™æ˜¯ä¸€ä¸ªæ–°çš„ä»£ç åº“ï¼Œè¯·åˆå§‹åŒ–æ–°çš„è¿ç§» (`flask db init`).
- **æ¸…ç†ä¾èµ–**: `requirements.txt` ä¸­ä¿ç•™äº† Redis/Celeryï¼Œå¦‚ä¸éœ€è¦å¯åˆ é™¤ã€‚


# WeCard 文件上传与图标系统说明

> **版本**: v3.0  
> **更新时间**: 2025-11-04  
> **状态**: ✅ 已完成整合优化

---

## 📋 系统概述

WeCard 提供两套完整的资源管理系统：
1. **文件上传系统**：用于图片、视频、文档等大文件
2. **图标系统**：用于装饰性图标（SVG、Emoji、CSS、Lottie）

---

# 第一部分：图标系统 🎨

## 📊 图标资源统计

| 类型 | 数量 | 存储位置 | 状态 |
|------|------|----------|------|
| **Emoji表情** | 131 | 内置代码 | ✅ 可用 |
| **CSS图标** | 21 | `/assets/css/icon-font.css` | ✅ 可用 |
| **SVG图标** | 131 | `/static/icons/` | ✅ 可用 |
| **Lottie动画** | 10+ | `/assets/animations/` | ✅ 可用 |
| **总计** | **300+** | - | ✅ 可用 |

### SVG图标分类（10大类，131个）

| 分类 | 数量 | 说明 |
|------|------|------|
| 📞 通用（General） | 15个 | 电话、邮箱、位置、传真等基础图标 |
| 💼 业务（Business） | 18个 | 办公、会议、报告等商务图标 |
| 💻 技术（Technology） | 16个 | 代码、数据库、云服务等技术图标 |
| 📱 社交（Social） | 20个 | 微信、Facebook、Twitter等社交平台 |
| 🛒 电商（E-commerce） | 12个 | 购物车、支付、订单等电商图标 |
| ➡️ 箭头（Arrows） | 10个 | 各种方向的箭头图标 |
| 🎨 界面（Interface） | 15个 | 菜单、设置、搜索等界面元素 |
| 🎬 媒体（Media） | 12个 | 视频、音乐、图片等媒体图标 |
| 💬 通信（Communication） | 8个 | 消息、通知、对话等通信图标 |
| 📄 文件（Files） | 5个 | 文档、PDF、表格等文件图标 |

---

## 🎯 核心架构

### 1. IconPicker 组件（增强版）

**位置**: `/opt/qwcard/components/workspace/form/IconPicker.vue`

**核心功能**:
- ✅ 4种图标类型切换（Emoji、CSS、SVG、Lottie）
- ✅ SVG图标分类筛选（10个分类）
- ✅ 搜索功能（支持名称搜索）
- ✅ 透明图标预览优化（棋盘格背景 + 阴影轮廓）
- ✅ 居中弹窗显示
- ✅ 响应式布局（移动端适配）
- ✅ 实时预览
- ✅ 类型自动同步（iconType）

**使用示例**:
```vue
<IconPicker
  v-model="localData.items[index].icon"
  :type.sync="localData.items[index].iconType"
  label="选择图标"
  placeholder="点击选择图标"
  @change="handleIconChange(index)"
/>
```

### 2. 已集成的名片模块

| 模块 | 位置 | 图标用途 | 状态 |
|------|------|----------|------|
| **企业介绍** | CompanyIntroConfig | 核心数据亮点图标 | ✅ 增强版 |
| **时间线** | TimelineConfig | 事件标记图标 | ✅ 增强版（2025-11-04） |
| **通用网格** | StandardGridConfig | 网格项图标 | ✅ 增强版 |
| **联系方式** | ContactInfoConfig | 联系图标 | ✅ 基础版 |
| **社交链接** | SocialLinksConfig | 社交图标 | ✅ 基础版 |
| **产品服务** | ProductServiceConfig | 服务图标 | ✅ 基础版 |

**TimelineConfig 更新（2025-11-04）**:
- ❌ 删除：自定义 40 个 emoji 选择器
- ❌ 删除：showIconPicker/editingEventIndex 数据
- ❌ 删除：openIconPicker/closeIconPicker/selectIcon 方法
- ✅ 新增：IconPicker 组件集成
- ✅ 新增：handleEventIconChange 方法
- ✅ 支持：Emoji/SVG/CSS/Lottie 全部类型

### 3. 图标存储（单一源）

**整合完成** (2025-11-04):
- ✅ 删除重复：从 3 个文件夹整合到 1 个
- ✅ 统一路径：`/static/icons/` → 访问 `/icons/*.svg`
- ✅ 释放空间：338KB
- ✅ 文件完整：131 个 SVG 文件

**配置文件**: `/opt/qwcard/config/icon-library.js`

```javascript
// SVG 图标配置结构
export const SVG_ICONS = [
  { 
    name: '微信', 
    file: 'wechat.svg', 
    category: 'social',
    keywords: ['wechat', 'weixin', '社交']
  },
  // ... 更多图标
]

// SVG 分类配置
export const SVG_CATEGORIES = {
  all: '全部',
  general: '通用',
  business: '业务',
  technology: '技术',
  social: '社交',
  ecommerce: '电商',
  arrows: '箭头',
  interface: '界面',
  media: '媒体',
  communication: '通信',
  files: '文件'
}
```

---

## ⚠️ 图标 vs 图片 重要说明

### 图标（Icons）

**用途**: 装饰性元素  
**格式**: SVG、Emoji、CSS、Lottie  
**场景**: 
- ✅ 社交平台标识
- ✅ 联系方式图标
- ✅ 数据亮点装饰
- ✅ 时间线事件标记
- ✅ 功能按钮图标

**特点**:
- 矢量格式，无限缩放
- 文件极小（< 10KB）
- 单色或简单色彩
- 不包含复杂信息

### 图片（Images）

**用途**: 信息性内容  
**格式**: PNG、JPG  
**场景**:
- ✅ 企业 Logo
- ✅ 产品图片
- ✅ 团队照片
- ✅ 办公环境
- ✅ 素材库封面
- ✅ 证书图片

**特点**:
- 位图格式，固定尺寸
- 文件较大（通常 100KB - 2MB）
- 全彩色，包含真实内容
- 承载实际信息

### 禁止混用场景

| 场景 | 正确 | 错误 |
|------|------|------|
| 企业 Logo | ✅ 上传真实 Logo 图片 | ❌ 使用图标代替 |
| 素材库封面 | ✅ 上传产品/服务图片 | ❌ 使用图标代替 |
| 产品展示 | ✅ 上传实际产品照片 | ❌ 使用图标代替 |
| 社交平台 | ✅ 使用对应图标 | ❌ 上传平台 Logo 图片 |
| 数据亮点 | ✅ 使用装饰图标 | ❌ 上传图片 |

---

## 🚀 快速添加新图标

### 添加 SVG 图标

1. **准备 SVG 文件**（建议 24x24 或 32x32）
2. **放入目录**：`/opt/qwcard/static/icons/`
3. **更新配置**：`/opt/qwcard/config/icon-library.js`
   ```javascript
   {
     name: '新图标',
     file: 'new-icon.svg',
     category: 'general',
     keywords: ['新', 'new']
   }
   ```
4. **刷新页面**即可使用

### 添加 Lottie 动画

**方法1: 使用脚本**
```bash
/opt/qwcard/scripts/add-lottie-animation.sh <文件> <名称> <类别>
```

**方法2: 手动添加**
1. 复制 JSON 文件到 `/opt/qwcard/assets/animations/<类别>/`
2. 在 `icon-library.js` 中添加配置
3. 重启服务

**免费资源**:
- LottieFiles: https://lottiefiles.com/
- Iconscout: https://iconscout.com/lottie-animations
- Lordicon: https://lordicon.com/

---

# 第二部分：文件上传系统 📤

## 🎯 设计原则

1. **统一接口**：所有模块使用相同的上传 API
2. **统一组件**：前端使用统一的 `ImageUpload` 组件
3. **MD5 去重**：自动检测重复文件，避免存储浪费
4. **租户隔离**：每个租户的文件独立存储
5. **安全防护**：五层安全机制保护系统稳定

---

## 🏗️ 架构设计

### 前端层

```
ImageUpload.vue（通用上传组件）
    ↓
FormData + JWT Token
    ↓
POST /api/v1/files/upload
```

### 后端层

```
/api/v1/files/upload（Flask 路由）
    ↓
验证 JWT + 文件类型 + 文件大小
    ↓
计算 MD5 去重
    ↓
保存到本地 /uploads/{tenant_id}/
    ↓
记录到 file_assets 表
    ↓
返回文件 URL
```

---

## 📁 文件存储结构

### 当前（本地存储）

```
/opt/qwcard/uploads/
├── 1/                          # 租户ID
│   ├── 1_20250102_120000_abc123_logo.png
│   ├── 1_20250102_120100_def456_banner.jpg
│   └── ...
├── 2/                          # 另一个租户
│   └── ...
└── ...
```

**文件命名规则**：
```
{tenant_id}_{timestamp}_{md5_8位}_{原始文件名}

示例：
1_20250102_120000_abc12345_company_logo.png
```

### 未来（云存储）

```
MinIO/OSS Bucket: wecard-files
├── tenant-1/
│   ├── images/
│   │   ├── abc123_logo.png
│   │   └── def456_banner.jpg
│   ├── videos/
│   └── documents/
├── tenant-2/
└── ...
```

---

## 🔒 安全防护系统

### 五层防护机制

#### 1️⃣ 数量限制

| 模块 | 最大数量 | 配置方式 |
|------|----------|----------|
| Logo墙 | 20个 | `MAX_LOGOS = 20` |
| 通用网格 | 20个 | `MAX_IMAGES = 20` |
| 信任背书 | 20个 | `MAX_IMAGES = 20` |
| 企业介绍 | 1个 | 单图上传 |

**租户级别配置**（支持不同套餐）:
```javascript
// /opt/qwcard/components/workspace/config/upload-limits.js
export const DEFAULT_LIMITS = {
  MAX_IMAGES: 20,
  MAX_BATCH_UPLOAD: 10,
  UPLOAD_COOLDOWN: 2000,
  MAX_FILE_SIZE: 500 * 1024,
  ALLOWED_MIME_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
  ALLOWED_EXTENSIONS: ['.jpg', '.jpeg', '.png', '.gif', '.webp']
}

// 租户自定义
setTenantLimits(tenantId, {
  MAX_IMAGES: 50  // 高级套餐允许50张
})
```

#### 2️⃣ 文件大小限制

- **单文件**: 500KB（可配置）
- **前端验证**: `ImageUpload.vue`
- **后端验证**: Flask API

```javascript
// 前端检查
if (file.size > this.MAX_FILE_SIZE) {
  alert(`文件过大，最大${this.MAX_FILE_SIZE / 1024}KB`)
  return
}
```

#### 3️⃣ 文件类型验证

**双重验证**:
1. MIME Type 检查
2. 文件扩展名检查

```javascript
const ALLOWED_MIME_TYPES = [
  'image/jpeg',
  'image/png',
  'image/gif',
  'image/webp'
]

const ALLOWED_EXTENSIONS = [
  '.jpg', '.jpeg', '.png', '.gif', '.webp'
]
```

#### 4️⃣ 上传频率限制

- **冷却时间**: 2秒（可配置）
- **防止**: 恶意频繁上传
- **实现**: 前端时间戳记录

```javascript
checkUploadFrequency() {
  const now = Date.now()
  const timeSinceLastUpload = now - this.lastUploadTime
  
  if (timeSinceLastUpload < this.UPLOAD_COOLDOWN) {
    return {
      allowed: false,
      remaining: Math.ceil((this.UPLOAD_COOLDOWN - timeSinceLastUpload) / 1000)
    }
  }
  
  return { allowed: true }
}
```

#### 5️⃣ 批量上传限制

- **单次最多**: 10个文件（Logo墙）
- **防止**: 批量攻击
- **提示**: 超出时友好提醒

```javascript
if (files.length > MAX_BATCH_UPLOAD) {
  alert(`一次最多上传${MAX_BATCH_UPLOAD}个文件，当前选择了${files.length}个`)
  return
}
```

---

## 🔧 使用方法

### 1️⃣ 基础用法

```vue
<template>
  <ImageUpload
    v-model="localData.imageUrl"
    label="上传图片"
    hint="建议尺寸：1200x600px，支持JPG、PNG，最大500KB"
    :required="true"
    @change="handleChange"
  />
</template>

<script>
import ImageUpload from '../form/ImageUpload.vue'

export default {
  components: { ImageUpload },
  
  data() {
    return {
      localData: {
        imageUrl: ''
      }
    }
  },
  
  methods: {
    handleChange() {
      // 图片上传完成，localData.imageUrl 已更新
      this.emitChange()
    }
  }
}
</script>
```

### 2️⃣ 带安全策略的多图上传

```vue
<template>
  <div>
    <!-- 配额提示 -->
    <div class="quota-hint" :class="{ 
      'quota-warning': remainingImageSlots <= 5,
      'quota-full': remainingImageSlots === 0 
    }">
      <i class="icon-info"></i>
      <span>已添加 {{ getImageCount() }}/{{ MAX_IMAGES }} 个项目</span>
      <span v-if="remainingImageSlots > 0" class="remaining">
        （还可添加{{ remainingImageSlots }}个）
      </span>
      <span v-else class="full-text">（已达上限）</span>
    </div>
    
    <!-- 图片列表 -->
    <div v-for="(item, index) in localData.items" :key="item.id">
      <ImageUpload
        v-model="localData.items[index].image"
        label="项目图片"
        @change="emitChange"
      />
    </div>
  </div>
</template>

<script>
import ImageUpload from '../form/ImageUpload.vue'
import uploadSecurityMixin from './upload-security-mixin'

export default {
  mixins: [uploadSecurityMixin],
  
  components: { ImageUpload },
  
  methods: {
    // 实现 mixin 要求的方法
    getImageCount() {
      return (this.localData.items || []).length
    },
    
    addItem() {
      // 安全检查
      if (!this.canAddMoreImages) {
        alert(`最多只能添加${this.MAX_IMAGES}个项目`)
        return
      }
      
      const frequencyCheck = this.checkUploadFrequency()
      if (!frequencyCheck.allowed) {
        alert(`操作过于频繁，请${frequencyCheck.remaining}秒后再试`)
        return
      }
      
      // 添加新项目
      this.localData.items.push({ id: Date.now(), image: '' })
      this.updateUploadTimestamp()
    }
  }
}
</script>
```

---

## 📦 已应用安全策略的模块

| 模块 | Mixin | 数量限制 | 批量上传 | 频率限制 | 文件验证 |
|------|-------|----------|----------|----------|----------|
| **TrustCredentialsConfig** | ✅ | 20个 | - | ✅ | ✅ |
| **StandardGridConfig** | ✅ | 20个 | - | ✅ | ✅ |
| **LogoWallConfig** | 自定义 | 20个 | 10个/次 | ✅ | ✅ |
| **CompanyIntroConfig** | 单图 | 1个 | - | - | ✅ |

---

## 🎨 UI 组件说明

### ImageUpload 组件特性

**基础功能**:
- ✅ 拖拽上传
- ✅ 点击上传
- ✅ 图片预览
- ✅ 进度显示
- ✅ 错误提示

**高级功能**:
- ✅ 图片压缩（Compressor.js）
- ✅ 格式转换
- ✅ 尺寸验证
- ✅ MD5 计算
- ✅ 自动重试

**Props**:
```javascript
{
  value: String,          // v-model 绑定的 URL
  label: String,          // 标签文字
  hint: String,           // 提示信息
  required: Boolean,      // 是否必填
  maxSize: Number,        // 最大文件大小（字节）
  accept: String          // 接受的文件类型
}
```

---

## 🔄 数据流程

### 上传流程

```
1. 用户选择文件
   ↓
2. 前端验证（大小、类型）
   ↓
3. 图片压缩（如果需要）
   ↓
4. 计算 MD5
   ↓
5. 构建 FormData
   ↓
6. 发送到后端 API
   ↓
7. 后端再次验证
   ↓
8. 检查 MD5 是否已存在
   ↓
9. 保存文件 / 返回已有文件
   ↓
10. 返回文件 URL
   ↓
11. 前端更新 v-model
```

### 删除流程

```
1. 用户点击删除
   ↓
2. 前端确认对话框
   ↓
3. 调用删除 API（可选）
   ↓
4. 更新 v-model 为空
   ↓
5. 更新数据库引用
   ↓
6. 后台清理未引用文件（定时任务）
```

---

## 🛠️ 维护与优化

### 定期清理

**未引用文件清理**:
```bash
# 定时任务（每周执行）
0 2 * * 0 /opt/qwcard/scripts/cleanup_unused_files.py
```

**清理逻辑**:
1. 查询所有数据库记录中的文件引用
2. 扫描 `/uploads/` 目录
3. 找出未被引用的文件
4. 删除超过 30 天的未引用文件

### 性能监控

**关键指标**:
- 上传成功率
- 平均上传时间
- 存储空间使用
- MD5 去重命中率

**监控脚本**:
```bash
/opt/qwcard/scripts/monitor_uploads.py --report daily
```

---

## 📈 迁移到云存储

### 准备工作

1. **选择服务**：MinIO、阿里云 OSS、AWS S3
2. **配置 SDK**：安装相应的 Python SDK
3. **创建 Bucket**：配置权限和策略
4. **测试连接**：验证上传下载功能

### 迁移步骤

```python
# 1. 添加云存储配置
STORAGE_TYPE = 'minio'  # 或 'oss', 's3'
MINIO_ENDPOINT = 'minio.example.com:9000'
MINIO_ACCESS_KEY = 'your_access_key'
MINIO_SECRET_KEY = 'your_secret_key'
MINIO_BUCKET = 'wecard-files'

# 2. 修改上传函数
def upload_file(file, tenant_id):
    if STORAGE_TYPE == 'local':
        return upload_to_local(file, tenant_id)
    elif STORAGE_TYPE == 'minio':
        return upload_to_minio(file, tenant_id)
    elif STORAGE_TYPE == 'oss':
        return upload_to_oss(file, tenant_id)

# 3. 迁移现有文件
python /opt/qwcard/scripts/migrate_to_cloud.py --from local --to minio
```

---

## 📱 APP唤醒链接获取指南

### 概述

网店直达模块支持多种电商平台APP唤醒，需要配置APP唤醒链接（URL Scheme）和H5备用链接。

### 天猫店铺

**获取方法**：
1. **店铺名格式URL**（如 `https://baifenbaijj.tmall.com/`）：
   - 查看网页源代码（Ctrl+U）
   - 搜索 `shopId` 或 `shopid`
   - 提取店铺ID数字
2. **数字ID格式URL**（如 `https://shop12345678.taobao.com/`）：
   - 从URL中直接提取店铺ID

**格式**：`tmall://page.tm/shop?shopId={店铺ID}`

### 京东店铺

**获取方法**：
1. **商品链接**（如 `https://item.jd.com/100169957987.html`）：
   - 点击"进店"按钮进入店铺首页
   - 从店铺首页URL提取 `shopId` 参数
2. **店铺首页链接**（如 `https://shop.m.jd.com/?shopId=123456`）：
   - 从URL参数中提取 `shopId` 值
3. **源代码获取**：查看商品页面源代码，搜索 `shopId` 或 `venderId`

**格式**：`openapp.jdmobile://virtual?params={"category":"jump","des":"jshop","shopId":"{店铺ID}"}`

**注意**：京东唤醒链接包含JSON格式，需确保引号正确。

### 其他平台

| 平台 | 唤醒链接格式 | 店铺ID获取方式 |
|------|------------|--------------|
| **拼多多** | `yangkeduo://com.xunmeng.pinduoduo/duo_course_mall?mall_id={店铺ID}` | URL参数 `mall_id` |
| **1688** | `ali1688://shop?id={店铺ID}` | URL中的数字部分 |
| **淘宝** | `taobao://shop?id={店铺ID}` | URL中的数字部分 |

### 通用获取步骤

1. **打开店铺首页**（不是商品页面）
2. **提取店铺ID**：从URL或源代码中获取
3. **构建唤醒链接**：使用对应平台格式
4. **配置H5备用链接**：店铺首页URL（必填）

### 重要提示

- **H5备用链接必填**：当用户未安装APP时，会打开H5链接
- **测试唤醒链接**：在移动端浏览器中测试，确保能正常唤醒APP
- **店铺ID格式**：确保店铺ID正确，否则无法唤醒APP

---

## 📖 相关文档

- `/opt/qwcard/docs/3、前端界面cc4.5.md` - 前端系统完整文档
- `/opt/qwcard/docs/系统清理优化报告-2核4G.md` - 系统优化说明

---

## 🎉 总结

### 图标系统

WeCard 图标系统提供 **300+ 图标**，覆盖企业名片所有使用场景：
- ✅ 选择丰富：4 种类型（Emoji、SVG、CSS、Lottie）
- ✅ 质量保证：矢量格式，清晰度高
- ✅ 易于使用：统一选择器，增强版 UI
- ✅ 易于扩展：配置简单，维护方便
- ✅ 分类清晰：10 大分类，131 个 SVG 图标

### 文件上传系统

WeCard 文件上传系统提供 **企业级安全保障**：
- ✅ 统一架构：所有模块使用相同逻辑
- ✅ 五层防护：数量、大小、类型、频率、批量全方位保护
- ✅ 租户隔离：数据安全，互不干扰
- ✅ MD5 去重：节省存储空间
- ✅ 易于扩展：预留云存储迁移接口

**最后更新**: 2025-11-04

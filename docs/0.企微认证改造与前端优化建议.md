# 企微 OAuth 整体方案（摘要）
> 更新时间：2025-11-04

## 1. 目标

- 统一企业微信第三方应用 OAuth（`getuserinfo3rd`），自动识别企业与用户。  
- 保证管理员与普通用户在同一入口完成鉴权后被正确分流。  
- 提供最小排障指南，避免长篇源码复制。

## 2. 流程概览

```
企微工作台入口
    ↓ 无 JWT
跳转 /api/v1/wecom/oauth/authorize → 官方授权页
    ↓ code 回调 /api/v1/wecom/auth/verify_user
调用 getuserinfo3rd → 生成 JWT（含 tenant_id / role / is_admin）
    ↓
管理员   → 留在 /wecom/workspace
普通用户 → 重定向 /wecom/card
```

关键判断集中在 `check_user_permission`：优先匹配安装者（installer）、企业超管（super_admin），再验证可见范围（user），否则判定为无权限（none）。

## 3. 重要接口

| 接口 | 作用 | 备注 |
|------|------|------|
| `GET /api/v1/wecom/oauth/authorize` | 生成企微授权 URL，记录 state | 前端调用以触发 OAuth |
| `GET /api/v1/wecom/auth/verify_user` | 用 code 换取 `corpid`、`userid`，签发 JWT | 返回 `token` 与 `user` 信息 |
| `POST /api/v1/wecom/callback` / `command` | 接收 suite_ticket、安装/变更事件 | Redis 缓存 ticket，写入租户授权数据 |

前端通过 `plugins/wecom-auth.js` 管理 JWT 缓存、Axios 拦截与 401 回退。

## 4. 运维排障速览

| 问题 | 排查 | 常见原因 |
|------|------|----------|
| 无法跳转授权页 | 检查 OAuth URL 日志、企微后台域名配置 | `redirect_uri` 未备案、state 未缓存 |
| `verify_user` 返回 401 | Redis 未存 suite_ticket / token 过期 | 联系 suite_ticket 回调或重启服务前先缓存 |
| 获取租户失败 | 查看 create_auth 日志、确认企业已安装 | 授权回调未被访问或 permanent_code 过期 |
| 普通用户误进工作台 | 调试 `check_user_permission` 返回值 | auth_info 未同步或可见范围为空 |

建议：发生异常时先 `redis-cli get wecom:suite_ticket`、`journalctl -u wecard-api.service -f | grep OAuth`。

## 5. 仍需关注

- `check_user_admin_permission` 当前只判断 `isleader=1`，后续可按企业自定义权限增强。  
- OAuth token 有效期 12 小时，若需延长应改为刷新机制或降级到静默授权重取。  
- 回调处理流程依赖 Redis，如切换部署模式需提前准备共享缓存或落盘。

> 补充信息：详细代码位于 `app/routes/wecom.py`、`plugins/wecom-auth.js`；如需排障示例或脚本请查询 Git 仓库历史版本。



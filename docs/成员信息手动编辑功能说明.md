# 成员信息手动编辑功能说明

**版本**: v2.8+  
**创建日期**: 2025-11-14

---

## 📌 功能概述

由于企业微信第三方应用API限制，即使使用OAuth授权也无法完全获取成员的对外显示名称、手机号码、职位等敏感信息。因此，我们添加了**成员信息手动编辑**功能，允许管理员在后台直接编辑和补充成员信息。

---

## 🎯 功能入口

1. 管理员登录后，进入 **管理员配置工作台**（`/wecom/workspace`）
2. 点击顶部导航栏的 **"👥 成员管理"** 标签页
3. 系统自动加载当前租户下的所有成员列表

---

## 📋 成员列表显示

### 显示字段

| 列名 | 说明 | 数据来源 |
|------|------|---------|
| 头像 | 成员头像 | OAuth授权获取（如有） |
| 企微UserID | 企业微信唯一标识 | 企微同步 |
| 对外显示名称 | 成员姓名 | 手动编辑 > OAuth > 企微同步 |
| 手机号码 | 联系电话 | 手动编辑 > OAuth > 企微同步 |
| 职位 | 职位信息 | 手动编辑 > OAuth > 企微同步 |
| 角色 | 管理员/普通员工 | 系统自动识别 |
| OAuth状态 | 已授权/未授权 | OAuth授权记录 |
| 操作 | 编辑按钮 | - |

### 状态标识

- **未设置名称**: 如果姓名等于UserID（一串代码），显示 `未设置` 黄色标签
- **管理员**: 蓝色徽章，标注"管理员"
- **普通员工**: 灰色徽章，标注"普通员工"
- **OAuth已授权**: 绿色徽章，标注"✓ 已授权"
- **OAuth未授权**: 红色徽章，标注"未授权"

---

## ✏️ 编辑成员信息

### 操作步骤

1. **点击编辑按钮**（✏️）
   - 对应成员行的三个字段（姓名、手机、职位）变为可编辑输入框

2. **填写/修改信息**
   - **姓名**：必填，建议填写成员的真实姓名或对外显示名称
   - **手机号码**：可选，填写11位手机号码
   - **职位**：可选，填写成员的职位信息（如"产品经理"、"技术总监"等）

3. **保存或取消**
   - 点击 **✓（绿色对钩）**：保存修改
   - 点击 **✕（红色叉号）**：取消编辑，恢复原值

4. **保存成功**
   - 系统提示"✅ 保存成功！成员信息已更新"
   - 列表自动刷新，显示最新数据
   - 修改后的信息会立即反映在成员的名片页面

---

## 🔄 数据优先级

成员信息显示遵循以下优先级：

```
手动编辑数据 > OAuth授权数据 > 企微同步数据 > UserID
```

**说明**：
- **手动编辑数据**：管理员在后台手动录入的信息，优先级最高
- **OAuth授权数据**：员工授权后从企微API获取的信息
- **企微同步数据**：从企微通讯录同步的基础信息
- **UserID**：如果以上都没有，显示企微UserID作为兜底

---

## 🔒 权限说明

### 访问权限
- **只有管理员**可以访问成员管理页面
- 普通员工无法查看或编辑其他成员信息

### 编辑范围
- 管理员可以编辑**同一租户下**的所有成员信息
- 无法编辑其他租户的成员信息

---

## 🔌 API接口

### 1. 获取成员列表

```http
GET /api/v1/wecom/members
Headers: Authorization: Bearer <token>
```

**响应示例**：
```json
{
  "members": [
    {
      "id": 2,
      "userid": "womKtScgAAEkyZS7yXhQkhLqeCvf7ehQ",
      "name": "张三",
      "mobile": "13800138000",
      "position": "产品经理",
      "avatar_url": "https://wework.qpic.cn/...",
      "is_admin": true,
      "oauth_authorized": true,
      "oauth_authorized_at": "2025-11-14 00:44:48",
      "created_at": "2025-11-10 12:00:00"
    }
  ],
  "total": 3
}
```

### 2. 更新成员信息

```http
PUT /api/v1/wecom/members/<member_id>
Headers: Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "张三",
  "mobile": "13800138000",
  "position": "产品经理"
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "成员信息更新成功",
  "updated_fields": ["name", "mobile", "position"],
  "member": {
    "id": 2,
    "userid": "womKtScgAAEkyZS7yXhQkhLqeCvf7ehQ",
    "name": "张三",
    "mobile": "13800138000",
    "position": "产品经理",
    "avatar_url": "https://wework.qpic.cn/..."
  }
}
```

---

## 🎨 界面设计

### 布局
- **全宽表格**：支持横向滚动，适配不同屏幕尺寸
- **紧凑设计**：单行显示所有关键信息
- **行内编辑**：无需弹窗，直接在列表中编辑

### 交互
- **悬停高亮**：鼠标悬停在行上时，背景变灰
- **输入框焦点**：编辑时，输入框显示蓝色边框
- **按钮反馈**：保存/取消按钮悬停时背景色变化

### 颜色规范
- **主色调**：`#667eea`（渐变紫蓝）
- **成功色**：`#52c41a`（绿色）
- **警告色**：`#d46b08`（橙色）
- **错误色**：`#ff4d4f`（红色）
- **中性色**：`#8c8c8c`（灰色）

---

## 📊 使用场景

### 场景1：新员工入职
1. 员工扫码加入企业微信
2. 系统自动同步成员（姓名=UserID）
3. 管理员进入成员管理页面
4. 手动编辑员工的真实姓名、手机、职位
5. 保存后，员工名片立即显示正确信息

### 场景2：OAuth授权失败
1. 员工尝试OAuth授权获取信息
2. 由于企微API限制，name/mobile/position仍为空
3. 管理员收到反馈
4. 在成员管理页面补充缺失信息
5. 员工刷新名片页面，信息正常显示

### 场景3：批量信息维护
1. 管理员定期检查成员列表
2. 发现有多个成员姓名未设置（显示UserID）
3. 逐个点击编辑，补充真实信息
4. 完成后，所有员工名片信息完整

---

## ⚠️ 注意事项

1. **姓名必填**：保存时姓名不能为空，否则提示错误
2. **手机格式**：虽然不强制校验，但建议填写11位手机号
3. **实时生效**：保存后立即生效，员工刷新名片即可看到
4. **无撤销功能**：保存后无法撤销，请谨慎操作
5. **OAuth优先级**：如果员工后续完成OAuth授权，OAuth数据会覆盖手动数据（需根据业务需求调整优先级）

---

## 🔧 故障排查

### 问题1：成员列表加载失败
**症状**：点击成员管理标签，显示加载失败

**排查步骤**：
```bash
# 1. 检查后端服务
curl http://127.0.0.1:5001/healthz

# 2. 查看错误日志
tail -50 /tmp/gunicorn_error.log

# 3. 检查数据库连接
mysql -u wecard -pwecard123 wecard -e "SELECT COUNT(*) FROM members;"
```

### 问题2：保存失败
**症状**：点击保存，提示"保存失败"

**可能原因**：
- Token过期（刷新页面重新登录）
- 网络问题（检查网络连接）
- 服务器错误（查看后端日志）

**排查命令**：
```bash
# 查看最近的API请求日志
tail -100 /tmp/gunicorn_error.log | grep "更新成员"
```

### 问题3：编辑后名片未更新
**症状**：管理后台保存成功，但员工名片仍显示旧信息

**解决方案**：
- 员工端刷新页面（清除缓存）
- 检查数据库是否真的更新了：
```bash
mysql -u wecard -pwecard123 wecard -e "
SELECT id, name, mobile, position 
FROM members 
WHERE id=<member_id>;
"
```

---

## 📝 后续优化建议

1. **批量导入**：支持Excel批量导入成员信息
2. **字段校验**：添加手机号格式校验
3. **操作日志**：记录谁在什么时候修改了哪个成员的信息
4. **导出功能**：支持导出成员列表为Excel
5. **搜索过滤**：支持按姓名/手机/职位搜索成员
6. **分页功能**：成员较多时支持分页显示

---

**文档维护**: WeCard开发组  
**技术支持**: 参考 `docs/1、系统认识cc4.5.md`


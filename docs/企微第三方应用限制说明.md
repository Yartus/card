# 企业微信第三方应用获取成员信息的限制

> **日期**: 2025-01-14  
> **问题**: 第三方应用无法直接获取员工的对外显示名称和头像  
> **依据**: 企业微信官方API文档

---

## 问题根源

根据企业微信官方文档（`/opt/qwcard/docs/0000企微接口.md`）：

### 1. 成员名称（name）限制
**文档第398行明确说明：**
> **name**: 成员名称；**第三方不可获取，调用时返回userid以代替name**；代开发自建应用需要管理员授权才返回；对于非第三方创建的成员，第三方通讯录应用也不可获取；未返回name的情况需要通过通讯录展示组件来展示名字

**影响：**
- 调用 `user/get` 接口时，`name` 字段返回的是 `userid`（如：`ZhangSan`）而不是真实姓名（如：`张三`）
- 这导致名片上显示的是代码而不是中文名字

### 2. 头像（avatar）限制
**文档第408行明确说明：**
> **avatar**: 头像url。代开发自建应用需要管理员授权且成员oauth2授权获取；**第三方仅通讯录应用可获取**；对于非第三方创建的成员，第三方通讯录应用也不可获取；上游企业不可获取下游企业成员该字段

**文档第423-424行再次强调：**
> 应用获取敏感字段的说明
> 为保护企业数据与用户隐私，从**2022年6月20号20点开始**，新创建的自建应用与代开发应用，调用该接口时，**不再返回以下字段：头像、性别、手机、邮箱、企业邮箱、员工个人二维码、地址**，应用需要通过oauth2手工授权的方式获取管理员与员工本人授权的字段。

**影响：**
- 头像URL无法直接获取
- 需要通过OAuth2授权才能获取

---

## 解决方案

### ⚠️ 重要更新（2025-01-14）

**经过核查最新的企业微信API文档，发现 `external_profile` 和 `external_position` 也是"第三方仅通讯录应用可获取"。**

这意味着普通第三方应用（当前应用类型）**无法使用方案1**。

### 方案1：使用成员对外属性 ❌ 不可用

**原因：** 文档第519-520行明确说明：
> **external_profile**: 成员对外属性；**第三方仅通讯录应用可获取**
> **external_position**: 对外职务；**第三方仅通讯录应用可获取**

**结论：** 普通第三方应用无法使用此方案

**依据文档第416-417行：**
- `external_profile`: 成员对外属性
- `external_position`: 对外职务

**实施步骤：**

#### 1. 后端代码修改
在 `/opt/qwcard/app/routes/wecom.py` 的 `sync_member_profile` 函数中：

```python
# ✅ 优先使用对外属性中的名称
external_profile = user_info.get('external_profile', {})
external_attr = external_profile.get('external_attr', [])

# 尝试从对外属性中获取对外名称
external_name = None
for attr in external_attr:
    if attr.get('type') == 0:  # 文本类型
        attr_name = attr.get('name', '')
        if attr_name in ['姓名', '对外名称', 'name']:
            external_name = attr.get('value', {}).get('text', '')
            break

# 名称优先级：对外属性名称 > API返回的name > userid
name_value = external_name or user_info.get('name')
if name_value and name_value != userid:
    member.name = name_value
else:
    member.name = userid  # 使用userid作为备选
```

#### 2. 企业管理员配置
**需要企业管理员在企业微信后台进行以下配置：**

1. 进入 **企业微信管理后台** → **通讯录** → **选择成员**
2. 编辑成员信息，设置 **对外信息**：
   - 添加 **对外属性**：姓名/对外名称
   - 填写中文名字（如：张三）
   - 上传对外头像
   - 设置对外职务

3. 确保应用有权限访问对外属性：
   - 进入 **应用管理** → 选择您的应用
   - 检查 **应用权限** 是否包含：
     - ✅ 通讯录基本信息只读
     - ✅ 组织架构信息
     - ✅ 成员敏感信息（如果需要）

#### 3. 验证方法
查看后端日志：
```bash
tail -f /var/log/gunicorn.log | grep "同步成员资料"
```

如果看到：
- `✅ 从企微API获取到用户信息: {...}`：成功获取
- `⚠️ 无法获取真实姓名，使用userid`：需要配置对外属性

---

### 方案2：将应用改为"通讯录同步"类型 ⭐ 推荐

**说明：**
如果将应用类型从"普通应用"改为"通讯录同步应用"，则可以获取：
- ✅ `name` - 真实姓名
- ✅ `avatar` - 头像
- ✅ `mobile` - 手机号
- ✅ `position` - 职位
- ✅ `external_profile` - 对外属性
- ✅ `external_position` - 对外职位

**优点：**
- 一劳永逸，无需其他配置
- 可以获取完整的成员信息
- 不需要每个员工单独授权

**缺点：**
- 需要重新创建或修改应用类型
- 可能需要企业重新授权安装

**实施步骤：**
1. 登录企业微信服务商后台
2. 修改应用配置，将应用类型改为"通讯录同步"
3. 确保应用权限包含"通讯录同步"权限
4. 企业重新授权安装应用

**实施复杂度：** ⭐⭐（推荐）

---

### 方案3：通讯录展示组件（备选）

**依据文档第398行：**
> 未返回name的情况需要通过**通讯录展示组件**来展示名字

**优点：**
- 企业微信官方组件
- 自动显示正确的名字和头像

**缺点：**
- 只能在企业微信客户端内使用
- 无法在外部浏览器中展示
- 集成复杂度高

**实施复杂度：** ⭐⭐⭐⭐（暂不推荐）

---

### 方案4：OAuth2手工授权（理论方案）

**依据文档第423行：**
> 应用需要通过oauth2手工授权的方式获取管理员与员工本人授权的字段

**流程：**
1. 用户首次访问时，引导进行OAuth2授权
2. 授权后可获取：头像、性别、手机、邮箱等敏感字段
3. 存储授权后的数据

**优点：**
- 可以获取完整信息
- 合规合法

**缺点：**
- 每个员工都需要单独授权
- 用户体验较差
- 实施复杂度高

**实施复杂度：** ⭐⭐⭐⭐⭐（暂不推荐）

---

## 当前实施状态

### ✅ 已完成
1. 后端代码已修改，支持读取 `external_profile` 对外属性
2. 添加了详细的日志输出，便于排查问题
3. 服务已重启，修改已生效

### ⚠️ 需要企业管理员操作
1. 在企业微信后台为每个员工设置对外信息
2. 配置对外属性：姓名、头像、职务等
3. 确保应用有相应权限

### 📋 测试步骤
1. 企业管理员配置好对外信息后
2. 在移动端访问名片页面
3. 触发成员信息同步（清空数据库或修改name为userid）
4. 查看日志确认是否获取到对外属性
5. 验证名片显示是否正常

---

## 技术细节

### external_profile 数据结构
```json
{
  "external_profile": {
    "external_attr": [
      {
        "type": 0,  // 文本类型
        "name": "姓名",  // 或 "对外名称"
        "value": {
          "text": "张三"  // 真实姓名
        }
      },
      {
        "type": 1,  // 网页类型
        "name": "头像",
        "value": {
          "url": "https://..."  // 头像URL
        }
      }
    ]
  }
}
```

### 相关企业微信API
- **获取成员**: `GET https://qyapi.weixin.qq.com/cgi-bin/user/get`
- **获取成员详情**: `POST https://qyapi.weixin.qq.com/cgi-bin/user/get`
- **文档**: https://developer.work.weixin.qq.com/document/path/90196

---

## 总结

**问题根源：**
第三方应用（**普通应用**）受企业微信官方限制，无法直接获取员工的真实姓名和头像，只能获取userid。

**根据最新文档核查：**
- ❌ `name` - 无法获取（返回userid）
- ❌ `avatar` / `thumb_avatar` - 无法获取
- ❌ `external_profile` - 无法获取（**第三方仅通讯录应用可获取**）
- ❌ `external_position` - 无法获取（**第三方仅通讯录应用可获取**）
- ❌ `mobile` / `position` - 无法获取

**唯一可行的解决方案：**
1. **将应用类型改为"通讯录同步应用"** ⭐ 推荐
2. 使用OAuth2手工授权（每个员工都需要授权）

**当前代码状态：**
- ✅ 代码已支持读取 `external_profile`（如果可以获取的话）
- ⚠️ 但由于应用类型限制，实际上**无法获取**这些字段

**建议：**
将应用类型改为"通讯录同步应用"，这样可以一次性解决所有问题

---

**文档维护**: WeCard开发组  
**最后更新**: 2025-01-14


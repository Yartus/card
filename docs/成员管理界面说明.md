# 成员管理界面使用说明

## 📋 界面布局（v2024-11-18优化版）

### 表格列说明

| 列名 | 宽度 | 说明 |
|------|------|------|
| **头像** | 70px | 显示成员头像，支持管理员自定义上传 |
| **推送照片** | 80px | 欢迎语卡片展示图，支持单独设置 |
| **员工姓名** | 160px | 员工真实姓名 + ID后6位 + 数据来源标识 |
| **手机号码** | 130px | 联系手机号 |
| **职位** | 110px | 职位名称 |
| **角色** | 80px | 管理员/员工 |
| **数据来源** | 90px | OAuth授权/通讯录 |
| **操作** | 90px | 编辑按钮 |

---

## 🔍 员工姓名列说明

### 显示逻辑（三级优先级）

```
1. display_name（管理员手动设置） ✅ 最高优先级
   └─ 显示为：黑色粗体

2. name（OAuth授权获取，且不是加密ID） ✅ 次优先级
   └─ 显示为：蓝色粗体（表示来自OAuth）

3. 未设置 ⚠️ 需要管理员处理
   └─ 显示为：灰色"未设置"
```

### 辅助信息

- **ID后6位**：鼠标悬停可查看完整ID
- **数据来源标识**：
  - `OAuth`（蓝色徽章）：通过OAuth授权获取
  - `本地`（灰色徽章）：通讯录同步获取

---

## ⚠️ 关键问题：OAuth授权的局限性

### 企业微信API限制

企业微信对**第三方应用**（服务商应用）有严格的数据权限限制：

#### 问题现象
```
员工完成OAuth授权后：
✅ 头像获取成功 → member.avatar_url 有值
❌ 姓名仍是加密ID → member.name = "wmCaJECgAA..." (无法识别)
❌ 手机号为空 → member.mobile = None
❌ 职位为空 → member.position = None
```

#### 技术原因

1. **API调用链路**：
   ```
   getuserinfo3rd (获取user_ticket)
      ↓
   getuserdetail3rd (获取完整信息)
      ↓
   返回字段：
   {
     "name": "wmCaJECgAA...",  // ❌ 仍是加密ID
     "avatar": "http://...",   // ✅ 可以获取
     "mobile": null,           // ❌ 为空
     "position": null          // ❌ 为空
   }
   ```

2. **权限限制**：
   - 企微对第三方应用限制了敏感信息访问
   - 即使用户授权 `snsapi_privateinfo` 权限，部分字段仍无法返回
   - 这是企业微信的安全策略，不是代码问题

3. **对比企业自建应用**：
   - 企业自建应用：可获取完整通讯录信息
   - 第三方服务商应用：只能获取加密ID和头像

---

## ✅ 解决方案：管理员手动设置

### 操作流程

1. **进入成员管理**
   - 管理员工作台 → 👥 成员管理标签页

2. **识别需要设置的成员**
   - 查看"员工姓名"列
   - 显示"未设置"的成员需要处理

3. **点击编辑按钮（✏️）**
   - 进入编辑模式

4. **填写真实信息**
   - **员工姓名**（必填）：真实姓名，如"张三"
   - **手机号码**（选填）：联系电话
   - **职位**（选填）：职位名称

5. **点击保存（✓）**
   - 数据保存到 `members.display_name` 字段
   - 名片系统优先使用 `display_name` 显示

### 数据优先级

名片显示时的姓名优先级：
```
display_name（管理员设置）> name（OAuth返回）> userid（兜底）
```

---

## 📊 数据来源说明

### OAuth授权（✓ OAuth授权）

**触发时机**：员工在企微中打开名片时，首次访问会弹出授权

**获取数据**：
- ✅ 头像（avatar_url）
- ⚠️ 姓名（通常仍是加密ID）
- ❌ 手机号（通常为空）
- ❌ 职位（通常为空）

**特点**：
- 绿色徽章"✓ OAuth授权"
- 数据由企微实时返回
- 受第三方应用权限限制

### 通讯录同步（📋 通讯录）

**触发时机**：管理员在后台手动触发同步

**获取数据**：
- ✅ userid（企业内部ID）
- ⚠️ 姓名（通常是加密ID）
- ❌ 其他字段基本为空

**特点**：
- 蓝色徽章"📋 通讯录"
- 仅同步可见范围内的成员
- 数据完整度较低

---

## 🎯 最佳实践

### 方案一：管理员统一配置（推荐）

**适用场景**：企业规模较小（<50人），管理员可以识别所有员工

**操作步骤**：
1. 成员管理界面批量编辑
2. 根据ID后6位或头像识别员工
3. 逐个填写真实姓名、手机、职位
4. 保存后名片立即生效

**优点**：
- ✅ 信息准确可控
- ✅ 一次设置永久生效
- ✅ 不依赖企微API限制

**缺点**：
- ⚠️ 需要管理员手动维护
- ⚠️ 新员工需要及时设置

### 方案二：OAuth授权 + 管理员补充

**适用场景**：企业规模较大，希望自动化

**操作步骤**：
1. 员工首次访问名片时完成OAuth授权
2. 系统自动获取头像（姓名大概率还是加密ID）
3. 管理员在成员管理界面补充信息

**优点**：
- ✅ 头像自动获取
- ✅ 员工有参与感

**缺点**：
- ⚠️ 姓名/手机仍需手动设置
- ⚠️ 依赖员工主动授权

---

## 🔧 常见问题

### Q1：为什么OAuth授权后姓名还是加密ID？

**A**：这是企业微信对第三方应用的限制，不是系统问题。即使员工授权，企微API也不会返回真实姓名。

**解决**：管理员在成员管理界面手动设置 `display_name`

---

### Q2：如何快速识别哪个加密ID对应哪个员工？

**A**：参考以下信息综合判断：
1. **头像**：OAuth授权后可显示真实头像
2. **ID后6位**：每个员工的ID后缀不同
3. **部门/职位**：如果有同步到，可以作为线索
4. **让员工自报**：让员工在企微中打开名片，告知管理员自己的ID

---

### Q3：批量导入成员信息的方式？

**A**：当前系统不支持批量导入，建议：
1. 让HR提供员工名单（姓名+手机+职位）
2. 让员工先在企微中完成OAuth授权（获取头像）
3. 管理员根据头像对应名单，逐个设置

**后续规划**：
- 计划增加Excel批量导入功能
- 通过手机号匹配成员

---

### Q4：员工离职后如何处理？

**A**：
1. 企微通讯录同步时会自动标记为"不可见"
2. 该成员的名片访问链接会失效
3. 管理员可在成员管理界面删除（暂未开放）

---

## 📝 技术备注

### 数据库字段

```sql
-- members表关键字段
userid          VARCHAR(128)  -- 企业内部ID（通讯录同步）
open_userid     VARCHAR(128)  -- 服务商主体下的加密ID（OAuth）
name            VARCHAR(128)  -- OAuth返回的姓名（通常是加密ID）
display_name    VARCHAR(128)  -- 管理员设置的对外显示名称 ⭐
mobile          VARCHAR(64)   -- 手机号
position        VARCHAR(128)  -- 职位
avatar_url      VARCHAR(512)  -- 企微头像
custom_avatar_url VARCHAR(512) -- 管理员自定义头像
oauth_authorized BOOLEAN       -- 是否已OAuth授权
```

### API接口

```bash
# 获取成员列表
GET /api/v1/wecom/members
返回字段：id, userid, open_userid, name, display_name, mobile, position, avatar_url, oauth_authorized

# 更新成员信息
PUT /api/v1/wecom/members/<id>
请求体：{
  "display_name": "张三",  # 必填
  "mobile": "13800138000", # 选填
  "position": "产品经理"    # 选填
}
```

---

**文档版本**：v2024-11-18  
**维护团队**：WeCard开发组  
**技术支持**：企业微信第三方应用优化


# ä¼ä¸šå¾®ä¿¡å­—æ®µæ˜ å°„æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

åŸºäºç°æœ‰ Vcard.vue ç»„ä»¶åˆ†æå’Œä¼ä¸šå¾®ä¿¡APIå­—æ®µï¼Œè®¾è®¡å®Œæ•´çš„æ•°æ®æ˜ å°„å’ŒåŒæ­¥æ–¹æ¡ˆã€‚

## ğŸ”„ ä¼ä¸šå¾®ä¿¡APIå­—æ®µåˆ†æ

### 1. ä¼ä¸šå¾®ä¿¡ç”¨æˆ·ä¿¡æ¯å­—æ®µ
```javascript
// ä¼ä¸šå¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ API è¿”å›å­—æ®µ
const wecomUserInfo = {
  // åŸºç¡€ä¿¡æ¯
  userid: "ç”¨æˆ·ID",
  name: "å§“å", 
  position: "èŒä½",
  mobile: "æ‰‹æœºå·",
  email: "é‚®ç®±",
  avatar: "å¤´åƒURL",
  
  // éƒ¨é—¨ä¿¡æ¯
  department: [1, 2], // éƒ¨é—¨IDæ•°ç»„
  main_department: 1, // ä¸»éƒ¨é—¨ID
  
  // æ‰©å±•ä¿¡æ¯
  gender: "1", // æ€§åˆ«ï¼š1ç”·2å¥³
  telephone: "åº§æœºå·",
  alias: "åˆ«å",
  address: "åœ°å€",
  extattr: {}, // æ‰©å±•å±æ€§
  
  // çŠ¶æ€ä¿¡æ¯
  status: 1, // æ¿€æ´»çŠ¶æ€
  enable: 1, // å¯ç”¨çŠ¶æ€
  isleader: 0, // æ˜¯å¦éƒ¨é—¨è´Ÿè´£äºº
  hide_mobile: 0, // æ˜¯å¦éšè—æ‰‹æœºå·
  
  // å…¶ä»–
  qr_code: "ä¸ªäººäºŒç»´ç ",
  external_position: "å¯¹å¤–èŒåŠ¡",
  external_profile: {} // å¯¹å¤–ä¿¡æ¯
}
```

### 2. ä¼ä¸šä¿¡æ¯å­—æ®µ
```javascript
// ç§Ÿæˆ·ä¼ä¸šä¿¡æ¯
const tenantInfo = {
  corp_id: "ä¼ä¸šID",
  corp_name: "ä¼ä¸šåç§°",
  corp_full_name: "ä¼ä¸šå…¨ç§°", 
  corp_logo: "ä¼ä¸šLogo",
  corp_address: "ä¼ä¸šåœ°å€",
  corp_website: "ä¼ä¸šå®˜ç½‘",
  corp_phone: "ä¼ä¸šç”µè¯",
  corp_email: "ä¼ä¸šé‚®ç®±",
  
  // è¡Œä¸šä¿¡æ¯
  corp_type: "ä¼ä¸šç±»å‹",
  corp_industry: "æ‰€å±è¡Œä¸š",
  corp_scale: "ä¼ä¸šè§„æ¨¡",
  
  // é…ç½®ä¿¡æ¯
  card_template_id: "é»˜è®¤åç‰‡æ¨¡æ¿ID",
  brand_colors: {}, // ä¼ä¸šå“ç‰Œè‰²
  custom_fields: {} // è‡ªå®šä¹‰å­—æ®µé…ç½®
}
```

## ğŸ¯ å­—æ®µæ˜ å°„è®¾è®¡

### 1. ç›´æ¥æ˜ å°„å­—æ®µ
```javascript
// ä¼ä¸šå¾®ä¿¡ â†’ WeCard ç›´æ¥æ˜ å°„
const directMapping = {
  // åŸºç¡€ä¿¡æ¯æ˜ å°„
  "wecom.name": "basic_info.name",
  "wecom.position": "basic_info.title", 
  "wecom.mobile": "contact_info.mobile",
  "wecom.email": "contact_info.email",
  "wecom.avatar": "basic_info.avatar",
  "wecom.telephone": "contact_info.phone",
  "wecom.address": "contact_info.address",
  
  // ä¼ä¸šä¿¡æ¯æ˜ å°„
  "tenant.corp_name": "basic_info.company",
  "tenant.corp_logo": "basic_info.company_logo",
  "tenant.corp_website": "contact_info.website",
  "tenant.corp_address": "contact_info.office_address",
  "tenant.corp_phone": "contact_info.company_phone"
}
```

### 1.1 æ–°å¢æ¨¡å—ç›¸å…³å­—æ®µï¼ˆéWeComç›´å‡ºï¼Œå‚ä¸åˆå¹¶/å±•ç¤ºï¼‰
```javascript
// æ–°å¢ï¼šHeader/åˆ†äº«é¢„è§ˆ/æ—¶é—´çº¿/å®¢æˆ·Logo/ç´ æåº“/åª’ä½“æ··æ’
const extendedFields = {
  header: {
    background_style: 'solid | translucent',
    slogan: 'string|null',
    show_company_logo: true,
    layout: 'card_top_compact',
    contact_visibility: {
      mobile: true, wechat: true, email: true, phone: false, address: false, website: true
    }
  },
  share_preview: {
    thumbnail_url: 'string|null',
    style: 'default_template',
    override_allowed: true
  },
  enterprise_timeline: {
    items: [ { date: 'YYYY-MM', icon: 'string', title: 'string', description: 'string?' } ],
    layout: 'alternate',
    line_style: 'solid|dashed',
    max_items: 8
  },
  clients: {
    logos: [ { name: 'string', logo: 'url', url: 'url?' } ],
    uniform_shape: 'rect',
    aspect_ratio: '4:3',
    carousel: { autoplay: true, speed_ms: 3000, gap_px: 12, loop: true }
  },
  media_blocks: [
    { type: 'text', content: 'string' },
    { type: 'image', src: 'url', alt: 'string?' },
    { type: 'video', src: 'url', poster: 'url?', max_height: 240 }
  ],
  asset_library: {
    entry_label: 'string',
    items: [ { id: 'string', cover: 'url', title: 'string', summary: 'string', link: 'url' } ],
    plan_limits: { free: 3, paid: 10 },
    independent_url: 'url'
  }
}
```

### 2. è®¡ç®—æ˜ å°„å­—æ®µ
```javascript
// éœ€è¦è®¡ç®—å¤„ç†çš„å­—æ®µ
const computedMapping = {
  // éƒ¨é—¨ä¿¡æ¯éœ€è¦æŸ¥è¯¢éƒ¨é—¨åç§°
  "basic_info.department": async (wecom) => {
    const deptInfo = await getDepartmentInfo(wecom.main_department)
    return deptInfo.name
  },
  
  // å®Œæ•´åœ°å€æ‹¼æ¥
  "contact_info.full_address": (wecom, tenant) => {
    return `${tenant.corp_address} ${wecom.address || ''}`.trim()
  },
  
  // æ˜¾ç¤ºåç§°å¤„ç†
  "basic_info.display_name": (wecom) => {
    return wecom.alias || wecom.name
  },
  
  // å¯¹å¤–èŒåŠ¡ä¼˜å…ˆ
  "basic_info.external_title": (wecom) => {
    return wecom.external_position || wecom.position
  }
}
```

### 3. é»˜è®¤å€¼å’Œè¡¥å…¨å­—æ®µ
```javascript
// é»˜è®¤å€¼é…ç½®
const defaultValues = {
  // ç¼ºå¤±å­—æ®µçš„é»˜è®¤å€¼
  "basic_info.avatar": (wecom) => {
    if (!wecom.avatar) {
      return generateAvatarFromName(wecom.name)
    }
    return wecom.avatar
  },
  
  // å¾®ä¿¡ç›¸å…³å­—æ®µï¼ˆéœ€è¦æ‰‹åŠ¨è¾“å…¥ï¼‰
  "contact_info.wechat": null, // æç¤ºç”¨æˆ·å¡«å†™
  "interactive_features.wechat_qr": null, // æç¤ºä¸Šä¼ äºŒç»´ç 
  
  // ä¸šåŠ¡å±•ç¤ºå­—æ®µï¼ˆåŸºäºè¡Œä¸šæ¨èï¼‰
  "business_showcase.company_intro": (tenant) => {
    return generateCompanyIntro(tenant.corp_industry)
  },
  
  "business_showcase.personal_intro": (wecom) => {
    return `æˆ‘æ˜¯${wecom.name}ï¼Œ${wecom.position}ï¼Œå¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼`
  }
}
```

## ğŸ”„ æ•°æ®åŒæ­¥æµç¨‹

### 1. åŒæ­¥è§¦å‘æ—¶æœº
```javascript
const syncTriggers = {
  // è‡ªåŠ¨åŒæ­¥è§¦å‘
  "enterprise_install": "ä¼ä¸šé¦–æ¬¡å®‰è£…æ—¶å…¨é‡åŒæ­¥",
  "member_join": "æ–°æˆå‘˜åŠ å…¥æ—¶åŒæ­¥è¯¥æˆå‘˜",
  "member_update": "æˆå‘˜ä¿¡æ¯å˜æ›´æ—¶å¢é‡åŒæ­¥",
  "daily_sync": "æ¯æ—¥å®šæ—¶å…¨é‡åŒæ­¥",
  
  // æ‰‹åŠ¨åŒæ­¥è§¦å‘
  "manual_sync": "ç®¡ç†å‘˜æ‰‹åŠ¨è§¦å‘åŒæ­¥",
  "member_self_sync": "æˆå‘˜è‡ªå·±è§¦å‘åŒæ­¥"
}
```

### 2. åŒæ­¥å®ç°é€»è¾‘
```javascript
// ä¼ä¸šå¾®ä¿¡æ•°æ®åŒæ­¥å‡½æ•°
async function syncWecomData(tenantId, userId = null) {
  try {
    // 1. è·å–ä¼ä¸šå¾®ä¿¡è®¿é—®å‡­è¯
    const accessToken = await getCorpAccessToken(tenantId)
    
    // 2. åŒæ­¥ä¼ä¸šä¿¡æ¯
    const corpInfo = await getCorpInfo(accessToken)
    await updateTenantInfo(tenantId, corpInfo)
    
    // 3. åŒæ­¥ç”¨æˆ·ä¿¡æ¯
    if (userId) {
      // åŒæ­¥å•ä¸ªç”¨æˆ·
      const userInfo = await getWecomUserInfo(accessToken, userId)
      await syncSingleUser(tenantId, userInfo)
    } else {
      // åŒæ­¥æ‰€æœ‰ç”¨æˆ·
      const userList = await getWecomUserList(accessToken)
      await syncAllUsers(tenantId, userList)
    }
    
    // 4. åŒæ­¥éƒ¨é—¨ä¿¡æ¯
    const deptList = await getWecomDepartmentList(accessToken)
    await syncDepartments(tenantId, deptList)
    
    return { success: true, synced_count: userList?.length || 1 }
    
  } catch (error) {
    console.error('ä¼ä¸šå¾®ä¿¡æ•°æ®åŒæ­¥å¤±è´¥:', error)
    return { success: false, error: error.message }
  }
}

// å•ä¸ªç”¨æˆ·åŒæ­¥å¤„ç†
async function syncSingleUser(tenantId, wecomUser) {
  // 1. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·è®°å½•
  let member = await findMemberByWecomId(tenantId, wecomUser.userid)
  if (!member) {
    member = await createMember(tenantId, wecomUser.userid)
  }
  
  // 2. æ˜ å°„åŸºç¡€ä¿¡æ¯
  const basicInfo = {
    name: wecomUser.name,
    title: wecomUser.external_position || wecomUser.position,
    department: await getDepartmentName(wecomUser.main_department),
    avatar: wecomUser.avatar,
    company: await getTenantCompanyName(tenantId)
  }
  
  // 3. æ˜ å°„è”ç³»ä¿¡æ¯
  const contactInfo = {
    mobile: wecomUser.mobile,
    email: wecomUser.email,
    phone: wecomUser.telephone,
    address: wecomUser.address
  }
  
  // 4. ä¿ç•™ç°æœ‰çš„æ‰‹åŠ¨å¡«å†™å­—æ®µ
  const existingCard = await getCardProfile(member.id)
  const manualFields = {
    wechat: existingCard?.contact_info?.wechat,
    wechat_qr: existingCard?.interactive_features?.wechat_qr,
    personal_intro: existingCard?.business_showcase?.personal_intro
  }
  
  // 5. åˆå¹¶æ•°æ®å¹¶ä¿å­˜
  const cardProfile = {
    basic_info: basicInfo,
    contact_info: { ...contactInfo, ...manualFields },
    header: existingCard?.header || defaultHeaderFromTenant(tenantId),
    share_preview: await ensureSharePreview(existingCard?.share_preview, basicInfo, tenantId),
    enterprise_timeline: existingCard?.enterprise_timeline || { items: [], layout: 'alternate', line_style: 'dashed' },
    clients: existingCard?.clients || { logos: [], uniform_shape: 'rect', aspect_ratio: '4:3' },
    media_blocks: existingCard?.media_blocks || [],
    interactive_features: {
      wechat_qr: manualFields.wechat_qr,
      quick_call: true,
      add_wechat: !!manualFields.wechat,
      save_contact: true,
      share_card: true
    },
    business_showcase: {
      personal_intro: manualFields.personal_intro || generateDefaultIntro(wecomUser),
      company_intro: await getTenantCompanyIntro(tenantId)
    },
    sync_info: {
      last_sync: new Date(),
      wecom_userid: wecomUser.userid,
      sync_status: 'success'
    }
  }
  
  await updateCardProfile(member.id, cardProfile)
  return member
}
```

### 3. å†²çªå¤„ç†ç­–ç•¥
```javascript
const conflictResolution = {
  // ä¼ä¸šå¾®ä¿¡æ•°æ®ä¼˜å…ˆçš„å­—æ®µ
  "wecom_priority": [
    "basic_info.name",
    "basic_info.title", 
    "basic_info.department",
    "basic_info.avatar",
    "contact_info.mobile",
    "contact_info.email"
  ],
  
  // æ‰‹åŠ¨æ•°æ®ä¼˜å…ˆçš„å­—æ®µ
  "manual_priority": [
    "contact_info.wechat",
    "interactive_features.wechat_qr",
    "business_showcase.personal_intro",
    "business_showcase.portfolio"
  ],
  
  // åˆå¹¶ç­–ç•¥çš„å­—æ®µ
  "merge_strategy": {
    "contact_info.address": "ä¼ä¸šå¾®ä¿¡åœ°å€ + æ‰‹åŠ¨è¡¥å……åœ°å€",
    "business_showcase.services": "åˆå¹¶ä¼ä¸šä¿¡æ¯å’Œä¸ªäººæœåŠ¡"
  }
}
```

## ğŸ“Š æ•°æ®è´¨é‡ä¿è¯

### 1. æ•°æ®éªŒè¯è§„åˆ™
```javascript
const validationRules = {
  // å¿…å¡«å­—æ®µéªŒè¯
  required: {
    "basic_info.name": "å§“åä¸èƒ½ä¸ºç©º",
    "basic_info.company": "å…¬å¸åç§°ä¸èƒ½ä¸ºç©º",
    "contact_info.mobile": "æ‰‹æœºå·ä¸èƒ½ä¸ºç©º"
  },
  
  // æ ¼å¼éªŒè¯
  format: {
    "contact_info.mobile": /^1[3-9]\d{9}$/,
    "contact_info.email": /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    "contact_info.website": /^https?:\/\/.+/
  },
  
  // é•¿åº¦é™åˆ¶
  length: {
    "basic_info.name": { max: 20 },
    "basic_info.title": { max: 50 },
    "business_showcase.personal_intro": { max: 200 }
  }
}
```

### 2. æ•°æ®è¡¥å…¨å»ºè®®
```javascript
const completionSuggestions = {
  // ç¼ºå¤±å­—æ®µæç¤º
  missing_fields: {
    "contact_info.wechat": {
      message: "æ·»åŠ å¾®ä¿¡å·å¯æå‡è”ç³»è½¬åŒ–ç‡",
      priority: "high",
      action: "manual_input"
    },
    "interactive_features.wechat_qr": {
      message: "ä¸Šä¼ å¾®ä¿¡äºŒç»´ç æ–¹ä¾¿å®¢æˆ·æ·»åŠ ",
      priority: "medium", 
      action: "upload_image"
    },
    "business_showcase.personal_intro": {
      message: "å®Œå–„ä¸ªäººä»‹ç»æå‡ä¸“ä¸šå½¢è±¡",
      priority: "medium",
      action: "text_input"
    }
  },
  
  // æ™ºèƒ½æ¨è
  smart_suggestions: {
    "business_showcase.company_intro": async (tenantId) => {
      const industry = await getTenantIndustry(tenantId)
      return generateIndustryTemplate(industry)
    },
    "contact_info.website": async (tenantId) => {
      const corpInfo = await getTenantInfo(tenantId)
      return corpInfo.corp_website
    }
  }
}
```

## ğŸ¯ APIæ¥å£è®¾è®¡

### 1. åŒæ­¥ç›¸å…³æ¥å£
```javascript
// æ•°æ®åŒæ­¥æ¥å£
POST /api/wecom/sync
{
  "tenant_id": "ç§Ÿæˆ·ID",
  "user_id": "ç”¨æˆ·IDï¼ˆå¯é€‰ï¼Œä¸ºç©ºåˆ™å…¨é‡åŒæ­¥ï¼‰",
  "force_update": false // æ˜¯å¦å¼ºåˆ¶è¦†ç›–æ‰‹åŠ¨æ•°æ®
}

// åŒæ­¥çŠ¶æ€æŸ¥è¯¢
GET /api/wecom/sync/status/:tenant_id

// å­—æ®µæ˜ å°„é…ç½®
GET /api/wecom/mapping/:tenant_id
PUT /api/wecom/mapping/:tenant_id

// æ–°å¢ï¼šåˆ†äº«é¢„è§ˆ/æ—¶é—´çº¿/å®¢æˆ·/ç´ æ
POST /api/card/preview/thumbnail
PUT  /api/card/settings/contact-visibility
GET  /api/card/timeline/:member_id
PUT  /api/card/timeline/:member_id
GET  /api/card/clients/:tenant_id
PUT  /api/card/clients/:tenant_id
GET  /api/assets/:tenant_id
POST /api/assets/:tenant_id
DELETE /api/assets/:tenant_id/:asset_id
```

### 2. åç‰‡æ•°æ®æ¥å£
```javascript
// è·å–åç‰‡ä¿¡æ¯ï¼ˆåˆå¹¶ä¼å¾®å’Œæ‰‹åŠ¨æ•°æ®ï¼‰
GET /api/card/profile/:member_id

// æ›´æ–°åç‰‡ä¿¡æ¯ï¼ˆä»…æ›´æ–°æ‰‹åŠ¨å­—æ®µï¼‰
PUT /api/card/profile/:member_id
{
  "contact_info": {
    "wechat": "å¾®ä¿¡å·"
  },
  "business_showcase": {
    "personal_intro": "ä¸ªäººä»‹ç»"
  }
}

// è·å–æ•°æ®å®Œæ•´åº¦
GET /api/card/completeness/:member_id
```

---

**å®æ–½ä¼˜å…ˆçº§**ï¼š
1. ğŸ”´ **åŸºç¡€å­—æ®µæ˜ å°„**ï¼ˆå§“åã€èŒä½ã€è”ç³»æ–¹å¼ï¼‰
2. ğŸŸ¡ **ä¼ä¸šä¿¡æ¯åŒæ­¥**ï¼ˆå…¬å¸åç§°ã€Logoã€åœ°å€ï¼‰
3. ğŸŸ¡ **æ™ºèƒ½æ•°æ®è¡¥å…¨**ï¼ˆé»˜è®¤å€¼ã€æ¨èå†…å®¹ï¼‰
4. ğŸŸ¢ **é«˜çº§åŠŸèƒ½**ï¼ˆå†²çªå¤„ç†ã€æ•°æ®éªŒè¯ï¼‰

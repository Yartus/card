# WeCard 系统综述

> **版本**: v2.8  
> **更新**: 2025-11-14  
> **服务器**: 2核4G  
> **部署目录**: /opt/qwcard

---

## 1. 产品定位与运行环境

### 产品定位
- **定位**: 基于企业微信的标准化 SaaS 名片平台
- **架构**: 服务商 → 租户企业 → 企业员工（三层架构）
- **模式**: 二维码扫码安装（应用商城上架规划中）
- **访问**: 企业微信工作台 WebView（https://zjemail.cn）

### 技术栈
- **前端**: Nuxt.js 2 (SSR) + Vue 2 + Vuex
- **后端**: Flask + Gunicorn + MySQL 8.0
- **缓存**: Redis（企微票据、Session）
- **代理**: Nginx（反向代理 + SSL）
- **服务器**: 2核4G，Swap 2G

---

## 2. 系统架构

### 整体架构图
```
用户访问 (企业微信)
    ↓
HTTPS (443) → Nginx
    ↓
    ├─→ / (3000端口) → Nuxt.js SSR
    │   ├─ /wecom/workspace (管理员工作台)
    │   ├─ /wecom/card (员工名片)
    │   └─ /admin (服务商后台)
    │
    └─→ /api (5001端口) → Flask API (Gunicorn)
        ├─ OAuth认证
        ├─ 数据接口
        ├─ 文件上传
        └─ 推送服务
    ↓
数据层
├─ MySQL 8.0 (3306) → 租户/成员/配置数据
└─ Redis (6379) → 票据/Session缓存
```

### 核心组件

| 组件 | 端口 | 进程 | 说明 |
|------|------|------|------|
| **Nginx** | 80/443 | nginx | 反向代理、SSL终端、静态资源 |
| **Nuxt前端** | 3000 | node | SSR服务器、HMR热更新 |
| **Flask后端** | 5001 | gunicorn | API服务、2个worker |
| **MySQL** | 3306 | mysqld | 数据持久化 |
| **Redis** | 6379 | redis-server | 缓存、Session |

### 服务监听地址

```bash
# 前端服务
127.0.0.1:3000  → Nuxt.js (仅本地访问)

# 后端服务
127.0.0.1:5001  → Flask API (仅本地访问)

# 数据库
127.0.0.1:3306  → MySQL
127.0.0.1:6379  → Redis

# 对外访问
0.0.0.0:80      → Nginx HTTP
0.0.0.0:443     → Nginx HTTPS
```

---

## 3. 系统重启方式

### ⚠️ 重要说明：Nuxt进程管理

**开发阶段**（当前）：
- ✅ systemd服务已禁用（`wecard-nuxt.service`）
- ✅ 使用手动命令启动Nuxt，更灵活
- ⚠️ 重启服务器后需要手动启动Nuxt

**生产阶段**（待切换）：
```bash
# 启用systemd自动管理
systemctl enable wecard-nuxt.service
systemctl start wecard-nuxt.service

# 优势：开机自启、自动重启、资源限制
```

### 快速重启（推荐）

```bash
# 重启后端 API（推荐方式）
cd /opt/qwcard
pkill -HUP -f "gunicorn.*wsgi:application"

# 重启前端 Nuxt（开发模式 - 如果修改了前端代码）
# ⚠️ 注意：必须先清理所有实例，避免多进程冲突
pkill -9 -f "nuxt --hostname"
pkill -9 -f "npm run dev"
sleep 2
cd /opt/qwcard && nohup npm run dev:light > /var/log/nuxt-dev.log 2>&1 < /dev/null &

# 重启 Nginx
nginx -t && nginx -s reload
```

### 完整重启流程

```bash
# 1. 停止服务
pkill gunicorn
pkill -f "nuxt --hostname"

# 2. 启动后端服务
cd /opt/qwcard
source venv/bin/activate
nohup gunicorn -w 2 -b 127.0.0.1:5001 wsgi:application \
  --timeout 120 --graceful-timeout 30 \
  --access-logfile - --error-logfile - \
  > /var/log/gunicorn.log 2>&1 &

# 3. 启动前端服务
cd /opt/qwcard
nohup npm run dev:light > /var/log/nuxt-dev.log 2>&1 &

# 4. 重启 Nginx
nginx -s reload
```

### 服务检查

```bash
# 查看运行中的服务
ps aux | grep -E "gunicorn|nuxt|node" | grep -v grep

# 检查端口监听
netstat -tuln | grep -E "3000|5001"

# 健康检查
curl http://127.0.0.1:5001/healthz
# 预期: {"status":"ok"}

curl http://127.0.0.1:3000/
# 预期: 返回HTML页面

# 查看日志
tail -f /var/log/gunicorn.log
tail -f /var/log/nuxt-dev.log
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 常见问题排查

#### 问题1：Nuxt出现多个进程实例

**症状**：
- 日志显示多个监听端口（如 3000、43333等）
- 页面加载缓慢或出错
- 内存占用异常高

**原因**：
- systemd服务（`wecard-nuxt.service`）和手动启动命令同时运行
- nohup启动时shell fork出多个进程

**解决方案**：
```bash
# 1. 检查systemd服务状态
systemctl status wecard-nuxt.service

# 2. 如果服务在运行，停止并禁用（开发阶段）
systemctl stop wecard-nuxt.service
systemctl disable wecard-nuxt.service

# 3. 清理所有Nuxt进程
pkill -9 -f "nuxt --hostname"
pkill -9 -f "npm run dev"

# 4. 重新启动单个实例
cd /opt/qwcard && nohup npm run dev:light > /var/log/nuxt-dev.log 2>&1 < /dev/null &

# 5. 验证只有一个实例
ps aux | grep "npm run dev:light" | grep -v grep
# 应该只有1个npm进程和1个node/nuxt子进程
```

**预防措施**：
- 开发阶段禁用systemd服务
- 生产部署时启用systemd统一管理
- 每次启动前先清理现有进程

#### 问题2：端口3000被占用

**解决方案**：
```bash
# 查找占用进程
lsof -i:3000

# 终止占用进程
kill -9 $(lsof -ti:3000)
```

---

## 4. 应用层级结构

### 4.1 服务商层（您）
- **访问路径**: `/admin`
- **认证方式**: 本地账号密码（provider-auth插件）
- **权限功能**:
  - 查看所有租户列表
  - 查看租户用量统计
  - 查看系统运行状态
  - ❌ 不直接修改租户配置

### 4.2 租户管理层（企业管理员）
- **访问路径**: `/wecom/workspace`
- **认证方式**: 企业微信 OAuth
- **角色判定**:
  - `installer`（安装者）
  - `super_admin`（企微超管）
- **权限功能**:
  - 拖拽配置名片模块
  - 保存企业配置（workspace JSON）
  - 设置推送规则
  - 管理素材库

### 4.3 员工名片层（普通用户）
- **访问路径**: `/wecom/card`
- **认证方式**: 企业微信 OAuth
- **角色判定**: `user`（可见范围内的普通员工）
- **权限功能**:
  - 查看个人名片
  - 分享名片
  - 快速联系

### 4.4 访客层（外部用户）
- **访问路径**: 分享链接
- **认证方式**: 无需认证
- **权限功能**:
  - 查看分享的名片
  - 保存联系方式
  - 查看素材库公开内容

---

## 5. 认证与权限流程

### OAuth认证流程
```
1. 用户访问 /wecom/workspace
   ↓
2. 检查 JWT token（wecom-auth插件）
   ↓
3. 无token → 跳转企微OAuth
   ↓
4. 回调 /api/v1/wecom/oauth/callback
   ↓
5. getuserinfo3rd 获取用户信息
   ↓
6. verify_user 识别企业身份
   ↓
7. check_user_permission 判定角色
   ↓
8. 生成 JWT token
   ↓
9. 根据角色重定向
   - installer/super_admin → /wecom/workspace
   - user → /wecom/card
   - none → 提示权限错误
```

### 角色权限划分

| 角色 | 判定条件 | 重定向目标 | 权限 |
|------|---------|-----------|------|
| `installer` | Tenant.installer_userid | /wecom/workspace | 管理员（安装者） |
| `super_admin` | 企微超管查询 | /wecom/workspace | 管理员（超管） |
| `user` | 可见范围内 | /wecom/card | 普通员工 |
| `none` | 不在可见范围 | 401错误 | 无权限 |

### JWT Token机制
- **生成**: `verify_user` 后生成
- **存储**: 前端 localStorage + Vuex
- **携带**: Axios拦截器自动添加 `Authorization: Bearer <token>`
- **验证**: 所有API接口验证JWT
- **刷新**: 401错误自动跳回OAuth

---

## 6. 名片配置链路

### 管理员配置流程
```
工作台 (workspace.vue)
    ↓
Vuex管理状态
├─ 模块库（左）
├─ 配置区（中）
└─ 预览区（右）
    ↓
保存配置
PUT /api/v1/wecom/tenant/workspace
    ↓
存储到 Tenant.config
{
  "workspace": {
    "version": "1.0",
    "modules": [...],
    "header": {...},
    "theme": "tech"
  }
}
```

### 员工查看流程
```
员工访问 /wecom/card
    ↓
GET /api/v1/wecom/card/my
    ↓
合并数据
├─ 租户配置（Tenant.config.workspace）
├─ 成员档案（Member表）
└─ 企微实时数据（getuserinfo）
    ↓
构建 card_data
    ↓
WecardOptimized.vue 渲染
```

---

## 7. 文件上传系统

### 上传流程
```
前端选择文件
    ↓
ImageUpload组件
├─ 压缩图片（Canvas）
│  - 宽度: 1200px
│  - 质量: 0.75
│  - 目标: 500KB
└─ upload-security-mixin
   - 频率限制: 2秒冷却
   - 配额检查: 按套餐
    ↓
POST /api/v1/files/upload
├─ JWT验证
├─ 租户隔离
├─ MD5去重
├─ 文件类型检查
└─ 大小限制（500KB）
    ↓
存储到 /opt/qwcard/uploads/
    ↓
返回稳定URL
```

### 存储结构
```
/opt/qwcard/uploads/
├── tenant_1/
│   ├── logos/
│   ├── images/
│   └── files/
├── tenant_2/
│   └── ...
└── shared/
    └── icons/
```

---

## 8. 核心数据表

### 主要数据表

| 表名 | 说明 | 关键字段 |
|------|------|---------|
| `tenants` | 租户企业 | id, corp_id, name, config |
| `members` | 企业员工 | id, tenant_id, userid, name, avatar_url, custom_avatar_url, custom_push_photo_url |
| `tenant_assets` | 素材库 | id, tenant_id, title, metadata |
| `asset_analytics` | 素材统计 | id, asset_id, view_count |
| `suite_tickets` | 企微票据 | suite_id, ticket, expire_at |

### 配置存储

**Tenant.config 结构**:
```json
{
  "workspace": {
    "version": "1.0",
    "modules": [
      {
        "id": "company-intro",
        "type": "CompanyIntro",
        "data": {...}
      }
    ],
    "header": {
      "background": {...},
      "logo": {...}
    },
    "theme": "tech"
  },
  "push_config": {
    "cardTitle": "这是我的数字名片 👋",
    "cardPreviewConfig": {
      "avatarMode": "company",
      "companyAvatar": "",
      "backgroundType": "solid",
      "backgroundColor": "#f5f5f5",
      "themeColor": "#fbb9b6",
      "personalIntro": ""
    }
  }
}
```

---

## 9. 模块系统

### 成员信息与头像优先级（2025-11-18）

#### 成员姓名显示优先级
- **字段说明**：
  - `members.name`：OAuth返回（通常是加密ID，受企微API限制）
  - `members.display_name`：管理员手动设置的真实姓名
  - `members.userid/open_userid`：企微ID（加密字符串）

- **名片显示优先级**：
  1. `display_name`（管理员设置）← 最高优先级
  2. `name`（OAuth返回，若非加密ID）
  3. `userid`（兜底）

- **OAuth授权局限**：企微对第三方应用限制敏感信息，即使授权也仅能获取头像，姓名/手机/职位通常为空或加密ID

#### 头像与推送照片优先级

**名片头像取值**：
  1. `members.custom_avatar_url`（成员管理单人设置）
  2. `AvatarEditor.customAvatar`（全局统一头像）
  3. `members.avatar_url`（企微头像兜底）

**推送卡片照片取值**：
  1. `members.custom_push_photo_url`（成员管理单人设置）← 最高优先级
  2. `push_config.cardPreviewConfig.companyAvatar`（全局统一推送图）
  3. `members.avatar_url`（企微头像兜底）

> **设计理念**：全局配置 + 单点覆盖。全局配置作为兜底保证统一形象，单人设置支持精细化定制（如销售团队个人照、部门差异化）。

### 可用模块列表

| 模块ID | 组件名 | 分类 | 说明 |
|--------|--------|------|------|
| company-intro | CompanyIntro | 展示 | 企业简介 |
| standard-grid | StandardGrid | 展示 | 通用网格 |
| video-showcase | VideoShowcase | 展示 | 多媒体展示 |
| logo-wall | LogoWall | 展示 | Logo墙 |
| trust-credentials | TrustCredentials | 展示 | 信任背书 |
| timeline | Timeline | 展示 | 时间线 |
| push-config | PushConfigSection | 系统 | 推送消息配置 |

### 推送消息配置模块

**功能**：配置添加好友后自动推送给客户的名片消息

**推送流程**：
```
客户添加员工为好友
    ↓
企业微信回调事件
    ↓
POST /api/v1/wecom/events
    ↓
发送两条消息：
1. 纯文字消息（cardTitle）
2. 卡片链接消息（/card-preview/:tenantId/:memberId）
    ↓
客户点击卡片 → 跳转完整名片页面
```

**配置项**：
- `cardTitle`: 消息标题（第一条文字消息）
- `cardPreviewConfig`: 卡片预览配置
  - `avatarMode`: 头像模式（company/member）
  - `backgroundType`: 背景类型（image/solid，默认solid）
  - `themeColor`: 主题颜色（统一设置底部区域、电话图标、头像边框）
  - `personalIntro`: 个人介绍（可选，默认使用公司介绍）

**存储位置**：`Tenant.config.push_config`

**图片上传标准**：
- 首图高质量模式：背景图片和公司头像
  - 最大宽度：2000px
  - 压缩质量：0.9
  - 文件大小限制：1MB

### 套餐限制

| 套餐 | 模块数 | 图片数 | 视频数 | Logo数 |
|------|--------|--------|--------|--------|
| free | 基础3个 | 5 | 0 | 8 |
| trial | 6个 | 8 | 1 | 20 |
| pro | 10个 | 10 | 1 | 20 |
| enterprise | 15个 | 20 | 2 | 30 |

---

## 10. 素材库系统

### 核心功能
- ✅ 富文本编辑器（BlockEditor）
- ✅ 图文混排
- ✅ 数据亮点
- ✅ 独立分享链接
- ✅ 租户数据隔离

### 链接系统

**整体素材库链接**：
- 格式：`/assets/{tenantId}`
- 用途：配置到企业微信侧边栏，员工访问整个素材库
- 生成：统一使用 `workspace.tenantInfo.id`

**单个素材链接**：
- 格式：`/assets/{tenantId}#asset-{assetId}`
- 用途：独立分享单个素材，使用锚点定位
- 实现：前端路由 `pages/assets/_tenant_id.vue` 处理锚点定位

### 2025-11-14 OAuth授权模块 + 移动端分流 (v2.8)

#### 设备自动分流
- **单一入口**: 企微后台（桌面端与移动端）统一配置 `https://zjemail.cn/wecom/workspace`
- **自动判断**:
  - 管理员 + 电脑端 → `/wecom/workspace`（管理员配置界面）
  - 管理员 + 移动端 → `/wecom/card`（显示个人名片）
  - 普通员工 + 任何设备 → `/wecom/card`（显示个人名片）
- **实现位置**: `pages/wecom/workspace.vue` mounted钩子中，通过User Agent判断设备类型

#### OAuth授权获取完整信息
**背景**: 企微第三方应用（普通应用类型）受限于API权限，无法直接获取成员的对外显示名称、手机号、职位等敏感信息。

**解决方案**: 实现OAuth2手动授权流程（`snsapi_privateinfo`权限）

**授权流程**:
```
1. 员工访问 /wecom/card
   ↓
2. 后端检测成员信息不完整（name=userid，无mobile等）
   ↓
3. 返回 need_oauth=true + oauth_url
   ↓
4. 前端弹出授权确认窗口
   ↓
5. 用户点击确定 → 跳转企微OAuth授权页面
   ↓
6. 企微回调 /api/v1/wecom/oauth/callback?corp_id=xxx&state=oauth_member_info&code=xxx
   ↓
7. 后端调用：
   - getuserinfo3rd → 获取user_ticket
   - getuserdetail3rd → 获取完整信息
   ↓
8. 更新数据库，标记oauth_authorized=true
   ↓
9. 重定向到名片页面，显示完整信息
```

**数据库字段** (`members`表):
- `oauth_authorized` BOOLEAN - 是否已OAuth授权
- `oauth_authorized_at` DATETIME - 授权时间
- `user_ticket` VARCHAR(512) - 用户票据

**核心接口**:
- `GET /api/v1/wecom/card/my` - 检测是否需要OAuth授权
- `GET /api/v1/wecom/oauth/callback` - OAuth回调处理

**核心函数**:
- `generate_oauth_url()` - 生成OAuth授权URL（scope=snsapi_privateinfo）
- `fetch_oauth_user_info()` - 通过code获取完整用户信息
- `oauth_callback()` - 处理两种场景（登录 + 获取成员信息）

**当前状态** ⚠️:
- ✅ **已实现**: OAuth授权流程、设备分流、头像获取
- ❌ **未完全实现**: 对外显示名称、手机号码、职位信息
- **原因**: 企微API对第三方应用的限制，即使使用OAuth授权，部分敏感字段仍可能无法返回
- **影响**: 授权后仅能获取头像，name/mobile/position字段企微API返回为空

**下一步方案**:
1. 核实企微应用配置的权限范围（是否包含敏感信息权限）
2. ✅ **已实现**: 管理后台手动编辑成员信息功能
3. 或升级应用类型为"通讯录同步应用"（需评估业务影响）

#### 成员管理模块（v2.8补充，v2024-11-18优化）

**功能入口**: 管理员工作台 → 👥 成员管理标签页

**界面布局**（8列紧凑设计）:
- 头像（70px）：支持管理员自定义上传
- 推送照片（80px）：单独设置推送卡片展示图
- 员工姓名（160px）：显示真实姓名 + ID后6位 + 数据来源标识
- 手机号码（130px）、职位（110px）、角色（80px）
- 数据来源（90px）：✓OAuth授权 / 📋通讯录
- 操作（90px）：编辑按钮

**核心功能**:
- 行内编辑：姓名（必填）、手机、职位、头像、推送照片
- 数据识别：通过ID后6位、头像、数据来源徽章快速识别成员
- 权限控制：仅管理员可见，数据按租户隔离

**使用场景**: 解决企微API限制导致的姓名/手机/职位信息缺失问题

#### 企业联系信息配置（v2.8补充）
**功能入口**: 管理员工作台 → 👁️ 联系方式标签 → 🏢 企业联系信息

**核心功能**:
- 配置企业级联系信息（公司座机、办公地址、公司官网）
- 信息全员共享（所有员工名片显示相同的企业信息）
- 配合显示开关（可单独控制是否显示）

**配置存储**: `workspace.header.company_info`
```json
{
  "phone": "0571-88888888",
  "address": "浙江省杭州市...",
  "website": "https://www.example.com"
}
```

**应用场景**: 解决企微API无法返回企业级联系方式的问题，管理员统一配置后所有员工名片自动显示

### 2025-11-12 工作台稳定性更新
- 管理员工作台在完成企微 OAuth 认证、租户配置与推送配置加载后，才挂载素材库相关子模块（`AssetsContentEditor / AssetsCoverEditor / AssetsLibrary`）。
- 延迟挂载同步 `$wecomAuth` Token，避免初次进入时触发素材接口 401、重复弹窗或重新登录。
- 对管理员无操作成本，仅提升首次加载稳定性。

### API接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/tenant/assets | GET | 素材列表 |
| /api/tenant/assets | POST | 创建素材 |
| /api/tenant/assets/:id | GET | 查看素材 |
| /api/tenant/assets/:id | PUT | 更新素材 |
| /api/tenant/assets/:id | DELETE | 删除素材 |
| /api/tenant/assets/:id | PATCH | 发布/取消发布 |
| /api/public/assets/:tenant_id | GET | 公开素材库（访客访问） |

---

## 11. 运维配置

### 资源配置
- **内存**: 4GB物理内存 + 2GB Swap
- **Swap配置**: `vm.swappiness=10`
- **Nuxt限制**: 1536MB (`--max-old-space-size=1536`)
- **Gunicorn**: 2 worker，每worker约60MB

### Nginx配置
```nginx
# API反向代理
location ^~ /api/ {
  proxy_pass http://127.0.0.1:5001;
  proxy_http_version 1.1;
  proxy_read_timeout 60s;
}

# Nuxt反向代理
location / {
  proxy_pass http://127.0.0.1:3000;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}
```

### 环境变量（.env）
```bash
# 企业微信配置
SUITE_ID=your_suite_id
SUITE_SECRET=your_suite_secret

# 数据库配置
DATABASE_URL=mysql+pymysql://wecard:wecard123@localhost/wecard
REDIS_URL=redis://localhost:6379/0

# JWT配置
JWT_SECRET_KEY=your_jwt_secret
JWT_EXPIRATION=86400

# 文件上传
UPLOAD_FOLDER=/opt/qwcard/uploads
MAX_FILE_SIZE=524288  # 500KB
```

---

## 12. 健康检查

### 自动检查脚本
**位置**: `/opt/qwcard/scripts/health-check.sh`

**检查项**:
- ✅ Gunicorn进程状态
- ✅ Nuxt进程状态
- ✅ API健康接口（/healthz）
- ✅ MySQL连接
- ✅ Redis连接

**Cron配置**:
```bash
# 每5分钟检查一次
*/5 * * * * /opt/qwcard/scripts/health-check.sh >> /var/log/health-check.log 2>&1
```

---

## 13. 当前状态与规划

### 已完成 ✅
- [x] OAuth认证系统（基础登录）
- [x] OAuth授权获取敏感信息（头像获取 ✅）
- [x] 管理员/员工分流（含移动端分流）
- [x] 名片模块框架
- [x] 文件上传系统
- [x] 图标系统（300+）
- [x] 素材库系统
- [x] 套餐限制机制

### 修复中 🔧
- [ ] OAuth获取完整信息（name/mobile/position受企微API限制，待核实应用权限）
- [ ] workspace与card配置互通
- [ ] 大图上传稳定性优化

### 规划中 📋
- [ ] 应用商城上架
- [ ] 套餐付费对接
- [ ] 数据统计模块
- [ ] 访客追踪功能

---

## 14. 常见问题排查

### 502 Bad Gateway
```bash
# 检查后端服务
ps aux | grep gunicorn
curl http://127.0.0.1:5001/healthz

# 检查Nginx配置
nginx -t
cat /var/log/nginx/error.log
```

### 前端白屏
```bash
# 检查Nuxt服务
ps aux | grep nuxt
tail -f /var/log/nuxt-dev.log

# 检查端口
netstat -tuln | grep 3000
```

### OAuth登录失败
```bash
# 检查Redis
redis-cli ping
# 预期: PONG

# 检查环境变量
cat /opt/qwcard/.env | grep SUITE

# 查看日志
tail -f /tmp/gunicorn_error.log | grep OAuth
```

### OAuth授权获取信息失败
**症状**: 授权后头像显示但名称/手机/职位为空

**排查步骤**:
```bash
# 1. 检查数据库授权状态
mysql -u wecard -pwecard123 wecard -e "
SELECT id, userid, name, avatar_url, mobile, position, oauth_authorized 
FROM members WHERE tenant_id=3 ORDER BY oauth_authorized_at DESC LIMIT 3;
"

# 2. 清除授权记录重新测试
mysql -u wecard -pwecard123 wecard -e "
UPDATE members SET oauth_authorized=0, oauth_authorized_at=NULL, user_ticket=NULL 
WHERE tenant_id=3 AND id=你的成员ID;
"

# 3. 启动日志记录并授权
pkill -9 gunicorn
/opt/qwcard/venv/bin/gunicorn -w 2 -b 127.0.0.1:5001 wsgi:application \
  --timeout 120 --graceful-timeout 30 \
  --error-logfile /tmp/gunicorn_error.log --daemon

# 4. 授权后查看API响应
tail -100 /tmp/gunicorn_error.log | grep "getuserdetail3rd完整响应" -A 20
```

**已知限制**:
- 企微第三方应用（普通应用类型）即使使用OAuth授权，`name`/`mobile`/`position`等敏感字段可能仍返回空值
- 这是企微API的权限限制，与代码实现无关
- 头像字段（`avatar`）通常可以正常获取

**解决方案**:
1. 核实企微应用配置中的API权限范围
2. 考虑升级为"通讯录同步应用"（需评估业务影响）
3. 或引导用户在管理后台手动补充信息

---

## 15. 参考文档

| 文档 | 说明 |
|------|------|
| `1.基础架构.md` | 系统基础架构详解 |
| `2、文件上传系统说明.md` | 上传与图标系统 |
| `3、前端界面cc4.5.md` | 前端组件与CSS标准 |
| `4、素材库更新说明.md` | 素材库系统说明 |
| `7.nginx正确指南.md` | Nginx配置指南 |

---

**文档版本**: v2.9  
**维护团队**: WeCard开发组  
**最后更新**: 2024-11-18  
**最后验证**: 2024-11-18 ✅

---

## 16. 更新日志

### v2.9 (2024-11-18)
- ✅ **成员信息管理优化**：明确成员姓名/头像/推送照片的优先级逻辑
  - 成员姓名：display_name（管理员设置）> name（OAuth返回）> userid（兜底）
  - 名片头像：custom_avatar_url（单人）> AvatarEditor（全局）> avatar_url（企微）
  - 推送照片：custom_push_photo_url（单人）> companyAvatar（全局）> avatar_url（企微）
- ✅ **OAuth授权局限性说明**：文档化企微API对第三方应用的限制
  - 企微仅返回头像，姓名/手机/职位通常为空或加密ID
  - 解决方案：管理员在成员管理模块手动设置真实信息
- ✅ **成员管理界面优化**：8列紧凑设计，优化姓名显示和数据来源标识
- ✅ **推送头像配置说明**：明确全局配置（推送设置）vs 单点覆盖（成员管理）

### v2.8 (2025-11-14)
- ✅ OAuth授权获取敏感信息（头像获取成功，姓名/手机受限）
- ✅ 管理员/员工分流（含移动端分流）
- ✅ 成员管理模块：手动编辑成员信息
- ✅ 企业联系信息配置：全员共享的企业级信息

# 企微应用管理员 / 普通用户分流指引
> 更新时间：2025-11-04

## 1. 配置原则

- **单一入口**：企微后台（桌面端与移动端独立主页）统一指向 `https://zjemail.cn/wecom/workspace`，依赖代码逻辑自动分流。
- **自动识别角色**：
  - 安装者（installer）与企业超管（super_admin）留在工作台。
  - 普通可见用户（user）重定向到 `/wecom/card`。
  - 不在可见范围的成员得到明确的权限提示。
- **分享体验隔离**：工作台预览隐藏分享组件；名片端保留完整分享与快速操作。

## 2. 前端行为摘要

| 页面 | 触发条件 | 主要逻辑 |
|------|----------|----------|
| `/wecom/workspace` | OAuth 成功后，调用 `this.$wecomAuth.getUserInfo()` | 若 `is_admin=false`，立即 `replace('/wecom/card')` |
| `/wecom/card` | 所有角色可访问 | 调用 `/card/my` 加载名片；管理员访问同样展示分享能力 |

预览组件 `PreviewPanel` 始终以 `:show-share-panel="false"` 渲染，避免后台展示实际分享控件。

## 3. 后端接口对应关系

- `GET /api/v1/wecom/tenant/workspace` / `PUT ...`：管理员保存后的配置源，当前使用 `workspace` JSON。  
- `GET /api/v1/wecom/card/my`：普通用户加载名片，若成员不存在则自动同步后入库。

> 注意：旧版 `card_template` 仍被接口引用，正在向 `workspace` 数据结构收敛，后续发布时需同步更新。

## 4. 操作与排障

- **企微后台设置**：
  - 桌面 / 移动端独立主页：`https://zjemail.cn/wecom/workspace`
  - 可信域名保持 `zjemail.cn`。
- **常见问题**：
  - 普通用户停留在工作台 → 检查 `Tenant.auth_info` 是否包含该用户或安装事件是否成功写库。
  - 管理员无法访问名片 → 直接访问 `/wecom/card`，接口会返回个人名片且 `role` 字段为 `installer/super_admin`。

## 5. 待办事项

- 与工作台配置统一：完成 `workspace` 与 `card_template` 收敛后更新本指引。
- 成员字段补全：后端需补充 `Member` 的 `wechat`、`avatar` 等字段，避免 `/card/my` 抛错。

> 若需进一步排障，请结合《0.企微认证改造与前端优化建议.md》使用 OAuth 日志与 Redis 工具定位问题。


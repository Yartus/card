# æœåŠ¡å•†ç®¡ç†åå°é…ç½®æŒ‡å—

> æ›´æ–°æ—¶é—´ï¼š2025-10-13  
> é€‚ç”¨å¯¹è±¡ï¼šWeCard SaaSå¹³å°æœåŠ¡å•†

---

## ğŸ“‹ æœåŠ¡å•†çš„ä¸‰é‡èº«ä»½

### 1. **ä½œä¸ºSaaSæœåŠ¡å•†**
- ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·çš„ä½¿ç”¨æƒ…å†µ
- æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡æ•°æ®
- ç›‘æ§èµ„æºå ç”¨

**è®¿é—®æ–¹å¼ï¼š** `/admin` ï¼ˆéœ€è¦è´¦å·å¯†ç ç™»å½•ï¼‰

### 2. **ä½œä¸ºæ™®é€šç§Ÿæˆ·**
- è‡ªå·±ä¹Ÿæ‰«ç å®‰è£…åº”ç”¨
- ä½¿ç”¨åç‰‡å·¥ä½œå°åŠŸèƒ½
- ä¸å…¶ä»–ç§Ÿæˆ·äº«æœ‰åŒç­‰æƒé™

**è®¿é—®æ–¹å¼ï¼š** ä¼å¾®å·¥ä½œå°æ‰“å¼€åº”ç”¨

### 3. **ä½œä¸ºç³»ç»Ÿå¼€å‘è€…**
- ç®¡ç†ç³»ç»Ÿé…ç½®ï¼ˆ`.env`æ–‡ä»¶ï¼‰
- éƒ¨ç½²å’Œç»´æŠ¤æœåŠ¡å™¨
- å¼€å‘æ–°åŠŸèƒ½

---

## ğŸ” æœåŠ¡å•†åå°ç™»å½•

### è®¿é—®åœ°å€

```
https://zjemail.cn/login
```

### é»˜è®¤è´¦å·ï¼ˆâš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰

```
ç”¨æˆ·åï¼šadmin
å¯†ç ï¼šadmin123
```

### å®‰å…¨é…ç½®ï¼ˆé‡è¦ï¼ï¼‰

#### 1. ç”Ÿæˆå®‰å…¨çš„å¯†ç hash

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨Python
python3 << 'EOF'
import hashlib
password = input("è¾“å…¥æ–°å¯†ç : ")
hash = hashlib.sha256(password.encode()).hexdigest()
print(f"\nå¯†ç Hash: {hash}")
print(f"\nè¯·åœ¨.envæ–‡ä»¶ä¸­æ·»åŠ ï¼š\nPROVIDER_ADMIN_PASSWORD_HASH={hash}")
EOF

# æ–¹æ³•2ï¼šä½¿ç”¨APIä¿®æ”¹å¯†ç ï¼ˆé¦–æ¬¡ç™»å½•åï¼‰
curl -X POST https://zjemail.cn/api/auth/change-password \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"old_password":"admin123","new_password":"ä½ çš„æ–°å¯†ç "}'
```

#### 2. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `/opt/qwcard/.env` æ–‡ä»¶ï¼Œæ·»åŠ ï¼š

```bash
# æœåŠ¡å•†ç®¡ç†å‘˜é…ç½®
PROVIDER_ADMIN_USERNAME=admin
PROVIDER_ADMIN_PASSWORD_HASH=<your_password_hash>
PROVIDER_JWT_SECRET=<éšæœºç”Ÿæˆçš„å¯†é’¥>
```

ç”Ÿæˆéšæœºå¯†é’¥ï¼š

```bash
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

#### 3. é‡å¯æœåŠ¡

```bash
systemctl restart wecard-api.service
```

---

## ğŸ¯ æœåŠ¡å•†åå°åŠŸèƒ½

### 1. ç§Ÿæˆ·ç®¡ç†

**é¡µé¢ï¼š** `/admin`

**åŠŸèƒ½ï¼š**
- âœ… æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·åˆ—è¡¨
- âœ… ç§Ÿæˆ·æœç´¢ï¼ˆæŒ‰ä¼ä¸šåç§°/CorpIDï¼‰
- âœ… æŸ¥çœ‹ç§Ÿæˆ·è¯¦æƒ…ï¼ˆæˆå‘˜æ•°ã€ç´ ææ•°ã€è®¿é—®é‡ï¼‰
- âœ… æŸ¥çœ‹å­˜å‚¨å ç”¨æƒ…å†µ
- âœ… æŸ¥çœ‹æœ€è¿‘åŒæ­¥æ—¶é—´

**ç»Ÿè®¡æ•°æ®ï¼š**
- ç§Ÿæˆ·æ€»æ•°
- è¿‘30å¤©æ´»è·ƒç§Ÿæˆ·
- ç´¯è®¡è®¿é—®é‡
- ç´ ææ€»æ•°
- é¢„è®¡å­˜å‚¨å ç”¨

### 2. ç§Ÿæˆ·è¯¦æƒ…

**é¡µé¢ï¼š** `/admin/tenant/{tenant_id}`

**åŠŸèƒ½ï¼š**
- âœ… æŸ¥çœ‹ç§Ÿæˆ·åŸºæœ¬ä¿¡æ¯
- âœ… æŸ¥çœ‹æˆå‘˜åˆ—è¡¨
- âœ… æŸ¥çœ‹ç´ æåº“
- âœ… æŸ¥çœ‹è®¿é—®æ—¥å¿—
- âœ… å¥—é¤ç®¡ç†

### 3. æµ‹è¯•ä¸­å¿ƒ

**é¡µé¢ï¼š** `/admin/test-center`

**åŠŸèƒ½ï¼š**
- âœ… åˆ›å»ºæµ‹è¯•ç§Ÿæˆ·
- âœ… é¢„è§ˆåç‰‡
- âœ… æŸ¥çœ‹ç´ æåº“
- âœ… æµ‹è¯•åˆ†äº«åŠŸèƒ½

---

## ğŸ”§ APIæ¥å£æ–‡æ¡£

### è®¤è¯æ¥å£

#### ç™»å½•

```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "your_password"
}
```

**å“åº”ï¼š**

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 604800,
  "user": {
    "username": "admin",
    "role": "provider_admin",
    "name": "æœåŠ¡å•†ç®¡ç†å‘˜"
  }
}
```

#### è·å–ç”¨æˆ·ä¿¡æ¯

```http
GET /api/auth/user
Authorization: Bearer <token>
```

#### ä¿®æ”¹å¯†ç 

```http
POST /api/auth/change-password
Authorization: Bearer <token>
Content-Type: application/json

{
  "old_password": "admin123",
  "new_password": "new_secure_password"
}
```

#### é€€å‡ºç™»å½•

```http
POST /api/auth/logout
Authorization: Bearer <token>
```

### ç§Ÿæˆ·ç®¡ç†æ¥å£

#### è·å–ç§Ÿæˆ·åˆ—è¡¨

```http
GET /api/admin/tenants?page=1&page_size=20&keyword=æœç´¢å…³é”®è¯
Authorization: Bearer <token>
```

**å“åº”ï¼š**

```json
{
  "tenants": [
    {
      "id": 1,
      "company_name": "å¾®é‚®ç§‘æŠ€",
      "corp_id": "ww123456",
      "plan": "trial",
      "member_count": 10,
      "asset_count": 25,
      "views_last_30d": 150,
      "storage_used_bytes": 5242880,
      "last_synced_at": "2025-10-13T10:00:00"
    }
  ],
  "pagination": {
    "page": 1,
    "pages": 5,
    "per_page": 20,
    "total": 100,
    "has_prev": false,
    "has_next": true
  },
  "summary": {
    "total_tenants": 100,
    "active_last_30d": 80,
    "total_views": 10000,
    "total_assets": 500,
    "storage_used_bytes": 524288000
  }
}
```

---

## ğŸ“Š æœåŠ¡å•†ä½œä¸ºç§Ÿæˆ·ä½¿ç”¨

### å®‰è£…åº”ç”¨

1. ç™»å½•ä¼å¾®æœåŠ¡å•†åå°
2. æ‰¾åˆ°"æµ™é‡Œæœ‰é‚®æ•°å­—åç‰‡"åº”ç”¨
3. ä½¿ç”¨è‡ªå·±çš„ä¼ä¸šæ‰«ç å®‰è£…

### ä½¿ç”¨æµç¨‹

```
æœåŠ¡å•†æ‰«ç å®‰è£…åº”ç”¨
    â†“
åˆ›å»ºç§Ÿæˆ·è®°å½•ï¼ˆä¸å…¶ä»–ç§Ÿæˆ·ç›¸åŒï¼‰
    â†“
æœåŠ¡å•†æˆä¸ºinstallerï¼ˆç®¡ç†å‘˜ï¼‰
    â†“
ä»ä¼å¾®å·¥ä½œå°æ‰“å¼€åº”ç”¨
    â†“
è¿›å…¥ /wecom/workspace ç¼–è¾‘å·¥ä½œå°
    â†“
é…ç½®è‡ªå·±ä¼ä¸šçš„åç‰‡æ¨¡ç‰ˆ
    â†“
æ™®é€šæˆå‘˜æŸ¥çœ‹åç‰‡
```

### ä¸å…¶ä»–ç§Ÿæˆ·çš„åŒºåˆ«

**ç›¸åŒç‚¹ï¼š**
- âœ… å®Œå…¨ç›¸åŒçš„å®‰è£…æµç¨‹
- âœ… å®Œå…¨ç›¸åŒçš„åŠŸèƒ½æƒé™
- âœ… å®Œå…¨ç›¸åŒçš„ç•Œé¢ä½“éªŒ
- âœ… æ•°æ®ç‹¬ç«‹éš”ç¦»

**ä¸åŒç‚¹ï¼š**
- âœ… æœåŠ¡å•†å¯ä»¥è®¿é—®`/admin`åå°
- âœ… æœåŠ¡å•†å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·æ•°æ®
- âŒ æ™®é€šç§Ÿæˆ·çœ‹ä¸åˆ°`/admin`å…¥å£

---

## ğŸ”’ æƒé™ä½“ç³»

### æœåŠ¡å•†ç®¡ç†å‘˜

**æ ‡è¯†ï¼š**
- JWT Tokenä¸­åŒ…å« `type: 'provider_admin'`
- è§’è‰²ï¼š`provider_admin`

**æƒé™ï¼š**
- âœ… è®¿é—®`/admin`åå°
- âœ… æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·æ•°æ®
- âœ… æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡
- âœ… ç®¡ç†å¥—é¤å’Œæƒé™ï¼ˆæœªæ¥ï¼‰

### ç§Ÿæˆ·ç®¡ç†å‘˜ï¼ˆinstaller/super_adminï¼‰

**æ ‡è¯†ï¼š**
- JWT Tokenä¸­åŒ…å« `is_admin: true`
- è§’è‰²ï¼š`installer` æˆ– `super_admin`

**æƒé™ï¼š**
- âœ… è®¿é—®`/wecom/workspace`å·¥ä½œå°
- âœ… é…ç½®åç‰‡æ¨¡ç‰ˆ
- âœ… é…ç½®æ¨é€è®¾ç½®
- âŒ æ— æ³•è®¿é—®`/admin`ï¼ˆé™¤éåŒæ—¶æ˜¯æœåŠ¡å•†ï¼‰

### ç§Ÿæˆ·æ™®é€šç”¨æˆ·

**æ ‡è¯†ï¼š**
- JWT Tokenä¸­åŒ…å« `is_admin: false`
- è§’è‰²ï¼š`user`

**æƒé™ï¼š**
- âœ… è®¿é—®`/wecom/card`æŸ¥çœ‹åç‰‡
- âœ… åˆ†äº«åç‰‡
- âŒ æ— æ³•è®¿é—®`/wecom/workspace`
- âŒ æ— æ³•è®¿é—®`/admin`

---

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 1. åç«¯æœåŠ¡

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status wecard-api.service

# æŸ¥çœ‹æ—¥å¿—
journalctl -u wecard-api.service -f

# æµ‹è¯•API
curl http://127.0.0.1:5001/healthz
```

### 2. å‰ç«¯æœåŠ¡

```bash
# æ£€æŸ¥NuxtæœåŠ¡
netstat -tlnp | grep 3000

# è®¿é—®ç™»å½•é¡µé¢
curl -I https://zjemail.cn/login
```

### 3. å®‰å…¨é…ç½®

- [ ] ä¿®æ”¹é»˜è®¤å¯†ç 
- [ ] é…ç½®PROVIDER_ADMIN_PASSWORD_HASH
- [ ] é…ç½®PROVIDER_JWT_SECRET
- [ ] è®¾ç½®.envæ–‡ä»¶æƒé™ä¸º600
- [ ] é…ç½®HTTPSè¯ä¹¦

### 4. åŠŸèƒ½æµ‹è¯•

- [ ] ç™»å½•æœåŠ¡å•†åå°
- [ ] æŸ¥çœ‹ç§Ÿæˆ·åˆ—è¡¨
- [ ] æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
- [ ] ä¿®æ”¹å¯†ç åŠŸèƒ½
- [ ] é€€å‡ºç™»å½•
- [ ] ä½œä¸ºç§Ÿæˆ·æ‰«ç å®‰è£…åº”ç”¨
- [ ] æµ‹è¯•workspaceç¼–è¾‘åŠŸèƒ½

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: å¿˜è®°å¯†ç æ€ä¹ˆåŠï¼Ÿ

**æ–¹æ³•1ï¼šé‡ç½®ä¸ºé»˜è®¤å¯†ç **

ç¼–è¾‘`.env`ï¼Œæ³¨é‡Šæˆ–åˆ é™¤`PROVIDER_ADMIN_PASSWORD_HASH`ï¼Œç³»ç»Ÿä¼šä½¿ç”¨é»˜è®¤å¯†ç `admin123`ã€‚

**æ–¹æ³•2ï¼šç”Ÿæˆæ–°å¯†ç hash**

```bash
python3 << 'EOF'
import hashlib
password = "your_new_password"
print(hashlib.sha256(password.encode()).hexdigest())
EOF
```

å°†è¾“å‡ºçš„hashæ·»åŠ åˆ°`.env`çš„`PROVIDER_ADMIN_PASSWORD_HASH`ã€‚

### Q2: æœåŠ¡å•†åå°ä¸ä¼å¾®å·¥ä½œå°çš„åŒºåˆ«ï¼Ÿ

| åŠŸèƒ½ | æœåŠ¡å•†åå° (`/admin`) | ä¼å¾®å·¥ä½œå° (`/wecom/*`) |
|------|---------------------|---------------------|
| è®¿é—®æ–¹å¼ | è´¦å·å¯†ç ç™»å½• | ä¼å¾®OAuthè®¤è¯ |
| æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ· | âœ… | âŒ |
| ç³»ç»Ÿç»Ÿè®¡ | âœ… | âŒ |
| é…ç½®è‡ªå·±çš„åç‰‡ | âŒ | âœ… |
| ç¼–è¾‘åç‰‡æ¨¡ç‰ˆ | âŒ | âœ…ï¼ˆä»…è‡ªå·±ä¼ä¸šï¼‰ |

### Q3: å¦‚ä½•åŒæ—¶ä½œä¸ºæœåŠ¡å•†å’Œç§Ÿæˆ·ï¼Ÿ

1. **ç™»å½•æœåŠ¡å•†åå°**ï¼šè®¿é—®`https://zjemail.cn/login`
2. **å®‰è£…ä¼å¾®åº”ç”¨**ï¼šç”¨è‡ªå·±çš„ä¼ä¸šæ‰«ç å®‰è£…
3. **ä½¿ç”¨ä¼å¾®åŠŸèƒ½**ï¼šä»ä¼å¾®å·¥ä½œå°æ‰“å¼€åº”ç”¨

ä¸¤ä¸ªèº«ä»½äº’ä¸å¹²æ‰°ï¼Œåˆ†åˆ«ç®¡ç†ã€‚

### Q4: æ™®é€šç§Ÿæˆ·èƒ½çœ‹åˆ°æœåŠ¡å•†åå°å—ï¼Ÿ

âŒ ä¸èƒ½ã€‚æ™®é€šç§Ÿæˆ·ï¼š
- æ— æ³•è®¿é—®`/login`é¡µé¢ï¼ˆæ²¡æœ‰è´¦å·ï¼‰
- æ— æ³•è®¿é—®`/admin`ï¼ˆä¼šè¢«middlewareæ‹¦æˆªï¼‰
- åªèƒ½ä½¿ç”¨ä¼å¾®OAuthè®¤è¯è®¿é—®è‡ªå·±çš„åŠŸèƒ½

---

## ğŸ” å®‰å…¨å»ºè®®

1. **å¼ºå¯†ç ç­–ç•¥**
   - å¯†ç é•¿åº¦è‡³å°‘12ä½
   - åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
   - å®šæœŸä¿®æ”¹å¯†ç ï¼ˆå»ºè®®3ä¸ªæœˆï¼‰

2. **ç½‘ç»œå®‰å…¨**
   - å¯ç”¨HTTPS
   - é…ç½®é˜²ç«å¢™
   - é™åˆ¶`/admin`è®¿é—®IPï¼ˆå¯é€‰ï¼‰

3. **æ—¥å¿—å®¡è®¡**
   - å®šæœŸæŸ¥çœ‹ç™»å½•æ—¥å¿—
   - ç›‘æ§å¼‚å¸¸è®¿é—®
   - å¤‡ä»½é‡è¦æ•°æ®

4. **ç¯å¢ƒå˜é‡ä¿æŠ¤**
   ```bash
   chmod 600 /opt/qwcard/.env
   ```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- å¼€å‘è€…ï¼šClaude Sonnet 4.5
- æ–‡æ¡£æ›´æ–°ï¼š2025-10-13


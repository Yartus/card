# WeCard 素材库系统说明

> **版本**: v3.1（三Tab架构 + 网店直达块）  
> **更新**: 2025-01-XX  
> **状态**: ✅ 已完成重构并部署

---

## 📋 核心能力速览

### v3.1 新功能
- ✅ **网店直达块**: 支持电商平台APP唤醒和微信小程序唤醒
- ✅ **内容块排序优化**: 按时间顺序，网店直达块固定最后位置
- ✅ **保存功能扩展**: 右上角保存按钮支持素材库保存

### v3.0 新架构
- ✅ **三Tab职能分离**: 内容生成 / 推送设置 / 素材列表
- ✅ **统一右侧预览**: 根据tab自动切换三种视图
- ✅ **Vuex状态同步**: 编辑区与预览区实时同步
- ✅ **批量封面生成**: 支持批量操作+节流保护
- ✅ **增强安全提示**: Token/配额/频率错误明确提示

### 基础功能
- ✅ 图文/亮点块混排（段落式编辑）
- ✅ 封面单独上传 + 即时压缩（16:9，500KB）
- ✅ 亮点列数 2/3 切换（桌面→移动自动降级）
- ✅ 租户隔离 / 套餐配额 / 上传频控
- ✅ 旧版数据自动转 blocks + metadata

---

## 🏗️ 技术架构

### 前端组件（v3.0架构）
```
store/
└── assetEditor.js             # Vuex状态管理

components/workspace/
├── AssetsContentEditor.vue    # Tab 1: 素材内容生成（全屏表单）
├── AssetsCoverEditor.vue      # Tab 2: 推送设置（封面生成）【新建】
├── AssetsLibrary.vue          # Tab 3: 素材列表（统计管理）
├── AssetsPreviewPanel.vue     # 统一右侧预览【新建】
└── form/
    ├── BlockEditor.vue        # 段落式块编辑器
    └── ShopDirectBlockEditor.vue  # 网店直达块配置组件【新增】

components/card/
├── AssetPreview.vue           # 预览渲染（blocks渲染）
└── ShopDirectBlock.vue        # 网店直达块展示组件【新增】

utils/
└── shop-handler.js            # 网店唤醒工具（复用名片模块）

pages/wecom/
└── workspace.vue              # 主页面集成
```

### 后端接口
```
/api/tenant/assets             # 列表/创建
/api/tenant/assets/:id         # 查看/更新/删除
/api/v1/files/upload           # 文件上传
```

### 数据库表
```sql
tenant_assets              # 素材主表 (tenant_id: int)
asset_analytics            # 访问统计 (tenant_id: int)
asset_categories           # 分类管理 (tenant_id: int)
asset_library_settings     # 租户配置 (tenant_id: int)
```

---

## 🎨 素材内容生成工作台

### 布局
- 左列：模块化表单（基础信息 / 封面 / 图文 / 亮点 / 操作）
- 右列：粘性实时预览（分享卡片 + 详细内容）
- 样式遵循 `3、前端界面cc4.5.md`：白底、12px 圆角、标准阴影

### 内容块排序规则
- **时间顺序**：先添加的内容块显示在上面，后添加的显示在下面
- **网店直达固定位置**：网店直达块始终在最后，作为标准结尾
- **拖拽限制**：网店直达块只能放在最后位置，其他块不能移动到网店直达块之后

### 支持的块类型

#### 1. 📝 文字块
- 多行文本输入
- 自动换行

#### 2. 🖼 图片块
- 图片上传（压缩到500KB）
- 说明文字
- 圆角+阴影

#### 3. 💡 数据亮点块
- 标签+数值
- 图标选择（Emoji/SVG/CSS）
- 渐变背景

#### 4. 🛒 网店直达块（新增）
- **功能**：展示企业网店链接，支持APP唤醒和微信小程序唤醒
- **支持平台**：
  - 电商平台（APP唤醒）：天猫、京东、拼多多、1688、淘宝、自定义
  - 微信生态（小程序唤醒）：微信小程序、微信小店
- **套餐限制**：free/trial 2个，pro/enterprise 3个
- **特殊规则**：
  - 每个素材只允许一个网店直达块
  - 网店直达块始终位于内容块最后（标准结尾）
  - 其他内容块自动插入到网店直达块之前
- **数据存储**：`block.data.shops` 数组，包含平台、图片、链接等配置
- **唤醒逻辑**：复用 `shop-handler.js`，支持APP深度链接、小程序URL Scheme、H5降级

### 套餐限制（与名片系统对齐）

| 套餐 | 最大块数 | 最大图片 | 数据亮点 |
|------|---------|---------|---------|
| free | 10 | 5 | 3 |
| trial | 15 | 8 | 8 |
| pro | 20 | 10 | 10 |
| enterprise | 30 | 20 | 15 |

**配额对齐**：
- 图片数量 = 多媒体展示模块
- 数据亮点 = 企业简介模块

### 安全控制
- 统一 `upload-security-mixin`：频率冷却 2s / 批量配额 / 白名单 MIME
- 封面与图片块复用 Canvas 压缩（1200px，JPEG 0.75，≤500KB）
- Token 兜底：`$wecomAuth` 缺失时回退 Vuex `auth.token`
- 实时提示频率/配额/大小（Toast）

### 素材库链接系统

**两种链接类型**：

#### 1. 整体素材库链接
- **格式**：`/assets/{tenantId}`
- **示例**：`https://zjemail.cn/assets/1`
- **用途**：配置到企业微信聊天侧边栏，员工可快速访问整个素材库
- **生成位置**：
  - `workspace.vue`：`assetLibraryUrl` 计算属性
  - `AssetsLibrary.vue`：`libraryUrl` 计算属性
  - `AssetsPreviewPanel.vue`：`libraryUrl` 计算属性
- **数据来源**：统一使用 `workspace.tenantInfo.id`

#### 2. 单个素材链接
- **格式**：`/assets/{tenantId}#asset-{assetId}`
- **示例**：`https://zjemail.cn/assets/1#asset-123`
- **用途**：独立分享单个素材，点击后跳转到素材库页面并定位到该素材
- **生成位置**：
  - `AssetsLibrary.vue`：`copyAssetLink`、`previewAsset` 方法
  - `AssetsCoverEditor.vue`：`getShareUrl` 方法
  - `pages/assets/_tenant_id.vue`：`handleShare` 方法
- **实现方式**：使用锚点（hash）定位，无需独立路由

**统一规范**：
- 所有组件统一使用 `workspace.tenantInfo.id` 获取租户ID
- 单个素材链接统一使用锚点格式，保持一致性
- 前端路由：`pages/assets/_tenant_id.vue` 处理素材库页面和锚点定位

---

## 🔐 租户隔离

### 三层架构
```
服务商（您）
  └── 租户（企业，corp_id）
       └── 员工（Member，userid）
            └── 素材（TenantAsset，tenant_id）
```

### 数据隔离
```python
# API层：从JWT提取tenant_id
tenant_id = verify_jwt_token(request)

# 数据库层：强制过滤
assets = TenantAsset.query.filter_by(
    tenant_id=tenant_id
).all()

# 外键约束
FOREIGN KEY (tenant_id) REFERENCES tenants(id)
```

---

## 🛠 关键修复（v2.4）

### 新增：实时预览架构（v2.5）
- `AssetsContentEditor.vue`：拆分基础信息/封面/内容/亮点模块，实时触发预览
- 新增亮点列数选择（2/3）→ metadata.highlightColumns → 预览同步
- Share Card 预览添加封面卡片头（点击率关键）

### 已落地修复回顾
- `member.avatar` → `member.avatar_url`，`member.wechat` 置空
- `tenant_id` 全表统一 `Integer` + 外键校验
- `metadata` 字段映射 → 模型 `meta_data`，API 仍返回 `metadata`
- `status` Enum：`draft / published / active / inactive`

---

## 🔄 数据兼容

### 数据结构
- metadata.blocks：text / image / highlight / shop-direct
- metadata.highlightColumns：2 或 3（默认 3）
- shop-direct 块数据：`block.data.shops` 数组，包含平台、图片、链接等
- legacy 字段（content/detailImages）继续回写，保障旧客户端

---

## 📋 部署清单

1. **数据库**：补充 `tenant_assets` / `asset_analytics` 等迁移（INT 外键、meta_data）
2. **后端**：确认 `app/main.py` 已注册 `assets_bp` → 重启 WSGI 服务
3. **前端**：重新构建/刷新企业微信工作台缓存

---

## 🧪 测试清单

1. 创建 → 配置封面 → 添加文字/图片/亮点 → 选择 2/3 列 → 保存
2. 列表弹窗编辑（旧路径）确认亮点列数可回显
3. 发布/取消发布 + 链接复制
4. 上传压力测试：快速上传/超限/超大文件
5. 多租户验证：租户 A/B 数据隔离
6. 企微 H5 真机预览：封面、自适应栅格、分享卡片
7. **网店直达块测试**：
   - 添加网店直达块，验证自动置底
   - 配置多个网店（不同平台），验证套餐限制
   - 拖拽测试：验证网店直达块只能放在最后
   - 唤醒测试：验证APP/小程序唤醒功能

---

## 📁 核心文件

### 前端
- `components/workspace/AssetsContentEditor.vue`
- `components/workspace/AssetsLibrary.vue`
- `components/workspace/AssetEditorModal.vue`
- `components/workspace/form/BlockEditor.vue`
- `components/workspace/form/ShopDirectBlockEditor.vue` - 网店直达块配置
- `components/card/ShopDirectBlock.vue` - 网店直达块展示
- `components/workspace/config/upload-security-mixin.js`
- `utils/shop-handler.js` - 网店唤醒工具（复用）

### 后端
- `app/asset_models.py` - 数据模型
- `app/routes/assets.py` - API路由
- `app/main.py` - 路由注册

### 数据库
- `migrations/versions/001_create_asset_library_tables.sql`

---

## ⚠️ 常见问题

**Q: Table doesn't exist**  
A: 运行SQL建表脚本

**Q: AttributeError: metadata**  
A: 已修复，使用 `meta_data` 字段

**Q: 外键约束错误**  
A: 已修复，`tenant_id` 统一为 `INT`

**Q: API返回404**  
A: 检查 `app/main.py` 是否注册 `assets_bp`

---

## 📝 更新日志

### v3.1 (2025-01-XX)
- ✅ 新增网店直达块：支持电商平台APP唤醒和微信小程序唤醒
- ✅ 内容块排序优化：按时间顺序，网店直达块固定最后位置
- ✅ 拖拽限制：网店直达块只能放在最后，其他块不能移动到其后
- ✅ 右上角保存按钮扩展：支持素材库保存功能
- ✅ 错误处理优化：素材库组件延迟加载，静默处理错误
- ✅ **素材库链接统一**：修复整体素材库链接和单个素材链接格式，统一使用 `workspace.tenantInfo.id`，单个素材链接使用锚点格式

### v2.5 (2025-11-05)
- ✅ 新增 AssetsContentEditor（左右分栏 + 实时预览）
- ✅ AssetPreview 支持封面 + 亮点栅格
- ✅ 亮点列数 2/3 切换写入 metadata
- ✅ 上传链路追加 token 兜底

### v2.2 (2025-11-05)
- ✅ 富文本编辑器完成
- ✅ 租户隔离机制
- ✅ 套餐限制配置

---

**维护团队**: WeCard开发组  
**最后验证**: 2025-11-05 ✅

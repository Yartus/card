# WeCard 数据安全需求与下一步规划

## 1. 当前进度概览
- 企业微信扫码安装链路已可用，正在计划开展真实企业测试。
- 名片与素材库模块已上线管理后台、展示端和基础 API，但文件上传仍采用默认逻辑。
- 文件大小限制、类型校验、哈希去重、病毒扫描、转码压缩等安全/性能措施尚未实现。

## 2. 现有风险梳理
- **类型校验缺失**：上传接口缺乏扩展名白名单与 MIME 检测，存在脚本/可执行文件注入风险。
- **病毒扫描缺位**：文件落盘后未进行安全扫描，难以及时阻断恶意内容。
- **尺寸与配额控制不足**：仅有默认 `100MB` 上传上限，没有区分图片/文档/视频或租户级配额。
- **存储路径未隔离**：上传位置未按租户拆分，可能被枚举访问。
- **媒体体积未优化**：缺少图片压缩、视频转码，影响加载体验与存储成本。
- **审计与告警不足**：没有针对异常上传、扫描结果或空间超限的日志与预警机制。

## 2.1 数据库与存储现状补充
- **运行时环境**：已在本机安装 MySQL 8.0（`systemd` 常驻），默认库 `wecard`
- **访问账号**：`wecard/wecard123@127.0.0.1`，`root` 改为密码登录，禁止匿名；需在 `.env` 或服务配置中设置 `DATABASE_URL="mysql+pymysql://wecard:wecard123@127.0.0.1:3306/wecard"`
- **结构初始化**：完成 Alembic 迁移 `d84d888ccc59_init_schema`，落库以下核心表：
  - `tenants`：企业身份、套餐信息、permanent_code
  - `members`：成员映射，含 `tenant_id + userid` 唯一约束
  - `card_templates`：租户模版 JSON
  - `file_assets`：素材文件元数据（bucket/object_key/size/md5）
  - `card_logs`：访问与推送行为日志
- **后续扩展字段**：按本文档阶段 B 规划，为 `tenants` 增补 `storage_quota_bytes`、`storage_used_bytes`，同时在素材/日志表中补全 `data_region`、扫描状态位
- **迁移流程**：`flask db init → migrate → upgrade`；新节点部署时执行 `venv/bin/flask db upgrade` 确保结构一致
- **安全控制**：生产环境须关闭 `%` 访问账号，仅允许内网白名单；定期执行 `mysqldump` 与对象存储快照
- **监控检查点**：
  - 自动巡检 `information_schema.tables`，确保关键表存在
  - 统计 `file_assets.size` 汇总与对象存储对账
  - 关注 `card_logs` 增量以触发行为审计与告警

## 2.2 服务商租户监控入口补充
- **后台入口**：新增 `pages/admin/index.vue`（服务商控制台）+ `pages/admin/tenant/_id.vue`（租户详情），默认账户登录后访问 `/admin` 即可查看全部租户概览
- **后端接口**：`GET /api/admin/tenants` 支持分页、关键词检索，返回租户基础信息、成员/素材统计、近30天访问与存储占用；`GET /api/admin/tenants/<id>` 提供单租户详情、成员列表、最近访问日志
- **统计口径**：
  - 成员/素材数量通过 `members`、`file_assets` 聚合
  - 访问量取 `card_logs` 中 `page_view` 事件，按 MySQL `DATE_SUB(NOW(), INTERVAL 30 DAY)` 计算活跃租户数
  - 存储占用基于 `file_assets.size` 汇总（未来结合对象存储真实数据校验）
- **安全措施**：接口挂载在服务商专属后台（需平台运营权限），建议增加鉴权中间件 + 操作日志；生产环境配置速率限制、防爬虫策略
- **运维检查点**：后台面板展示租户活跃度、上传配额、最近同步时间，帮助数据安全巡检（异常访问/超额存储可触发告警）

## 3. 近期目标（扫码安装测试同步推进）
1. **完成企业微信扫码安装与功能回归**：验证授权流程、名片/素材分享链路。
2. **沉淀安全需求清单**：确保后续开发按以下优先级推进。

## 4. 分阶段实施规划

### 阶段 A：核心上传安全
- 实现 `validate_file` 与 `upload_file`：
  - 统一读取配置的大小上限（图片 ≤5MB、视频 ≤100MB、文档 ≤20MB）。
  - 维护扩展名白名单，结合 `python-magic` 检测 MIME。
  - 计算 SHA256，写入数据库避免重复；返回规范化错误码。
- 配置网关限制：更新 Flask `MAX_CONTENT_LENGTH` 与 Nginx `client_max_body_size`。
- 前端对接：上传弹窗显示具体限额与错误提示。

### 阶段 B：配额与存储治理
- `tenants` 表新增 `storage_quota_bytes`、`storage_used_bytes` 字段。
- 上传前校验剩余空间，超限时阻断并提示升级。
- 定时任务统计 S3/MinIO 实际体积，与数据库对账并写入审计日志。

### 阶段 C：媒体处理与防护
- 图片：Pillow 或 libvips 压缩为 WebP（quality 85~90），长边限制 2000px；生成多尺寸。
- 视频：FFmpeg 转码为 H.264/H.265，分辨率上限 1080p；生成封面缩略图。
- 异步化：搭建 Celery + Redis 队列，所有压缩/转码/扫描任务在 Worker 中执行。
- 病毒扫描：接入 ClamAV 或安全网关 API，扫描结果写回 `TenantAsset` 状态。

### 阶段 D：套餐与商业化支持
- 在套餐配置中定义存储空间、上传类型、转码能力差异。
- 管理后台展示容量占用、转码进度、扫描结果；支持手动重试。
- 构建升级流程与费用策略（可与企业微信付费流程对接）。

## 5. 对测试阶段的要求
- 在企业微信中完成扫码安装后，重点记录以下反馈：
  - 名片/素材库分享是否能正常展示缩略图与口号。
  - 上传图片/视频/文档的实际体积、性能体感、用户错误提示。
  - 是否遇到非法文件上传或重复素材的运营痛点。
- 根据测试反馈调整安全策略的优先级，例如先实现图片压缩与尺寸限制。

## 6. 依赖与支持清单
- **后端依赖**：`python-magic`、Pillow/libvips、FFmpeg、ClamAV、Celery、Redis/消息队列客户端。
- **运维**：
  - `docker-compose` 增加 Redis、ClamAV、Celery Worker、FFmpeg 可执行环境。
  - 对象存储策略调整（按租户划分 bucket 或前缀）。
  - Nginx/Flask 配置同步更新。
- **前端**：更新 `AssetUploadModal`、素材管理页的状态展示与错误提示。
- **前端改为生产模式**：执行 `npm run build` + `npm run start`，关闭 HMR/watch，大幅降低内存峰值
- **限制 Node 内存**：启动脚本增加 `NODE_OPTIONS=--max-old-space-size=1536`，防止 Nuxt 占满 4 GB 内存
- **启用 Vuex Store**：新增 `store/index.js` 空 Store（`state`/`mutations`），满足 `@nuxtjs/auth` 对 Vuex 的依赖，消除启动 WARN，保证租户登录重定向正常
- **企业微信授权落库**：`/api/v1/wecom/auth` 已改为真实 API，调用企业微信 `get_suite_token` / `get_permanent_code` / `get_auth_info`，并写入 `tenants` 表；所有关键错误（缺配置/HTTP失败/DB提交失败）均记到 `current_app.logger`
- **前端 API 适配**：`axios.baseURL` 改为 `/`（默认走同源反代），避免浏览器访问本地 `localhost`；确保 Nginx `/api/` 已正确代理到 Flask
- **启用 Swap**：`fallocate -l 2G /swapfile && chmod 600 /swapfile && mkswap /swapfile && swapon /swapfile`

## 7. 里程碑建议
- **M1**：扫码安装与核心功能测试完成，安全需求文档冻结。
- **M2**：阶段 A/B 功能上线，完成首轮安全审计。
- **M3**：阶段 C 完成并打通异步处理链路。
- **M4**：套餐策略与商业化能力上线，形成持续运营闭环。

> 本文档将随企业微信测试结果与安全能力落地情况持续更新。



# 快速开始 - 服务商管理后台

> 5分钟快速配置指南

---

## ✅ 完成情况总结

### 已实现功能

1. ✅ **服务商登录系统**
   - 页面：`/login`
   - API：`/api/auth/login`, `/api/auth/user`, `/api/auth/logout`
   - 默认账号：`admin` / `admin123`

2. ✅ **租户管理后台**
   - 页面：`/admin`
   - 查看所有租户列表
   - 查看系统统计数据
   - 搜索租户

3. ✅ **三重身份支持**
   - 服务商管理员（`/admin`）
   - 租户管理员（`/wecom/workspace`）
   - 普通用户（`/wecom/card`）

---

## 🚀 立即使用

### 1. 访问服务商后台

```
URL: https://zjemail.cn/login
用户名：admin
密码：admin123
```

### 2. 查看租户列表

登录后自动跳转到 `https://zjemail.cn/admin`

### 3. 作为租户使用应用

从企微工作台打开"浙里有邮数字名片"，正常使用所有功能。

---

## 🔐 安全配置（重要！）

### 修改默认密码

**生成新密码hash：**

```bash
cd /opt/qwcard
python3 << 'EOF'
import hashlib
import secrets

# 设置新密码
new_password = "your_strong_password_here"  # 修改这里

# 生成hash
password_hash = hashlib.sha256(new_password.encode()).hexdigest()

# 生成JWT密钥
jwt_secret = secrets.token_urlsafe(32)

print("\n请复制以下内容到 /opt/qwcard/.env 文件：\n")
print(f"PROVIDER_ADMIN_USERNAME=admin")
print(f"PROVIDER_ADMIN_PASSWORD_HASH={password_hash}")
print(f"PROVIDER_JWT_SECRET={jwt_secret}")
EOF
```

**编辑配置文件：**

```bash
sudo nano /opt/qwcard/.env

# 添加以下内容（替换为上面生成的值）：
PROVIDER_ADMIN_USERNAME=admin
PROVIDER_ADMIN_PASSWORD_HASH=你生成的hash值
PROVIDER_JWT_SECRET=你生成的JWT密钥
```

**重启服务：**

```bash
sudo systemctl restart wecard-api.service
```

---

## 📊 功能概览

### 服务商后台（/admin）

**统计面板：**
- 租户总数
- 近30天活跃租户
- 累计访问量
- 素材总数
- 存储占用

**租户列表：**
| 字段 | 说明 |
|------|------|
| 企业名称 | 租户公司名称 |
| CorpID | 企微企业ID |
| 套餐 | trial/free/pro |
| 成员数 | 员工数量 |
| 素材数 | 上传的素材数量 |
| 近30天访问 | 名片访问次数 |
| 存储占用 | 文件存储大小 |
| 最近同步 | 上次数据同步时间 |

### 租户编辑工作台（/wecom/workspace）

**需要企微OAuth认证，管理员可访问：**
- 名片模版配置
- 推送设置
- 实时预览

### 普通用户名片（/wecom/card）

**需要企微OAuth认证，所有用户可访问：**
- 查看自己的名片
- 分享名片
- 保存到通讯录

---

## 🎯 身份识别流程

```
用户访问系统
    ↓
┌─────────┴─────────┐
│                   │
/admin             /wecom/*
│                   │
账号密码登录        企微OAuth
│                   │
服务商token         企微token
│                   │
provider_admin      is_admin判断
│                   │
查看所有租户        ┌──────┴──────┐
                    │              │
                  true           false
                    │              │
                  workspace       card
                  编辑配置        查看名片
```

---

## 📝 数据库说明

### tenants表（已有字段）

```sql
- id: 租户ID
- corp_id: 企微企业ID
- name: 企业名称
- plan: 套餐（trial/free/pro）
- permanent_code: 永久授权码
- config: JSON配置
- installer_userid: 安装者ID
- auth_info: 授权信息（JSON）
- user_limit: 用户名额
- created_at: 创建时间
- updated_at: 更新时间
```

### members表（已有字段）

```sql
- id: 成员ID
- tenant_id: 所属租户
- userid: 企微用户ID
- name: 姓名
- mobile: 手机
- email: 邮箱
- avatar: 头像URL
- position: 职位
- role: 角色（admin/user）
- is_installer: 是否安装者
- in_visible_range: 是否在可见范围
- created_at: 创建时间
- updated_at: 更新时间
```

---

## 🔧 故障排查

### 1. 无法登录

**检查服务状态：**

```bash
systemctl status wecard-api.service
```

**查看日志：**

```bash
journalctl -u wecard-api.service -n 50
```

**测试API：**

```bash
curl -X POST http://127.0.0.1:5001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

### 2. 登录后无法访问租户列表

**检查API响应：**

```bash
# 先登录获取token
TOKEN=$(curl -X POST http://127.0.0.1:5001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)

# 测试租户列表API
curl -H "Authorization: Bearer $TOKEN" \
  http://127.0.0.1:5001/api/admin/tenants
```

### 3. 企微OAuth循环重定向

**检查日志：**

```bash
journalctl -u wecard-api.service -f | grep -E "OAuth|认证"
```

**可能原因：**
- Token过期
- 权限不足
- 企微回调失败

---

## 📞 下一步操作

### 立即完成（重要）

1. ✅ 访问 `https://zjemail.cn/login`
2. ✅ 使用默认密码登录
3. ⚠️ **立即修改密码**（生产环境必须）
4. ✅ 查看租户列表
5. ✅ 从企微扫码安装应用（作为租户使用）

### 未来优化（可选）

- [ ] 添加租户套餐管理
- [ ] 添加存储配额限制
- [ ] 添加访问日志查看
- [ ] 添加数据导出功能
- [ ] 添加系统配置界面

---

## ✅ 验证清单

完成以下验证，确保系统正常运行：

- [ ] 能够访问 `/login` 页面
- [ ] 能够使用 `admin/admin123` 登录
- [ ] 登录后跳转到 `/admin`
- [ ] 能够看到租户列表
- [ ] 能够看到统计数据
- [ ] 能够搜索租户
- [ ] 能够从企微打开应用
- [ ] 管理员进入 `/wecom/workspace`
- [ ] 普通用户进入 `/wecom/card`
- [ ] 退出登录功能正常

---

**完成时间**：2025-10-13  
**文档版本**：v1.0  
**系统状态**：✅ 可用


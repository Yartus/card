# å¾®ä¿¡å°ç¨‹åºå¼€å‘è¯¦ç»†æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v1.0  
> **æ›´æ–°**: 2025-01-XX  
> **ç›®æ ‡**: å°†WeCardåç‰‡ç³»ç»Ÿæ‰©å±•åˆ°å¾®ä¿¡å°ç¨‹åºï¼Œæ”¯æŒä¸ªäººç”¨æˆ·å¿«é€Ÿç”Ÿæˆå’Œåˆ†äº«åç‰‡

---

## ğŸ“‹ ç›®å½•

1. [å°ç¨‹åºæ¶æ„è®¾è®¡](#å°ç¨‹åºæ¶æ„è®¾è®¡)
2. [å°ç¨‹åºé¡¹ç›®ç»“æ„](#å°ç¨‹åºé¡¹ç›®ç»“æ„)
3. [å°ç¨‹åºé¡µé¢è§„åˆ’](#å°ç¨‹åºé¡µé¢è§„åˆ’)
4. [å°ç¨‹åºç™»å½•ä¸è®¤è¯](#å°ç¨‹åºç™»å½•ä¸è®¤è¯)
5. [åç‰‡é…ç½®åŠŸèƒ½](#åç‰‡é…ç½®åŠŸèƒ½)
6. [åç‰‡å±•ç¤ºåŠŸèƒ½](#åç‰‡å±•ç¤ºåŠŸèƒ½)
7. [åˆ†äº«ä¸æ”¶è—åŠŸèƒ½](#åˆ†äº«ä¸æ”¶è—åŠŸèƒ½)
8. [å°ç¨‹åºAPIå¯¹æ¥](#å°ç¨‹åºAPIå¯¹æ¥)
9. [æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ](#æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ)
10. [ä¸Šçº¿ä¸å‘å¸ƒæµç¨‹](#ä¸Šçº¿ä¸å‘å¸ƒæµç¨‹)

---

## ğŸ—ï¸ å°ç¨‹åºæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å¾®ä¿¡å°ç¨‹åºï¼ˆWeCardåç‰‡ï¼‰           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯å±‚ï¼ˆå°ç¨‹åºï¼‰                        â”‚
â”‚  - é¡µé¢è·¯ç”±ï¼ˆpages/ï¼‰                   â”‚
â”‚  - ç»„ä»¶åº“ï¼ˆcomponents/ï¼‰                 â”‚
â”‚  - å·¥å…·å‡½æ•°ï¼ˆutils/ï¼‰                   â”‚
â”‚  - çŠ¶æ€ç®¡ç†ï¼ˆstore/ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTPS API
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åç«¯APIï¼ˆFlaskï¼‰                  â”‚
â”‚  - /api/wechat/authï¼ˆè®¤è¯ï¼‰              â”‚
â”‚  - /api/wechat/cardï¼ˆåç‰‡ï¼‰              â”‚
â”‚  - /api/wechat/userï¼ˆç”¨æˆ·ï¼‰              â”‚
â”‚  - /api/files/uploadï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ•°æ®å±‚ï¼ˆMySQL + Redisï¼‰           â”‚
â”‚  - usersï¼ˆä¸ªäººç”¨æˆ·ï¼‰                     â”‚
â”‚  - user_cardsï¼ˆä¸ªäººåç‰‡ï¼‰                â”‚
â”‚  - user_assetsï¼ˆä¸ªäººç´ æï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆé€‰æ‹©

| æŠ€æœ¯ | é€‰æ‹© | è¯´æ˜ |
|------|------|------|
| **æ¡†æ¶** | åŸç”Ÿå°ç¨‹åº | ä¸ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œä¿æŒè½»é‡ |
| **UIç»„ä»¶** | è‡ªå®šä¹‰ç»„ä»¶ | å¤ç”¨H5è®¾è®¡è§„èŒƒï¼Œä¿æŒä¸€è‡´æ€§ |
| **çŠ¶æ€ç®¡ç†** | å…¨å±€å˜é‡ + æœ¬åœ°å­˜å‚¨ | ç®€å•åœºæ™¯ï¼Œæ— éœ€å¤æ‚çŠ¶æ€ç®¡ç† |
| **ç½‘ç»œè¯·æ±‚** | wx.requestå°è£… | ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œtokenç®¡ç† |
| **å›¾ç‰‡å¤„ç†** | å°ç¨‹åºåŸç”ŸAPI | æ”¯æŒå‹ç¼©ã€è£å‰ª |

---

## ğŸ“ å°ç¨‹åºé¡¹ç›®ç»“æ„

### ç›®å½•ç»“æ„

```
miniprogram/
â”œâ”€â”€ app.js                    # å°ç¨‹åºå…¥å£
â”œâ”€â”€ app.json                  # å°ç¨‹åºé…ç½®
â”œâ”€â”€ app.wxss                  # å…¨å±€æ ·å¼
â”œâ”€â”€ project.config.json       # é¡¹ç›®é…ç½®
â”œâ”€â”€ sitemap.json             # ç«™ç‚¹åœ°å›¾
â”‚
â”œâ”€â”€ pages/                   # é¡µé¢ç›®å½•
â”‚   â”œâ”€â”€ index/               # é¦–é¡µï¼ˆåç‰‡åˆ—è¡¨/å¿«é€Ÿåˆ›å»ºï¼‰
â”‚   â”‚   â”œâ”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ index.json
â”‚   â”‚   â”œâ”€â”€ index.wxml
â”‚   â”‚   â””â”€â”€ index.wxss
â”‚   â”‚
â”‚   â”œâ”€â”€ login/               # ç™»å½•é¡µ
â”‚   â”‚   â”œâ”€â”€ login.js
â”‚   â”‚   â”œâ”€â”€ login.json
â”‚   â”‚   â”œâ”€â”€ login.wxml
â”‚   â”‚   â””â”€â”€ login.wxss
â”‚   â”‚
â”‚   â”œâ”€â”€ workspace/           # åç‰‡é…ç½®å·¥ä½œå°
â”‚   â”‚   â”œâ”€â”€ workspace.js
â”‚   â”‚   â”œâ”€â”€ workspace.json
â”‚   â”‚   â”œâ”€â”€ workspace.wxml
â”‚   â”‚   â””â”€â”€ workspace.wxss
â”‚   â”‚
â”‚   â”œâ”€â”€ card/                # åç‰‡å±•ç¤ºé¡µ
â”‚   â”‚   â”œâ”€â”€ card.js
â”‚   â”‚   â”œâ”€â”€ card.json
â”‚   â”‚   â”œâ”€â”€ card.wxml
â”‚   â”‚   â””â”€â”€ card.wxss
â”‚   â”‚
â”‚   â”œâ”€â”€ my/                  # æˆ‘çš„åç‰‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ my.js
â”‚   â”‚   â”œâ”€â”€ my.json
â”‚   â”‚   â”œâ”€â”€ my.wxml
â”‚   â”‚   â””â”€â”€ my.wxss
â”‚   â”‚
â”‚   â””â”€â”€ settings/            # è®¾ç½®é¡µé¢
â”‚       â”œâ”€â”€ settings.js
â”‚       â”œâ”€â”€ settings.json
â”‚       â”œâ”€â”€ settings.wxml
â”‚       â””â”€â”€ settings.wxss
â”‚
â”œâ”€â”€ components/              # ç»„ä»¶ç›®å½•
â”‚   â”œâ”€â”€ card-header/         # åç‰‡å¤´éƒ¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ card-header.js
â”‚   â”‚   â”œâ”€â”€ card-header.json
â”‚   â”‚   â”œâ”€â”€ card-header.wxml
â”‚   â”‚   â””â”€â”€ card-header.wxss
â”‚   â”‚
â”‚   â”œâ”€â”€ module-company/     # ä¼ä¸šç®€ä»‹æ¨¡å—
â”‚   â”œâ”€â”€ module-grid/         # é€šç”¨ç½‘æ ¼æ¨¡å—
â”‚   â”œâ”€â”€ module-timeline/     # æ—¶é—´çº¿æ¨¡å—
â”‚   â”œâ”€â”€ share-panel/         # åˆ†äº«é¢æ¿
â”‚   â”œâ”€â”€ image-upload/        # å›¾ç‰‡ä¸Šä¼ ç»„ä»¶
â”‚   â””â”€â”€ icon-picker/         # å›¾æ ‡é€‰æ‹©å™¨
â”‚
â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ api.js               # APIè¯·æ±‚å°è£…
â”‚   â”œâ”€â”€ auth.js              # è®¤è¯å·¥å…·
â”‚   â”œâ”€â”€ storage.js           # æœ¬åœ°å­˜å‚¨
â”‚   â”œâ”€â”€ validator.js          # æ•°æ®éªŒè¯
â”‚   â””â”€â”€ share.js              # åˆ†äº«å·¥å…·
â”‚
â”œâ”€â”€ images/                  # å›¾ç‰‡èµ„æº
â”‚   â”œâ”€â”€ icons/               # å›¾æ ‡
â”‚   â””â”€â”€ default/             # é»˜è®¤å›¾ç‰‡
â”‚
â””â”€â”€ config/                  # é…ç½®æ–‡ä»¶
    â”œâ”€â”€ api.js               # APIé…ç½®
    â””â”€â”€ constants.js         # å¸¸é‡å®šä¹‰
```

### å…³é”®é…ç½®æ–‡ä»¶

#### app.jsonï¼ˆå°ç¨‹åºé…ç½®ï¼‰

```json
{
  "pages": [
    "pages/index/index",
    "pages/login/login",
    "pages/workspace/workspace",
    "pages/card/card",
    "pages/my/my",
    "pages/settings/settings"
  ],
  "window": {
    "navigationBarTitleText": "WeCardåç‰‡",
    "navigationBarBackgroundColor": "#1890FF",
    "navigationBarTextStyle": "white",
    "backgroundColor": "#F5F5F5",
    "enablePullDownRefresh": true
  },
  "tabBar": {
    "color": "#8c8c8c",
    "selectedColor": "#1890FF",
    "backgroundColor": "#ffffff",
    "borderStyle": "black",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "é¦–é¡µ",
        "iconPath": "images/icons/home.png",
        "selectedIconPath": "images/icons/home-active.png"
      },
      {
        "pagePath": "pages/my/my",
        "text": "æˆ‘çš„",
        "iconPath": "images/icons/my.png",
        "selectedIconPath": "images/icons/my-active.png"
      }
    ]
  },
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000
  },
  "permission": {
    "scope.userLocation": {
      "desc": "ç”¨äºæ˜¾ç¤ºåœ°å€ä¿¡æ¯"
    }
  },
  "requiredPrivateInfos": [
    "getLocation"
  ]
}
```

#### project.config.jsonï¼ˆé¡¹ç›®é…ç½®ï¼‰

```json
{
  "description": "WeCardåç‰‡å°ç¨‹åº",
  "packOptions": {
    "ignore": [
      "node_modules",
      "docs",
      "README.md"
    ]
  },
  "setting": {
    "urlCheck": false,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "minified": true
  },
  "appid": "wx1234567890abcdef",
  "projectname": "wecard-miniprogram",
  "compileType": "miniprogram",
  "libVersion": "2.19.4"
}
```

---

## ğŸ“± å°ç¨‹åºé¡µé¢è§„åˆ’

### 1. é¦–é¡µï¼ˆindexï¼‰

**åŠŸèƒ½**ï¼š
- å¿«é€Ÿåˆ›å»ºåç‰‡å…¥å£
- æœ€è¿‘ä½¿ç”¨çš„åç‰‡åˆ—è¡¨
- æ‰«ç è¯†åˆ«åç‰‡
- æœç´¢åç‰‡

**é¡µé¢ç»“æ„**ï¼š
```xml
<!-- pages/index/index.wxml -->
<view class="index-container">
  <!-- é¡¶éƒ¨Banner -->
  <view class="banner">
    <text class="title">åˆ›å»ºæ‚¨çš„ä¸“å±åç‰‡</text>
    <button class="create-btn" bindtap="createCard">ç«‹å³åˆ›å»º</button>
  </view>
  
  <!-- å¿«æ·åŠŸèƒ½ -->
  <view class="quick-actions">
    <view class="action-item" bindtap="scanCard">
      <image src="/images/icons/scan.png" />
      <text>æ‰«ç è¯†åˆ«</text>
    </view>
    <view class="action-item" bindtap="importContact">
      <image src="/images/icons/contact.png" />
      <text>å¯¼å…¥é€šè®¯å½•</text>
    </view>
  </view>
  
  <!-- æˆ‘çš„åç‰‡åˆ—è¡¨ -->
  <view class="card-list">
    <view class="section-title">æˆ‘çš„åç‰‡</view>
    <view wx:for="{{cardList}}" wx:key="id" class="card-item" bindtap="viewCard" data-id="{{item.id}}">
      <image class="card-avatar" src="{{item.avatar}}" />
      <view class="card-info">
        <text class="card-name">{{item.name}}</text>
        <text class="card-title">{{item.title}}</text>
      </view>
      <view class="card-stats">
        <text>æŸ¥çœ‹ {{item.viewCount}}</text>
      </view>
    </view>
  </view>
</view>
```

### 2. ç™»å½•é¡µï¼ˆloginï¼‰

**åŠŸèƒ½**ï¼š
- å¾®ä¿¡æˆæƒç™»å½•
- æ‰‹æœºå·ç™»å½•ï¼ˆå¤‡ç”¨ï¼‰
- ç”¨æˆ·åè®®ç¡®è®¤

**ç™»å½•æµç¨‹**ï¼š
```javascript
// pages/login/login.js
Page({
  data: {
    canIUse: wx.canIUse('button.open-type.getUserInfo')
  },
  
  onLoad() {
    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    const token = wx.getStorageSync('token')
    if (token) {
      this.checkToken(token)
    }
  },
  
  // å¾®ä¿¡æˆæƒç™»å½•
  async wxLogin() {
    try {
      // 1. è·å–å¾®ä¿¡ç™»å½•å‡­è¯
      const loginRes = await wx.login()
      const code = loginRes.code
      
      // 2. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
      const userInfo = await this.getUserProfile()
      
      // 3. å‘é€åˆ°åç«¯æ¢å–token
      const res = await api.post('/api/wechat/auth/login', {
        code,
        userInfo: {
          nickName: userInfo.nickName,
          avatarUrl: userInfo.avatarUrl
        }
      })
      
      if (res.success) {
        // 4. ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
        wx.setStorageSync('token', res.token)
        wx.setStorageSync('userInfo', res.userInfo)
        
        // 5. è·³è½¬åˆ°é¦–é¡µ
        wx.switchTab({
          url: '/pages/index/index'
        })
      }
    } catch (error) {
      wx.showToast({
        title: 'ç™»å½•å¤±è´¥',
        icon: 'none'
      })
    }
  },
  
  // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ–°ç‰ˆæœ¬APIï¼‰
  getUserProfile() {
    return new Promise((resolve, reject) => {
      wx.getUserProfile({
        desc: 'ç”¨äºå®Œå–„åç‰‡ä¿¡æ¯',
        success: (res) => {
          resolve(res.userInfo)
        },
        fail: (err) => {
          reject(err)
        }
      })
    })
  },
  
  // æ‰‹æœºå·ç™»å½•ï¼ˆå¤‡ç”¨ï¼‰
  async phoneLogin(e) {
    const { code } = e.detail
    try {
      const res = await api.post('/api/wechat/auth/phone-login', {
        code
      })
      
      if (res.success) {
        wx.setStorageSync('token', res.token)
        wx.switchTab({
          url: '/pages/index/index'
        })
      }
    } catch (error) {
      wx.showToast({
        title: 'ç™»å½•å¤±è´¥',
        icon: 'none'
      })
    }
  }
})
```

### 3. åç‰‡é…ç½®å·¥ä½œå°ï¼ˆworkspaceï¼‰

**åŠŸèƒ½**ï¼š
- æ¨¡å—åŒ–é…ç½®ï¼ˆå¤ç”¨H5ç»„ä»¶é€»è¾‘ï¼‰
- å®æ—¶é¢„è§ˆ
- ä¿å­˜é…ç½®

**é¡µé¢ç»“æ„**ï¼š
```xml
<!-- pages/workspace/workspace.wxml -->
<view class="workspace-container">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="workspace-header">
    <text class="title">ç¼–è¾‘åç‰‡</text>
    <button class="save-btn" bindtap="saveCard">ä¿å­˜</button>
  </view>
  
  <!-- é…ç½®åŒºåŸŸ -->
  <scroll-view class="config-area" scroll-y>
    <!-- åŸºç¡€ä¿¡æ¯ -->
    <view class="config-section">
      <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
      <input class="input" placeholder="å§“å" value="{{cardData.name}}" bindinput="updateName" />
      <input class="input" placeholder="èŒä½" value="{{cardData.title}}" bindinput="updateTitle" />
      <image-upload bind:change="updateAvatar" value="{{cardData.avatar}}" />
    </view>
    
    <!-- è”ç³»æ–¹å¼ -->
    <view class="config-section">
      <view class="section-title">è”ç³»æ–¹å¼</view>
      <input class="input" type="number" placeholder="æ‰‹æœºå·" value="{{cardData.mobile}}" bindinput="updateMobile" />
      <input class="input" placeholder="é‚®ç®±" value="{{cardData.email}}" bindinput="updateEmail" />
      <input class="input" placeholder="å¾®ä¿¡å·" value="{{cardData.wechat}}" bindinput="updateWechat" />
    </view>
    
    <!-- æ¨¡å—é…ç½® -->
    <view class="config-section">
      <view class="section-title">å†…å®¹æ¨¡å—</view>
      <view class="module-list">
        <view wx:for="{{modules}}" wx:key="id" class="module-item">
          <text>{{item.name}}</text>
          <switch checked="{{item.enabled}}" bindchange="toggleModule" data-id="{{item.id}}" />
        </view>
      </view>
    </view>
  </scroll-view>
  
  <!-- é¢„è§ˆåŒºåŸŸ -->
  <view class="preview-area">
    <card-preview card-data="{{cardData}}" />
  </view>
</view>
```

### 4. åç‰‡å±•ç¤ºé¡µï¼ˆcardï¼‰

**åŠŸèƒ½**ï¼š
- å…¬å¼€åç‰‡å±•ç¤ºï¼ˆæ— éœ€ç™»å½•ï¼‰
- åˆ†äº«åŠŸèƒ½
- æ”¶è—åŠŸèƒ½
- å¿«é€Ÿè”ç³»

**é¡µé¢ç»“æ„**ï¼š
```xml
<!-- pages/card/card.wxml -->
<view class="card-container">
  <!-- åç‰‡å¤´éƒ¨ -->
  <card-header 
    card-data="{{cardData}}"
    bind:call="handleCall"
    bind:share="handleShare"
  />
  
  <!-- åç‰‡å†…å®¹ -->
  <scroll-view class="card-content" scroll-y>
    <!-- åŠ¨æ€æ¨¡å—æ¸²æŸ“ -->
    <block wx:for="{{cardData.modules}}" wx:key="id">
      <module-company wx:if="{{item.type === 'company'}}" data="{{item.data}}" />
      <module-grid wx:if="{{item.type === 'grid'}}" data="{{item.data}}" />
      <module-timeline wx:if="{{item.type === 'timeline'}}" data="{{item.data}}" />
    </block>
  </scroll-view>
  
  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="card-actions">
    <button class="action-btn" bindtap="handleCall">ç”µè¯</button>
    <button class="action-btn" bindtap="handleWechat">å¾®ä¿¡</button>
    <button class="action-btn primary" bindtap="handleShare">åˆ†äº«</button>
  </view>
</view>
```

### 5. æˆ‘çš„åç‰‡ç®¡ç†ï¼ˆmyï¼‰

**åŠŸèƒ½**ï¼š
- åç‰‡åˆ—è¡¨
- åˆ›å»ºæ–°åç‰‡
- ç¼–è¾‘åç‰‡
- åˆ é™¤åç‰‡
- æ•°æ®ç»Ÿè®¡

---

## ğŸ” å°ç¨‹åºç™»å½•ä¸è®¤è¯

### ç™»å½•æ–¹æ¡ˆè®¾è®¡

#### æ–¹æ¡ˆä¸€ï¼šå¾®ä¿¡æˆæƒç™»å½•ï¼ˆæ¨èï¼‰

**æµç¨‹**ï¼š
```
1. ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ç™»å½•"
   â†“
2. è°ƒç”¨ wx.login() è·å– code
   â†“
3. è°ƒç”¨ wx.getUserProfile() è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç”¨æˆ·æˆæƒï¼‰
   â†“
4. å‘é€ code + userInfo åˆ°åç«¯
   â†“
5. åç«¯é€šè¿‡ code æ¢å– openid
   â†“
6. åˆ›å»ºæˆ–æ›´æ–° user è®°å½•
   â†“
7. ç”Ÿæˆ JWT token è¿”å›
   â†“
8. å°ç¨‹åºä¿å­˜ token
```

**ä»£ç å®ç°**ï¼š
```javascript
// utils/auth.js
const API_BASE = 'https://zjemail.cn/api'

export default {
  // å¾®ä¿¡ç™»å½•
  async wxLogin() {
    try {
      // 1. è·å–ç™»å½•å‡­è¯
      const loginRes = await this.wxLoginPromise()
      const code = loginRes.code
      
      // 2. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦æˆæƒï¼‰
      const userInfo = await this.getUserProfilePromise()
      
      // 3. å‘é€åˆ°åç«¯
      const res = await this.request({
        url: '/wechat/auth/login',
        method: 'POST',
        data: {
          code,
          userInfo: {
            nickName: userInfo.nickName,
            avatarUrl: userInfo.avatarUrl
          }
        }
      })
      
      if (res.success) {
        // ä¿å­˜token
        wx.setStorageSync('token', res.token)
        wx.setStorageSync('userInfo', res.userInfo)
        return res
      }
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
      throw error
    }
  },
  
  // PromiseåŒ– wx.login
  wxLoginPromise() {
    return new Promise((resolve, reject) => {
      wx.login({
        success: resolve,
        fail: reject
      })
    })
  },
  
  // PromiseåŒ– getUserProfile
  getUserProfilePromise() {
    return new Promise((resolve, reject) => {
      wx.getUserProfile({
        desc: 'ç”¨äºå®Œå–„åç‰‡ä¿¡æ¯',
        success: (res) => resolve(res.userInfo),
        fail: reject
      })
    })
  },
  
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  checkLogin() {
    const token = wx.getStorageSync('token')
    if (!token) {
      return false
    }
    
    // éªŒè¯tokenæœ‰æ•ˆæ€§ï¼ˆå¯é€‰ï¼Œè°ƒç”¨åç«¯æ¥å£ï¼‰
    return true
  },
  
  // é€€å‡ºç™»å½•
  logout() {
    wx.removeStorageSync('token')
    wx.removeStorageSync('userInfo')
    wx.reLaunch({
      url: '/pages/login/login'
    })
  }
}
```

#### æ–¹æ¡ˆäºŒï¼šæ‰‹æœºå·ç™»å½•ï¼ˆå¤‡ç”¨ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·æ‹’ç»æˆæƒå¾®ä¿¡ä¿¡æ¯
- éœ€è¦ç»‘å®šæ‰‹æœºå·

**å®ç°**ï¼š
```javascript
// è·å–æ‰‹æœºå·
getPhoneNumber(e) {
  const { code } = e.detail
  if (code) {
    // å‘é€åˆ°åç«¯æ¢å–æ‰‹æœºå·
    api.post('/api/wechat/auth/phone-login', { code })
  }
}
```

### Tokenç®¡ç†

```javascript
// utils/api.js
const API_BASE = 'https://zjemail.cn/api'

function request(options) {
  return new Promise((resolve, reject) => {
    // è·å–token
    const token = wx.getStorageSync('token')
    
    // æ·»åŠ tokenåˆ°header
    const header = {
      'Content-Type': 'application/json',
      ...options.header
    }
    
    if (token) {
      header['Authorization'] = `Bearer ${token}`
    }
    
    wx.request({
      url: `${API_BASE}${options.url}`,
      method: options.method || 'GET',
      data: options.data,
      header,
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data)
        } else if (res.statusCode === 401) {
          // Tokenå¤±æ•ˆï¼Œè·³è½¬ç™»å½•
          wx.removeStorageSync('token')
          wx.reLaunch({
            url: '/pages/login/login'
          })
          reject(new Error('æœªç™»å½•'))
        } else {
          reject(new Error(res.data.message || 'è¯·æ±‚å¤±è´¥'))
        }
      },
      fail: reject
    })
  })
}

export default {
  get(url, data) {
    return request({ url, method: 'GET', data })
  },
  post(url, data) {
    return request({ url, method: 'POST', data })
  },
  put(url, data) {
    return request({ url, method: 'PUT', data })
  },
  delete(url) {
    return request({ url, method: 'DELETE' })
  }
}
```

---

## ğŸ¨ åç‰‡é…ç½®åŠŸèƒ½

### é…ç½®æµç¨‹è®¾è®¡

```
ç”¨æˆ·è¿›å…¥å·¥ä½œå°
  â†“
é€‰æ‹©æ¨¡æ¿æˆ–ä»ç©ºç™½å¼€å§‹
  â†“
é…ç½®åŸºç¡€ä¿¡æ¯ï¼ˆå§“åã€èŒä½ã€å¤´åƒï¼‰
  â†“
æ·»åŠ å†…å®¹æ¨¡å—ï¼ˆä¼ä¸šç®€ä»‹ã€ç½‘æ ¼ã€æ—¶é—´çº¿ç­‰ï¼‰
  â†“
é…ç½®æ¯ä¸ªæ¨¡å—çš„å…·ä½“å†…å®¹
  â†“
å®æ—¶é¢„è§ˆæ•ˆæœ
  â†“
ä¿å­˜é…ç½®
  â†“
ç”Ÿæˆåç‰‡é“¾æ¥/äºŒç»´ç 
```

### æ¨¡å—é…ç½®ç»„ä»¶

å¤ç”¨H5çš„æ¨¡å—å®šä¹‰ï¼Œä½†éœ€è¦é€‚é…å°ç¨‹åºç»„ä»¶ï¼š

```javascript
// components/module-company/module-company.js
Component({
  properties: {
    data: {
      type: Object,
      value: {}
    }
  },
  
  data: {
    // æ¨¡å—æ•°æ®
  },
  
  methods: {
    // æ¨¡å—äº¤äº’æ–¹æ³•
  }
})
```

### å›¾ç‰‡ä¸Šä¼ ç»„ä»¶

```javascript
// components/image-upload/image-upload.js
Component({
  properties: {
    value: String,
    maxSize: {
      type: Number,
      value: 500 * 1024  // 500KB
    }
  },
  
  methods: {
    async chooseImage() {
      try {
        // 1. é€‰æ‹©å›¾ç‰‡
        const res = await this.chooseImagePromise()
        const tempFilePath = res.tempFilePaths[0]
        
        // 2. å‹ç¼©å›¾ç‰‡
        const compressed = await this.compressImage(tempFilePath)
        
        // 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨
        const uploadRes = await this.uploadImage(compressed)
        
        // 4. é€šçŸ¥çˆ¶ç»„ä»¶
        this.triggerEvent('change', uploadRes.url)
      } catch (error) {
        wx.showToast({
          title: 'ä¸Šä¼ å¤±è´¥',
          icon: 'none'
        })
      }
    },
    
    // å‹ç¼©å›¾ç‰‡
    compressImage(filePath) {
      return new Promise((resolve, reject) => {
        wx.compressImage({
          src: filePath,
          quality: 75,  // è´¨é‡75%
          success: resolve,
          fail: reject
        })
      })
    },
    
    // ä¸Šä¼ å›¾ç‰‡
    uploadImage(filePath) {
      return new Promise((resolve, reject) => {
        const token = wx.getStorageSync('token')
        
        wx.uploadFile({
          url: 'https://zjemail.cn/api/v1/files/upload',
          filePath,
          name: 'file',
          header: {
            'Authorization': `Bearer ${token}`
          },
          success: (res) => {
            const data = JSON.parse(res.data)
            if (data.success) {
              resolve(data)
            } else {
              reject(new Error(data.message))
            }
          },
          fail: reject
        })
      })
    }
  }
})
```

---

## ğŸ“„ åç‰‡å±•ç¤ºåŠŸèƒ½

### åç‰‡æ•°æ®è·å–

```javascript
// pages/card/card.js
Page({
  data: {
    cardId: null,
    cardSlug: null,
    cardData: null,
    isLoading: true
  },
  
  onLoad(options) {
    // æ”¯æŒä¸¤ç§æ–¹å¼è®¿é—®ï¼š
    // 1. /pages/card/card?id=123
    // 2. /pages/card/card?slug=zhangsan
    const { id, slug } = options
    
    if (id) {
      this.cardId = id
      this.loadCardById(id)
    } else if (slug) {
      this.cardSlug = slug
      this.loadCardBySlug(slug)
    }
  },
  
  async loadCardById(id) {
    try {
      const res = await api.get(`/api/wechat/card/${id}`)
      this.setData({
        cardData: res.data,
        isLoading: false
      })
      
      // è®°å½•è®¿é—®
      this.trackView(id)
    } catch (error) {
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
    }
  },
  
  async loadCardBySlug(slug) {
    try {
      const res = await api.get(`/api/wechat/card/slug/${slug}`)
      this.setData({
        cardData: res.data,
        isLoading: false
      })
      
      this.trackView(res.data.id)
    } catch (error) {
      wx.showToast({
        title: 'åç‰‡ä¸å­˜åœ¨',
        icon: 'none'
      })
    }
  },
  
  // è®°å½•è®¿é—®é‡
  trackView(cardId) {
    api.post(`/api/wechat/card/${cardId}/track`, {
      event: 'view',
      timestamp: Date.now()
    })
  }
})
```

### æ¨¡å—æ¸²æŸ“

å¤ç”¨H5çš„æ¨¡å—ç»„ä»¶ï¼Œä½†éœ€è¦é€‚é…å°ç¨‹åºï¼š

```xml
<!-- pages/card/card.wxml -->
<view class="card-container">
  <card-header card-data="{{cardData}}" />
  
  <scroll-view class="card-content" scroll-y>
    <block wx:for="{{cardData.modules}}" wx:key="id">
      <!-- ä¼ä¸šç®€ä»‹æ¨¡å— -->
      <module-company 
        wx:if="{{item.type === 'company-intro'}}"
        data="{{item.data}}"
      />
      
      <!-- é€šç”¨ç½‘æ ¼æ¨¡å— -->
      <module-grid 
        wx:if="{{item.type === 'standard-grid'}}"
        data="{{item.data}}"
      />
      
      <!-- æ—¶é—´çº¿æ¨¡å— -->
      <module-timeline 
        wx:if="{{item.type === 'timeline'}}"
        data="{{item.data}}"
      />
    </block>
  </scroll-view>
  
  <card-actions card-data="{{cardData}}" />
</view>
```

---

## ğŸ“¤ åˆ†äº«ä¸æ”¶è—åŠŸèƒ½

### åˆ†äº«åŠŸèƒ½

#### 1. å°ç¨‹åºåˆ†äº«ï¼ˆonShareAppMessageï¼‰

```javascript
// pages/card/card.js
Page({
  onShareAppMessage() {
    const { cardData } = this.data
    return {
      title: `${cardData.name} - ${cardData.title}`,
      path: `/pages/card/card?slug=${cardData.slug}`,
      imageUrl: cardData.shareImage || cardData.avatar
    }
  },
  
  // åˆ†äº«åˆ°æœ‹å‹åœˆï¼ˆéœ€è¦åŸºç¡€åº“2.11.3+ï¼‰
  onShareTimeline() {
    const { cardData } = this.data
    return {
      title: `${cardData.name} - ${cardData.title}`,
      imageUrl: cardData.shareImage || cardData.avatar
    }
  }
})
```

#### 2. ç”Ÿæˆåˆ†äº«å›¾ç‰‡

```javascript
// utils/share.js
export default {
  // ç”Ÿæˆåˆ†äº«å›¾ç‰‡ï¼ˆCanvasï¼‰
  async generateShareImage(cardData) {
    return new Promise((resolve, reject) => {
      const ctx = wx.createCanvasContext('shareCanvas')
      
      // ç»˜åˆ¶èƒŒæ™¯
      ctx.setFillStyle('#ffffff')
      ctx.fillRect(0, 0, 750, 1334)
      
      // ç»˜åˆ¶å¤´åƒ
      ctx.drawImage(cardData.avatar, 375 - 100, 200, 200, 200)
      
      // ç»˜åˆ¶å§“å
      ctx.setFillStyle('#262626')
      ctx.setFontSize(48)
      ctx.setTextAlign('center')
      ctx.fillText(cardData.name, 375, 500)
      
      // ç»˜åˆ¶èŒä½
      ctx.setFillStyle('#8c8c8c')
      ctx.setFontSize(32)
      ctx.fillText(cardData.title, 375, 560)
      
      // ç»˜åˆ¶äºŒç»´ç 
      ctx.drawImage(cardData.qrCode, 375 - 150, 800, 300, 300)
      
      // ç»˜åˆ¶å®Œæˆ
      ctx.draw(false, () => {
        wx.canvasToTempFilePath({
          canvasId: 'shareCanvas',
          success: (res) => {
            resolve(res.tempFilePath)
          },
          fail: reject
        })
      })
    })
  },
  
  // ä¿å­˜åˆ†äº«å›¾ç‰‡åˆ°ç›¸å†Œ
  saveShareImage(imagePath) {
    return new Promise((resolve, reject) => {
      wx.saveImageToPhotosAlbum({
        filePath: imagePath,
        success: resolve,
        fail: reject
      })
    })
  }
}
```

### æ”¶è—åŠŸèƒ½

#### 1. å¾®ä¿¡æ”¶è—API

```javascript
// pages/card/card.js
Page({
  // æ”¶è—åç‰‡
  async addToFavorites() {
    try {
      const { cardId } = this.data
      
      // è°ƒç”¨åç«¯API
      const res = await api.post(`/api/wechat/card/${cardId}/favorite`)
      
      if (res.success) {
        wx.showToast({
          title: 'å·²æ”¶è—',
          icon: 'success'
        })
        
        // æ›´æ–°æ”¶è—çŠ¶æ€
        this.setData({
          isFavorited: true
        })
      }
    } catch (error) {
      wx.showToast({
        title: 'æ”¶è—å¤±è´¥',
        icon: 'none'
      })
    }
  },
  
  // å–æ¶ˆæ”¶è—
  async removeFromFavorites() {
    try {
      const { cardId } = this.data
      
      const res = await api.delete(`/api/wechat/card/${cardId}/favorite`)
      
      if (res.success) {
        wx.showToast({
          title: 'å·²å–æ¶ˆæ”¶è—',
          icon: 'success'
        })
        
        this.setData({
          isFavorited: false
        })
      }
    } catch (error) {
      wx.showToast({
        title: 'æ“ä½œå¤±è´¥',
        icon: 'none'
      })
    }
  }
})
```

#### 2. æ”¶è—åˆ—è¡¨é¡µé¢

```javascript
// pages/my/favorites.js
Page({
  data: {
    favoriteList: []
  },
  
  onLoad() {
    this.loadFavorites()
  },
  
  async loadFavorites() {
    try {
      const res = await api.get('/api/wechat/user/favorites')
      this.setData({
        favoriteList: res.data
      })
    } catch (error) {
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
    }
  }
})
```

---

## ğŸ”Œ å°ç¨‹åºAPIå¯¹æ¥

### åç«¯APIè®¾è®¡

#### 1. è®¤è¯ç›¸å…³

```python
# app/routes/wechat_auth.py

@bp.route('/wechat/auth/login', methods=['POST'])
def wechat_login():
    """å¾®ä¿¡ç™»å½•"""
    data = request.get_json()
    code = data.get('code')
    user_info = data.get('userInfo')
    
    # é€šè¿‡codeæ¢å–openid
    openid = get_openid_by_code(code)
    
    # æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    user = User.query.filter_by(openid=openid).first()
    if not user:
        user = User(
            openid=openid,
            nickname=user_info.get('nickName'),
            avatar_url=user_info.get('avatarUrl')
        )
        db.session.add(user)
    else:
        # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        user.nickname = user_info.get('nickName')
        user.avatar_url = user_info.get('avatarUrl')
    
    db.session.commit()
    
    # ç”ŸæˆJWT token
    token = generate_jwt_token({
        'user_id': user.id,
        'openid': user.openid
    })
    
    return jsonify({
        'success': True,
        'token': token,
        'userInfo': {
            'id': user.id,
            'nickname': user.nickname,
            'avatarUrl': user.avatar_url
        }
    })

@bp.route('/wechat/auth/phone-login', methods=['POST'])
def phone_login():
    """æ‰‹æœºå·ç™»å½•"""
    data = request.get_json()
    code = data.get('code')
    
    # é€šè¿‡codeæ¢å–æ‰‹æœºå·
    phone = get_phone_by_code(code)
    
    # æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    user = User.query.filter_by(phone=phone).first()
    if not user:
        user = User(phone=phone)
        db.session.add(user)
    
    db.session.commit()
    
    token = generate_jwt_token({
        'user_id': user.id,
        'phone': user.phone
    })
    
    return jsonify({
        'success': True,
        'token': token,
        'userInfo': {
            'id': user.id,
            'phone': user.phone
        }
    })
```

#### 2. åç‰‡ç›¸å…³

```python
# app/routes/wechat_card.py

@bp.route('/wechat/card', methods=['POST'])
@require_auth
def create_card():
    """åˆ›å»ºåç‰‡"""
    user_id = get_current_user_id()
    data = request.get_json()
    
    # ç”Ÿæˆå”¯ä¸€slug
    slug = generate_unique_slug(data.get('name'))
    
    card = UserCard(
        user_id=user_id,
        card_slug=slug,
        card_data=json.dumps(data)
    )
    db.session.add(card)
    db.session.commit()
    
    return jsonify({
        'success': True,
        'card': {
            'id': card.id,
            'slug': card.card_slug,
            'data': json.loads(card.card_data)
        }
    })

@bp.route('/wechat/card/<int:card_id>', methods=['GET'])
def get_card(card_id):
    """è·å–åç‰‡ï¼ˆå…¬å¼€æ¥å£ï¼‰"""
    card = UserCard.query.get_or_404(card_id)
    
    # è®°å½•è®¿é—®
    track_card_view(card_id)
    
    return jsonify({
        'success': True,
        'data': {
            'id': card.id,
            'slug': card.card_slug,
            'data': json.loads(card.card_data),
            'viewCount': card.view_count
        }
    })

@bp.route('/wechat/card/slug/<slug>', methods=['GET'])
def get_card_by_slug(slug):
    """é€šè¿‡slugè·å–åç‰‡"""
    card = UserCard.query.filter_by(card_slug=slug).first_or_404()
    
    track_card_view(card.id)
    
    return jsonify({
        'success': True,
        'data': {
            'id': card.id,
            'slug': card.card_slug,
            'data': json.loads(card.card_data)
        }
    })

@bp.route('/wechat/card/<int:card_id>', methods=['PUT'])
@require_auth
def update_card(card_id):
    """æ›´æ–°åç‰‡"""
    user_id = get_current_user_id()
    card = UserCard.query.filter_by(id=card_id, user_id=user_id).first_or_404()
    
    data = request.get_json()
    card.card_data = json.dumps(data)
    db.session.commit()
    
    return jsonify({
        'success': True,
        'card': {
            'id': card.id,
            'data': json.loads(card.card_data)
        }
    })

@bp.route('/wechat/card/<int:card_id>/favorite', methods=['POST'])
@require_auth
def favorite_card(card_id):
    """æ”¶è—åç‰‡"""
    user_id = get_current_user_id()
    
    favorite = UserFavorite.query.filter_by(user_id=user_id, card_id=card_id).first()
    if not favorite:
        favorite = UserFavorite(user_id=user_id, card_id=card_id)
        db.session.add(favorite)
        db.session.commit()
    
    return jsonify({'success': True})

@bp.route('/wechat/card/<int:card_id>/track', methods=['POST'])
def track_card_event(card_id):
    """è®°å½•åç‰‡äº‹ä»¶ï¼ˆè®¿é—®ã€åˆ†äº«ç­‰ï¼‰"""
    data = request.get_json()
    event = data.get('event')
    
    # è®°å½•åˆ°æ•°æ®åº“æˆ–ç»Ÿè®¡ç³»ç»Ÿ
    track_event(card_id, event, data)
    
    return jsonify({'success': True})
```

---


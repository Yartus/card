## ğŸ‰ é¢„è§ˆæ“ä½œï¼ˆæœåŠ¡å™¨ï¼‰

```bash
# å¯åŠ¨/é‡å¯å¼€å‘æœåŠ¡ï¼ˆåå°å¸¸é©»ï¼‰
cd /opt/qwcard
nohup npm run dev > /var/log/nuxt-dev.log 2>&1 &

# æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—
tail -f /var/log/nuxt-dev.log
```

è®¿é—®åœ°å€ï¼š`https://zjemail.cn/card-preview`

å¸¸è§é—®é¢˜ï¼š
- 502 æˆ–è½¬åœˆï¼šæ£€æŸ¥ `/_nuxt/*.js` è¿”å›æ˜¯å¦ 200ï¼›å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
- é¡µé¢æœªæ›´æ–°ï¼šç­‰å¾…ç¼–è¯‘å®Œæˆååˆ·æ–°ï¼›æˆ–é‡å¯ dev å†è¯•

## ğŸ”’ Nginx åä»£ä¸æ’é”™è¯´æ˜ï¼ˆé‡è¦ï¼‰

ä¸ºä¿è¯é¢„è§ˆç«™ç‚¹ä¸ API æ­£ç¡®è”é€šï¼Œä¸»ç«™ç‚¹ `zjemail.cn` åº”æ»¡è¶³ï¼š

- `/_nuxt/` ä¸ `/` åä»£åˆ° Nuxt å¼€å‘æœåŠ¡ `127.0.0.1:3000`
- `/api/` åä»£åˆ° Flask API `127.0.0.1:5001`

æ¨èçš„ä¸»ç«™ç‚¹ç‰‡æ®µï¼ˆä»…ç¤ºä¾‹ï¼Œé¡»æ”¾åœ¨å« `server_name zjemail.cn www.zjemail.cn;` çš„ 443 ç«™ç‚¹å†…ï¼Œä¸”åœ¨ `location /` ä¹‹å‰ï¼‰ï¼š

```nginx
location ^~ /api/ {
  proxy_pass http://127.0.0.1:5001;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_read_timeout 60s;
}

location ^~ /_nuxt/ {
  proxy_pass http://127.0.0.1:3000;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_read_timeout 60s;
}

location / {
  proxy_pass http://127.0.0.1:3000;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_read_timeout 60s;
}
```

è‹¥å‡ºç°â€œAPI 200 ä½†è¿”å› HTMLâ€ç°è±¡ï¼Œè¯´æ˜ `/api/` æœªå‘½ä¸­ 5001ï¼Œè¢« `location /` è½¬å‘åˆ° 3000ï¼š

- ç”¨æ¢é’ˆç¡®è®¤å‘½ä¸­ç«™ç‚¹ï¼š
  ```nginx
  location = /api/_whoami { return 200 "zj-main\n"; }
  ```
  é‡è½½å `curl -s https://zjemail.cn/api/_whoami` åº”å› `zj-main`ã€‚å¦åˆ™è¯´æ˜å‘½ä¸­äº†å…¶ä»–åŒåç«™ç‚¹ï¼ˆéœ€åœ¨â€œå®é™…å‘½ä¸­çš„ server {}â€é‡Œæ·»åŠ  `/api/` è§„åˆ™ï¼‰ã€‚

- å¦‚åŒå `server_name zjemail.cn` å­˜åœ¨äºå¤šä¸ªæ–‡ä»¶ï¼Œå»ºè®®ï¼š
  - å°†â€œä¸»ç«™ç‚¹â€ç»Ÿä¸€æ”¾åœ¨ `/etc/nginx/sites-available/zjemail.cn`ï¼Œå¹¶é€šè¿‡ `sites-enabled` é“¾æ¥å¯ç”¨
  - åˆ é™¤æˆ–æ³¨é‡Š `/etc/nginx/nginx.conf` ä¸­é‡å¤çš„ `server { server_name zjemail.cn; }`ï¼ˆé¿å…è¦†ç›–ï¼‰
  - éœ€è¦æ—¶å°†ä¸»ç«™ç‚¹è®¾ç½®ä¸ºé»˜è®¤ï¼š`listen 443 ssl default_server;`

è‡ªæ£€å‘½ä»¤ï¼š

```bash
# é¢„è§ˆé¡µï¼ˆæœ¬æœºä¸å…¬ç½‘ï¼‰
curl -s -o /dev/null -w "%{http_code}\n" http://127.0.0.1:3000/card-preview
curl -s -o /dev/null -w "%{http_code}\n" https://zjemail.cn/card-preview

# APIï¼ˆåº”ä¸º JSON è€Œé HTMLï¼‰
curl -s -i "https://zjemail.cn/api/card/profile?tenant_id=1&member_id=1&stub=1" | sed -n '1,14p'
# æœŸæœ›çœ‹åˆ°ï¼šContent-Type: application/json
```

## ğŸ§ª API æ¼”ç¤ºæ¨¡å¼ï¼ˆæ•°æ®åº“ä¸å¯ç”¨æ—¶ï¼‰

- GETï¼š`/api/card/profile?tenant_id=1&member_id=1&stub=1` å¼ºåˆ¶è¿”å›æ¼”ç¤ºæ•°æ®
- PUTï¼š`/api/card/profile?stub=1` å›æ˜¾æ¼”ç¤ºæ•°æ®ï¼Œä¸å†™æ•°æ®åº“
- ä¹Ÿå¯åœ¨æœåŠ¡å™¨è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨å…¨å±€æ¼”ç¤ºï¼š

```bash
echo 'CARD_PROFILE_DEMO=1' >> /opt/qwcard/.env
systemctl restart wecard-api.service
```

---

## âœ… æœ¬æ¬¡é—®é¢˜ä¸ä¿®å¤è®°å½•ï¼ˆå¯å¤ç”¨çš„æ“ä½œæ‰‹å†Œï¼‰

### ç°è±¡ä¸æ ¹å› å½’çº³
- ç°è±¡Aï¼šé¡µé¢åœ°å€æ æˆ–å†…éƒ¨"ç™½è‰²åœ†åœˆ"ä¸€ç›´è½¬
  - æ ¹å› 1ï¼ˆå·²å¤ç°ä¸ä¿®å¤ï¼‰ï¼šNginx è¯»å–ä¸Šæ¸¸ 3000 çš„æµå¼èµ„æºæ—¶å†™å…¥ä¸´æ—¶æ–‡ä»¶å¤±è´¥ï¼Œ`/var/lib/nginx/proxy` æƒé™ä¸è¶³ â†’ æµè§ˆå™¨æŠ¥ `ERR_INCOMPLETE_CHUNKED_ENCODING`ã€‚
  - æ ¹å› 2ï¼ˆå·²å¤ç°ä¸ä¿®å¤ï¼‰ï¼šå¼€å‘æ¨¡å¼å­˜åœ¨æ—§çš„ Service Worker/PWA ç¼“å­˜åŠ«æŒï¼Œå¯¼è‡´é¡µé¢å¡åŠ è½½æˆ–èµ„æºèµ°æ—§ç¼“å­˜ã€‚
  - æ ¹å› 3ï¼ˆå·²å¤ç°ä¸ä¿®å¤ï¼‰ï¼šTailwind/PostCSS é…ç½®ä¸å®Œæ•´ï¼Œ`@nuxtjs/tailwindcss` åœ¨ dev æŠ¥é”™ `Cannot set properties of undefined (setting 'stage')`ï¼Œå¯¼è‡´åº”ç”¨æœªæŒ‚è½½ã€‚
  - æ ¹å› 4ï¼ˆå·²å¤ç°ä¸ä¿®å¤ï¼‰ï¼šæœåŠ¡ç«¯æ¸²æŸ“(SSR)æ—¶è®¿é—®æµè§ˆå™¨APIå¯¼è‡´"window is not defined"é”™è¯¯ï¼Œå½±å“é¡µé¢æ­£å¸¸æ¸²æŸ“ã€‚
  - æ ¹å› 5ï¼ˆå·²å¤ç°ä¸ä¿®å¤ï¼‰ï¼šç¼ºå°‘ESLinté…ç½®æ–‡ä»¶å¯¼è‡´ç¼–è¯‘æ—¶å‡ºç°"No ESLint configuration found"é”™è¯¯ï¼Œå½±å“å¼€å‘æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨å’Œé¢„è§ˆé¡µé¢è®¿é—®ã€‚

### æ ‡å‡†ä¿®å¤æ­¥éª¤
1) Nginx æƒé™ä¸æµå¼è½¬å‘ï¼ˆå¿…é¡»ï¼‰
```bash
sudo mkdir -p /var/lib/nginx/proxy /var/lib/nginx/body
sudo chown -R www-data:www-data /var/lib/nginx
```

2) ä¸»ç«™ç‚¹ `zjemail.cn` çš„åä»£ï¼ˆæŒ‰é¡ºåºæ”¾ç½®ï¼›ä»…æ‘˜è¦å…³é”®é¡¹ï¼‰
```nginx
location ^~ /api/ {
  proxy_pass http://127.0.0.1:5001;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_read_timeout 60s;
}

location ^~ /_nuxt/ {
  proxy_pass http://127.0.0.1:3000;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  # dev/HMR å…³é”®ï¼šç¦ç”¨ç¼“å†²ä¸ä¸´æ—¶æ–‡ä»¶ï¼Œå‡çº§ WS
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_max_temp_file_size 0;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 300s;
}

location / {
  proxy_pass http://127.0.0.1:3000;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  # åŒæ ·ç¦ç”¨ç¼“å†²ï¼Œé¿å…åˆ†å—è¢«æˆªæ–­
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_max_temp_file_size 0;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
}
```

3) åœç”¨å¼€å‘æ¨¡å¼çš„ PWA/Workboxï¼ˆå·²æ”¹åœ¨ `nuxt.config.js`ï¼‰
- ç›®çš„ï¼šé¿å… SW ç¼“å­˜åŠ«æŒ dev å†…å®¹
- æ–¹å¼ï¼šå¼€å‘ç¯å¢ƒä¸åŠ è½½ `@nuxtjs/pwa`ï¼Œ`pwa.workbox.enabled=false`ï¼ˆdevï¼‰

4) ä¿®æ­£ PostCSS preset ä¸æ’ä»¶ï¼ˆå·²æ”¹åœ¨ `nuxt.config.js`ï¼‰
- å¢åŠ ï¼š
```js
postcss: {
  plugins: { tailwindcss: {}, autoprefixer: {} },
  preset: { stage: 1 }
}
```
- ç°è±¡æ¶ˆå¤±ï¼š`Cannot set properties of undefined (setting 'stage')`

5) å‰ç«¯é¢„è§ˆé¡µè°ƒè¯•è¦†ç›–å±‚ï¼ˆä»…é¢„è§ˆé¡µç”Ÿæ•ˆï¼‰
- åœ¨ `pages/card-preview.vue` æ·»åŠ é”™è¯¯æ•è·ä¸è¦†ç›–å±‚ï¼Œè‹¥è¿è¡Œæ—¶é”™è¯¯å¯¼è‡´æœªæŒ‚è½½ï¼Œä¼šæ˜¾ç¤º `message/stack/lastApiProbe`ï¼Œä¾¿äºå¿«é€Ÿå®šä½ã€‚

6) ESLinté…ç½®ä¿®å¤ï¼ˆ2024-12-19æ–°å¢ï¼‰
- åˆ›å»º`.eslintrc.js`é…ç½®æ–‡ä»¶ï¼š
```js
module.exports = {
  root: true,
  env: { browser: true, node: true, es6: true },
  extends: ['@nuxtjs/eslint-config', 'plugin:vue/recommended'],
  plugins: ['vue'],
  rules: {
    'no-console': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    'vue/multi-word-component-names': 'off',
    'semi': ['error', 'never'],
    'quotes': ['error', 'single'],
    'indent': ['error', 2]
  },
  parserOptions: {
    parser: '@babel/eslint-parser',
    requireConfigFile: false,
    ecmaVersion: 2020,
    sourceType: 'module'
  }
}
```
- å®‰è£…ESLintä¾èµ–ï¼š
```bash
npm install --save-dev eslint@^8.0.0 @nuxtjs/eslint-config@^11.0.0 eslint-plugin-vue@^8.0.0 @babel/eslint-parser@^7.0.0 --legacy-peer-deps
```
- ä¸´æ—¶ç¦ç”¨`@nuxtjs/eslint-module`é¿å…ç‰ˆæœ¬å†²çªï¼ˆåœ¨`nuxt.config.js`ä¸­æ³¨é‡Šæ‰ï¼‰

7) æœåŠ¡ç«¯æ¸²æŸ“(SSR)é”™è¯¯ä¿®å¤ï¼ˆ2024-12-19æ–°å¢ï¼‰
- é—®é¢˜ï¼šåœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶è®¿é—®æµè§ˆå™¨APIï¼ˆå¦‚`window`ã€`document`å¯¹è±¡ï¼‰å¯¼è‡´"window is not defined"é”™è¯¯
- ä¿®å¤æ–‡ä»¶ï¼š
  - `components/LottieIcon.vue`ï¼šæ¡ä»¶å¯¼å…¥lottie-webåº“ï¼Œåªåœ¨å®¢æˆ·ç«¯åˆå§‹åŒ–åŠ¨ç”»
  - `config/lottie.config.js`ï¼šæ·»åŠ process.clientå’Œwindowå­˜åœ¨æ€§æ£€æŸ¥
  - `plugins/lottie.js`ï¼šåªåœ¨å®¢æˆ·ç«¯æ³¨å…¥Lottieå·¥å…·ï¼ŒæœåŠ¡ç«¯æä¾›ç©ºå®ç°
  - `plugins/toast.js`ï¼šæ·»åŠ process.clientå’Œdocumentå­˜åœ¨æ€§æ£€æŸ¥
  - `layouts/default.vue`ï¼šGoogle Tag Managerä»£ç åªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
- ä¿®å¤æ–¹æ³•ï¼šä½¿ç”¨`process.client`æ£€æŸ¥ç¡®ä¿ä»£ç åªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œï¼Œä½¿ç”¨`typeof window !== 'undefined'`æ£€æŸ¥ç¡®ä¿windowå¯¹è±¡å­˜åœ¨

8) ESLinté…ç½®ä¼˜åŒ–ï¼ˆ2024-12-19æ–°å¢ï¼‰
- é—®é¢˜ï¼šç¼ºå°‘ESLinté…ç½®æ–‡ä»¶å¯¼è‡´ç¼–è¯‘æ—¶å‡ºç°"No ESLint configuration found"é”™è¯¯ï¼Œå½±å“é¢„è§ˆé¡µé¢æ­£å¸¸è®¿é—®
- ä¿®å¤å†…å®¹ï¼š
  - åˆ›å»º`.eslintrc.js`é…ç½®æ–‡ä»¶ï¼Œé…ç½®é€‚åˆVue.jså’ŒNuxt.jsçš„ä»£ç æ£€æŸ¥è§„åˆ™
  - å®‰è£…å…¼å®¹çš„ESLintä¾èµ–ï¼š`eslint@^8.0.0`ã€`@nuxtjs/eslint-config@^11.0.0`ã€`eslint-plugin-vue@^8.0.0`ã€`@babel/eslint-parser@^7.0.0`
  - é…ç½®ä»£ç è§„èŒƒï¼šå•å¼•å·ã€2ç©ºæ ¼ç¼©è¿›ã€æ— åˆ†å·ã€æ— å°¾éšé€—å·ç­‰
  - é…ç½®Vue.jsè§„åˆ™ï¼šå…è®¸å•è¯ç»„ä»¶åã€å…³é—­éƒ¨åˆ†ä¸¥æ ¼æ£€æŸ¥ç­‰
  - ä¸´æ—¶ç¦ç”¨`@nuxtjs/eslint-module`é¿å…ç‰ˆæœ¬å†²çª
- å½±å“èŒƒå›´ï¼š
  - ä»£ç è´¨é‡æ£€æŸ¥ï¼šå®æ—¶æ£€æŸ¥æ‰€æœ‰`.vue`å’Œ`.js`æ–‡ä»¶
  - ç¼–è¯‘è¿‡ç¨‹ï¼šç¡®ä¿æ„å»ºæ—¶æ— ä»£ç è´¨é‡é—®é¢˜
  - å¼€å‘ä½“éªŒï¼šæä¾›å®æ—¶é”™è¯¯æç¤ºå’Œè‡ªåŠ¨ä¿®å¤
  - å›¢é˜Ÿåä½œï¼šç»Ÿä¸€ä»£ç é£æ ¼å’Œæœ€ä½³å®è·µ

### å¼€å‘æœåŠ¡å¸¸é©»ä¸æ—¥å¿—
```bash
fuser -k 3000/tcp || true
cd /opt/qwcard
nohup npm run dev > /var/log/nuxt-dev.log 2>&1 &
tail -n 200 /var/log/nuxt-dev.log
```

### æµè§ˆå™¨ä¾§ç¼“å­˜æ¸…ç†ï¼ˆé‡åˆ°å¡åŠ è½½/æ—§èµ„æºï¼‰
- DevTools â†’ Application â†’ Service Workers â†’ Unregisterï¼ˆå¹¶å‹¾é€‰ Update on reloadï¼‰
- å¼ºåˆ¶åˆ·æ–°ï¼šCtrl/Cmd+Shift+Rï¼Œæˆ–ä½¿ç”¨æ— ç—•çª—å£

### å¿«é€Ÿè‡ªæ£€æ¸…å•ï¼ˆçº¿ä¸Šå¿«é€Ÿæ’éšœï¼‰
- èµ„æº 200 ä¸”è€—æ—¶æ­£å¸¸ï¼š
```bash
for f in runtime.js app.js vendors/app.js commons/app.js; do \
  curl -s -o /dev/null -w "$f -> %{http_code} %{time_total}\n" https://zjemail.cn/_nuxt/$f; \
done
```
- é¢„è§ˆé¡µå¯è¾¾ï¼š
```bash
curl -s -o /dev/null -w "PREV:%{http_code} %{time_total}\n" https://zjemail.cn/card-preview
```
- API è¿”å› JSONï¼ˆé HTMLï¼‰ï¼š
```bash
curl -s -i "https://zjemail.cn/api/card/profile?tenant_id=1&member_id=1&stub=1" | sed -n '1,12p'
```

### å¸¸è§æŠ¥é”™ â†’ å¤„ç½®
- `ERR_INCOMPLETE_CHUNKED_ENCODING`ï¼š
  - ä¿® `/var/lib/nginx` æƒé™ä¸º `www-data:www-data`ï¼›åœ¨ `/_nuxt/` ä¸ `/` ç¦ç”¨ `proxy_buffering/request_buffering` ä¸ `proxy_max_temp_file_size 0`ã€‚
- API 200 ä½†è¿”å› HTMLï¼š
  - `/api/` æœªå‘½ä¸­ 5001ï¼Œè¢« `location /` åƒæ‰ï¼›æŒ‰"æ¢é’ˆ+é¡ºåº"æ ¸å¯¹ç«™ç‚¹å‘½ä¸­ä¸é¡ºåºã€‚
- é¡µé¢ç™½åœˆä½†æ— ç½‘ç»œé”™è¯¯ï¼š
  - æŸ¥çœ‹é¢„è§ˆé¡µè°ƒè¯•è¦†ç›–å±‚ï¼›æˆ–çœ‹ `/var/log/nuxt-dev.log` ä¸æµè§ˆå™¨ Console/Network ç¬¬ä¸€æ¡çº¢é”™ã€‚
- `window is not defined` é”™è¯¯ï¼š
  - æ£€æŸ¥ç»„ä»¶ä¸­æ˜¯å¦æœ‰åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶è®¿é—®æµè§ˆå™¨APIçš„ä»£ç ï¼Œä½¿ç”¨`process.client`å’Œ`typeof window !== 'undefined'`æ£€æŸ¥
  - å¸¸è§ä½ç½®ï¼šLottieåŠ¨ç”»ç»„ä»¶ã€Toastæ’ä»¶ã€Google Tag Managerç­‰
- `No ESLint configuration found` é”™è¯¯ï¼š
  - åˆ›å»º`.eslintrc.js`é…ç½®æ–‡ä»¶ï¼Œé…ç½®é€‚åˆé¡¹ç›®çš„ESLintè§„åˆ™
  - å®‰è£…å¿…è¦çš„ESLintä¾èµ–ï¼š`eslint`ã€`@nuxtjs/eslint-config`ã€`eslint-plugin-vue`ã€`@babel/eslint-parser`
  - å¦‚é‡ç‰ˆæœ¬å†²çªï¼Œå¯ä¸´æ—¶ç¦ç”¨`@nuxtjs/eslint-module`æ¨¡å—
  - æ£€æŸ¥`nuxt.config.js`ä¸­çš„`buildModules`é…ç½®


<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuthè°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #40a9ff;
        }
        .log {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #1890ff;
            padding-left: 10px;
        }
        .error {
            border-left-color: #ff4d4f;
            color: #ff4d4f;
        }
        .success {
            border-left-color: #52c41a;
            color: #52c41a;
        }
    </style>
</head>
<body>
    <h1>ğŸ” OAuthæˆæƒè°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>1. ç¯å¢ƒæ£€æµ‹</h2>
        <button class="btn" onclick="checkEnvironment()">æ£€æµ‹ç¯å¢ƒ</button>
        <div id="env-result" class="log"></div>
    </div>
    
    <div class="section">
        <h2>2. æµ‹è¯•APIè°ƒç”¨</h2>
        <p>è¯·å…ˆåœ¨ä¼å¾®ä¸­æ‰“å¼€åç‰‡é¡µé¢è·å–tokenï¼Œç„¶åç²˜è´´åˆ°ä¸‹é¢ï¼š</p>
        <input type="text" id="token-input" placeholder="ç²˜è´´token" style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;">
        <br><br>
        <button class="btn" onclick="testCardAPI()">æµ‹è¯• /api/v1/wecom/card/my</button>
        <div id="api-result" class="log"></div>
    </div>
    
    <div class="section">
        <h2>3. æµ‹è¯•OAuthæˆæƒ</h2>
        <button class="btn" onclick="testOAuthFlow()">æµ‹è¯•OAuthæµç¨‹</button>
        <div id="oauth-result" class="log"></div>
    </div>
    
    <div class="section">
        <h2>4. æ•°æ®åº“çŠ¶æ€</h2>
        <button class="btn" onclick="checkDatabaseStatus()">æ£€æŸ¥æ•°æ®åº“</button>
        <div id="db-result" class="log"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            el.appendChild(logItem);
            el.scrollTop = el.scrollHeight;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        function checkEnvironment() {
            clearLog('env-result');
            log('env-result', 'å¼€å§‹ç¯å¢ƒæ£€æµ‹...', 'info');
            
            // æ£€æµ‹User Agent
            const ua = navigator.userAgent;
            log('env-result', `User Agent: ${ua}`, 'info');
            
            // æ£€æµ‹æ˜¯å¦åœ¨ä¼å¾®ç¯å¢ƒ
            const isWecom = /wxwork/i.test(ua);
            log('env-result', `æ˜¯å¦ä¼å¾®ç¯å¢ƒ: ${isWecom ? 'æ˜¯ âœ…' : 'å¦ âŒ'}`, isWecom ? 'success' : 'error');
            
            // æ£€æµ‹ä¼å¾®JSAPI
            const hasWxAPI = typeof window.wx !== 'undefined';
            log('env-result', `ä¼å¾®JSAPI: ${hasWxAPI ? 'å¯ç”¨ âœ…' : 'ä¸å¯ç”¨ âŒ'}`, hasWxAPI ? 'success' : 'error');
            
            // æ£€æµ‹å½“å‰URL
            log('env-result', `å½“å‰URL: ${window.location.href}`, 'info');
            
            // æ£€æµ‹localStorage
            try {
                localStorage.setItem('test', '1');
                localStorage.removeItem('test');
                log('env-result', 'localStorage: å¯ç”¨ âœ…', 'success');
                
                const token = localStorage.getItem('wecom_token');
                log('env-result', `TokençŠ¶æ€: ${token ? 'å·²å­˜åœ¨' : 'æœªå­˜åœ¨'}`, token ? 'success' : 'error');
            } catch (e) {
                log('env-result', `localStorage: ä¸å¯ç”¨ âŒ - ${e.message}`, 'error');
            }
        }
        
        async function testCardAPI() {
            clearLog('api-result');
            const token = document.getElementById('token-input').value.trim() || localStorage.getItem('wecom_token');
            
            if (!token) {
                log('api-result', 'âŒ è¯·å…ˆè¾“å…¥tokenæˆ–åœ¨ä¼å¾®ä¸­æ‰“å¼€åç‰‡é¡µé¢', 'error');
                return;
            }
            
            log('api-result', 'ğŸ“¡ è°ƒç”¨ /api/v1/wecom/card/my...', 'info');
            
            try {
                const response = await fetch('/api/v1/wecom/card/my', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('api-result', `HTTPçŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log('api-result', `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.need_oauth) {
                    log('api-result', 'ğŸ” éœ€è¦OAuthæˆæƒï¼', 'success');
                    log('api-result', `æˆæƒURL: ${data.oauth_url}`, 'info');
                    
                    if (confirm('æ£€æµ‹åˆ°éœ€è¦OAuthæˆæƒï¼Œæ˜¯å¦ç«‹å³è·³è½¬ï¼Ÿ')) {
                        window.location.href = data.oauth_url;
                    }
                } else if (data.success) {
                    log('api-result', 'âœ… è·å–åç‰‡æˆåŠŸï¼', 'success');
                } else if (data.error) {
                    log('api-result', `âŒ é”™è¯¯: ${data.error}`, 'error');
                }
            } catch (error) {
                log('api-result', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testOAuthFlow() {
            clearLog('oauth-result');
            log('oauth-result', 'æµ‹è¯•OAuthæˆæƒæµç¨‹...', 'info');
            
            // æ£€æµ‹URLä¸­æ˜¯å¦æœ‰OAuthå›è°ƒå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const oauthSuccess = urlParams.get('oauth_success');
            const tokenFromUrl = urlParams.get('token');
            
            if (code) {
                log('oauth-result', `âœ… æ£€æµ‹åˆ°OAuth code: ${code}`, 'success');
                log('oauth-result', `State: ${state}`, 'info');
            }
            
            if (oauthSuccess && tokenFromUrl) {
                log('oauth-result', `âœ… OAuthæˆæƒæˆåŠŸï¼Token: ${tokenFromUrl.substring(0, 20)}...`, 'success');
                localStorage.setItem('wecom_token', tokenFromUrl);
                document.getElementById('token-input').value = tokenFromUrl;
            }
            
            if (!code && !oauthSuccess) {
                log('oauth-result', 'â„¹ï¸ å½“å‰URLæ²¡æœ‰OAuthå›è°ƒå‚æ•°', 'info');
                log('oauth-result', 'è¯·å…ˆè°ƒç”¨"æµ‹è¯•API"è·å–æˆæƒURL', 'info');
            }
        }
        
        async function checkDatabaseStatus() {
            clearLog('db-result');
            log('db-result', 'âš ï¸ æ­¤åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ', 'info');
            log('db-result', 'è¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æ•°æ®åº“membersè¡¨', 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
        window.onload = function() {
            checkEnvironment();
            testOAuthFlow();
        };
    </script>
</body>
</html>

